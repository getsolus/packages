name       : cups
version    : 2.2.8
release    : 23
source     :
    - https://github.com/apple/cups/releases/download/v2.2.8/cups-2.2.8-source.tar.gz : 3968fc1d26fc48727508db1c1380e36c6694ab90177fd6920aec5f6cc73af9e4
homepage   : https://www.cups.org/
license    : Apache-2.0
component  : desktop.core
summary    : The Common Unix Printing System
description: |
    The Common Unix Printing System (CUPS) is a print spooler and associated utilities. It is based on the "Internet Printing Protocol" and provides printing services to most PostScript and raster printers.
emul32     : yes
builddeps  :
    - pkgconfig(avahi-glib)
    - pkgconfig32(dbus-1)
    - pkgconfig32(gnutls)
    - pkgconfig32(libattr)
    - pkgconfig32(liblzma)
    - pkgconfig32(libudev)
    - pkgconfig32(libusb-1.0)
    - acl-32bit-devel
    - libgcrypt-32bit
    - libpaper-32bit-devel
    - pam-32bit-devel
rundeps    :
    - devel : libgnutls-devel
    - 32bit-devel : libgnutls-32bit-devel
patterns   :
    - devel :
        - /usr/bin/cups-config
        - /usr/share/man/man1/cups-config.*
setup      : |
    %patch -p0 < $pkgfiles/cups-fix-install-perms.patch
    %patch -p1 < $pkgfiles/cups-systemd-socket.patch
    %patch -p1 < $pkgfiles/security/CVE-2018-4700.patch

    # https://github.com/apple/cups/issues/5330 and https://github.com/apple/cups/issues/5322
    %patch -p1 < $pkgfiles/cups-ippvalidateattr-regression.patch
    # https://github.com/apple/cups/issues/5338
    %patch -p1 < $pkgfiles/cups-ippeve-webui.patch

    # Remove ".SILENT" rule for verbose output (bug #524338)
    sed -i 's#^.SILENT:##g' Makedefs.in

    ex_opts=""
    if [[ ! -z "${EMUL32BUILD}" ]]; then
        ex_opts="-disable-avahi --disable-dnssd --disable-systemd"
    fi

    %configure $ex_opts --prefix=/usr \
               --enable-libpaper \
               --enable-relro \
               --enable-webif \
               --disable-gssapi \
               --with-cups-user=lp \
               --with-cups-group=lp \
               --with-system-groups=lpadmin \
               --with-rundir=/run/cups \
               --without-rcdir
build      : |
    %make
install    : |
    %make_install BUILDROOT=$installdir

    if [[ -z "${EMUL32BUILD}" ]]; then
        install -D -m00644 $pkgfiles/cups.sysusers $installdir/%libdir%/sysusers.d/cups.conf
        install -D -m00644 $pkgfiles/cups.tmpfiles $installdir/%libdir%/tmpfiles.d/cups.conf

        # should be pre-enabled
        install -D -d -m00755 $installdir/usr/lib/systemd/system/printer.target.wants
        install -D -d -m00755 $installdir/usr/lib/systemd/system/sockets.target.wants
        install -D -d -m00755 $installdir/usr/lib/systemd/system/multi-user.target.wants
        ln -s ../org.cups.cupsd.service $installdir/usr/lib/systemd/system/printer.target.wants/.
        ln -s ../org.cups.cupsd.socket $installdir/usr/lib/systemd/system/sockets.target.wants/.
        ln -s ../org.cups.cupsd.path $installdir/usr/lib/systemd/system/multi-user.target.wants/.
    fi

    rm -rf $installdir/{run,var}

    install -Dm00644 $pkgfiles/cups.pam $installdir/usr/share/defaults/etc/pam.d/cups
    ln -sf /usr/share/defaults/etc/pam.d/cups $installdir/usr/share/defaults/etc/pam.d/cups.N
check      : |
    #make check
