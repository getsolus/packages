From 0ecb3256c69b7ae254099974d3bdc87901c9a325 Mon Sep 17 00:00:00 2001
From: Gavin Zhao <git@gzgz.dev>
Date: Sat, 27 Dec 2025 11:37:31 -0500
Subject: [PATCH 4/4] correct XDL/WMMA kernel arch restrictions

---
 library/src/tensor_operation_instance/gpu/CMakeLists.txt | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/library/src/tensor_operation_instance/gpu/CMakeLists.txt b/library/src/tensor_operation_instance/gpu/CMakeLists.txt
index 1b31b189c..5117b4050 100644
--- a/library/src/tensor_operation_instance/gpu/CMakeLists.txt
+++ b/library/src/tensor_operation_instance/gpu/CMakeLists.txt
@@ -84,13 +84,13 @@ function(add_instance_library INSTANCE_NAME)
     # Do not build XDL gemm_universal_f8 or gemm_multiply_multiply_f8 for any targets except gfx94
     if(NOT CK_USE_FP8_ON_UNSUPPORTED_ARCH)
         foreach(source IN LISTS ARGN)
-            if(NOT INST_TARGETS MATCHES "gfx94" AND NOT INST_TARGETS MATCHES "gfx95" AND source MATCHES "gemm_multiply_multiply" AND source MATCHES "_f8_")
+            if(NOT INST_TARGETS MATCHES "gfx9" AND source MATCHES "gemm_multiply_multiply" AND source MATCHES "_f8_")
                 message(DEBUG "removing gemm_multiply_multiply_f8 instance ${source} ")
                 list(REMOVE_ITEM ARGN "${source}")
             endif()
         endforeach()
         foreach(source IN LISTS ARGN)
-            if(NOT INST_TARGETS MATCHES "gfx94" AND NOT INST_TARGETS MATCHES "gfx95" AND source MATCHES "gemm_xdl_universal" AND source MATCHES "_f8_")
+            if(NOT INST_TARGETS MATCHES "gfx9" AND source MATCHES "gemm_xdl_universal" AND source MATCHES "_f8_")
                 message(DEBUG "removing gemm_universal_f8 instance ${source} ")
                 list(REMOVE_ITEM ARGN "${source}")
             endif()
@@ -145,7 +145,10 @@ function(add_instance_library INSTANCE_NAME)
             foreach(target IN LISTS INST_TARGETS)
                     string(APPEND offload_targets "--offload-arch=${target} ")
             endforeach()
-            set_source_files_properties(${source} PROPERTIES COMPILE_FLAGS ${offload_targets})
+            # Instance registration functions still need to get compiled even without offload targets
+            if(offload_targets)
+                set_source_files_properties(${source} PROPERTIES COMPILE_FLAGS ${offload_targets})
+            endif()
             list(APPEND INST_OBJ ${source})
         endforeach()
         add_library(${INSTANCE_NAME} OBJECT ${INST_OBJ})
-- 
2.52.0

