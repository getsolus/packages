# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name       : composable-kernel
version    : 7.0.2
release    : 4
source     :
    # TODO(gzgz): switch to commit
    - git|https://github.com/ROCm/composable_kernel.git : rocm-7.0.2
homepage   : https://github.com/ROCm/composable_kernel
license    : MIT
component  : programming.library
summary    : Performance Portable Programming Model for Machine Learning Tensor Operators
description: |
    The Composable Kernel (CK) library provides a programming model for writing performance-critical kernels for machine learning workloads across multiple architectures (GPUs, CPUs, etc.). The CK library uses general purpose kernel languages, such as HIP C++.
builddeps  :
    - pkgconfig(python3)
    - rocm-cmake
    - rocm-hip
debug      : false
environment: |
    export CXXFLAGS="${CXXFLAGS/-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=32/-fcf-protection=none}"
    export CXXFLAGS="${CXXFLAGS/-g2/}"
    # Too noisy
    export CXXFLAGS+=" -w"
    export CLANG_IGNORE_WERROR=1

    export ROCM_PATH=/usr
    export HIP_CLANG_PATH=/usr/lib64/llvm-rocm/bin
    export HIP_DEVICE_LIB_PATH=/usr/lib64/amdgcn/bitcode
    # Check include/ck/ck.hpp for supported architectures
    export AMDGPU_TARGETS="%AMDGPUTARGETS%;gfx10-1-generic;gfx10-3-generic;gfx11-generic"

    if [ -e /usr/bin/sccache ]; then
        export HIP_CLANG_LAUNCHER=/usr/bin/sccache
        export CMAKE_CXX_COMPILER_LAUNCHER=$HIP_CLANG_LAUNCHER
        export CMAKE_HIP_COMPILER_LAUNCHER=$HIP_CLANG_LAUNCHER
    fi
    export SCCACHE_IDLE_TIMEOUT=0

    # Compress GPU code so we don't get linking errors due to large file size
    export OFFLOAD_BUNDLER_COMPRESS=1
setup      : |
    %patch -p1 -i $pkgfiles/0001-Add-ck_-prefix-to-library-names-to-prevent-conflicts.patch
    %patch -p1 -i $pkgfiles/0002-Add-support-for-RDNA1-GPUs-3220.patch
    %patch -p1 -i $pkgfiles/0003-Include-RDNA1-in-GPU-remove-list-as-well.patch
    %patch -p1 -i $pkgfiles/0004-correct-XDL-WMMA-kernel-arch-restrictions.patch

    %cmake_ninja -L \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_COMPILER=$HIP_CLANG_PATH/clang++ \
      -DCMAKE_HIP_COMPILER=$HIP_CLANG_PATH/clang \
      -DROCM_SYMLINK_LIBS=OFF \
      -DCMAKE_INSTALL_LIBDIR=lib%LIBSUFFIX% \
      -DINSTANCES_ONLY=ON \
      -DBUILD_SHARED_LIBS=ON \
      -DBUILD_DEV=OFF \
      -DENABLE_CLANG_CPP_CHECKS=OFF \
      -DGPU_ARCHS="$AMDGPU_TARGETS" \
build      : |
    %ninja_build
install    : |
    %ninja_install
