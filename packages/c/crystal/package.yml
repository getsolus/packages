name       : crystal
version    : 1.17.1
release    : 20
source     :
    - https://github.com/crystal-lang/crystal/archive/refs/tags/1.17.1.tar.gz : f673c09577a7749d06aa56639dcf5f79bdd61ee195ab1c9b445e6f3880bd2910
    - https://github.com/crystal-lang/crystal/releases/download/1.17.1/crystal-1.17.1-1-linux-x86_64-bundled.tar.gz: cb24d17927a8dc712aaa2ed1c78cedf4ebf96afc5a1de72b569896e8d8cbc991
homepage   : https://crystal-lang.org
license    : Apache-2.0
component  : programming
summary    : The Crystal programming language
description: |
    Crystal is a programming language with similar syntax to Ruby, static type-checking, the ability to call C code, compile-time evaluation and generation of code, and the ability to compile to native code.
networking : true  # for tests
clang      : true
builddeps  :
    - pkgconfig(bdw-gc)
    - pkgconfig(libevent)
    - pkgconfig(libxml-2.0)
    - pkgconfig(yaml-0.1)
    # crystal
    - llvm-devel
rundeps    :
    - bdwgc-devel
    - libevent-devel
checkdeps  :
    - git
environment: |
    CRYSTAL_OPTS="CRYSTAL_WORKERS=%YJOBS% CRYSTAL_CONFIG_TARGET=x86_64-linux-gnu FLAGS=-Dpreview_mt release=1 interpreter=1"
setup      : |
     # When not bootstrapping comment this out don't delete it. We want to keep the knowledge to delete the static libs
     mkdir crystal-prebuilt
     tar --strip-components=2 -xf $sources/crystal-*-linux-x86_64-bundled.tar.gz -C crystal-prebuilt
     # Prevent it from using the included static libs for bootstrapping
     rm -rv crystal-prebuilt/lib/crystal/*.a
build      : |
    %make \
      CRYSTAL=$workdir/crystal-prebuilt/bin/crystal \
      CRYSTAL_PATH="lib:$workdir/src" \
      CRYSTAL_CONFIG_VERSION="$version" \
      CRYSTAL_CONFIG_PATH="lib:%libdir%/crystal/src" \
      $CRYSTAL_OPTS
install    : |
    %make_install \
      LIBDIR=$(PREFIX)/lib64 \
      PREFIX=/usr \
      $CRYSTAL_OPTS

    #rm -rv $installdir/usr/share/licenses
# Currently a bunch of tests fail with -Dpreview_mt which isn't fixed even in master. Since multithreading is more useful to users disable checks for now
# check      : |
#     rm spec/std/socket/udp_socket_spec.cr # ipv6 UDP sockets don't work in v1.14.0
#     %make std_spec \
#       $CRYSTAL_OPTS

#     %make compiler_spec \
#       $CRYSTAL_OPTS
