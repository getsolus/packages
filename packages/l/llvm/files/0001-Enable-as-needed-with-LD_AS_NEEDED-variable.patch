From 3ed72fb652c0b824427f4b9b429858ace3b70a1e Mon Sep 17 00:00:00 2001
From: Peter O'Connor <peter@solus-project.com>
Date: Tue, 20 Jan 2026 16:29:55 +0000
Subject: [PATCH 1/1] Enable --as-needed with LD_AS_NEEDED variable

This brings it inline with the binutils linkers

Signed-off-by: Peter O'Connor <peter@solus-project.com>
---
 lld/ELF/Driver.cpp | 3 +++
 lld/docs/ld.lld.1  | 5 +++++
 2 files changed, 8 insertions(+)

diff --git a/lld/ELF/Driver.cpp b/lld/ELF/Driver.cpp
index a1e9ecae0855..bfb6397cabfb 100644
--- a/lld/ELF/Driver.cpp
+++ b/lld/ELF/Driver.cpp
@@ -1936,6 +1936,9 @@ void LinkerDriver::createFiles(opt::InputArgList &args) {
   // For --{push,pop}-state.
   std::vector<std::tuple<bool, bool, bool>> stack;
 
+  if (getenv ("LD_AS_NEEDED") != NULL)
+    ctx.arg.asNeeded = true;
+
   // -r implies -Bstatic and has precedence over -Bdynamic.
   ctx.arg.isStatic = ctx.arg.relocatable;
 
diff --git a/lld/docs/ld.lld.1 b/lld/docs/ld.lld.1
index b5c1816ce6e5..7f328474ac01 100644
--- a/lld/docs/ld.lld.1
+++ b/lld/docs/ld.lld.1
@@ -64,6 +64,11 @@ Apply link-time values for dynamic relocations.
 Only set
 .Dv DT_NEEDED
 for shared libraries if used.
+If the environment variable
+.Cm LD_AS_NEEDED
+is set, the linker will behave as if the
+.Cm --as-needed
+option is passed to the linker.
 .It Fl -auxiliary Ns = Ns Ar value
 Set the
 .Dv DT_AUXILIARY
-- 
2.52.0

