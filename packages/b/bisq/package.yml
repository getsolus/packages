# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name       : bisq
version    : 1.9.22
release    : 8
source     :
    - https://github.com/bisq-network/bisq/archive/refs/tags/v1.9.22.tar.gz : 0a7dbf8e01f7ce293a6b9d580f507c03b093bf7c062e8bd3a1b93334bf76b002
homepage   : https://bisq.network/
license    : AGPL-3.0-or-later
component  : network.web
summary    : Decentralized Bitcoin exchange
description: |
    Bisq is an open-source desktop application that allows you to buy and sell Bitcoins in exchange for national currencies, or alternative cryptocurrencies.
networking : true
builddeps  :
    - openjdk-11
rundeps    :
    - openjdk-11
environment: |
    JAVA_HOME=/usr/lib64/openjdk-11
    PATH=$JAVA_HOME/bin:$PATH
setup      : |
    sed -i '/vendor = JvmVendorSpec.AZUL/d' build-logic/commons/src/main/groovy/bisq.java-conventions.gradle
    sed -i '/implementation = JvmImplementation.VENDOR_SPECIFIC/d' build-logic/commons/src/main/groovy/bisq.java-conventions.gradle
build      : |
    export GRADLE_USER_HOME=$workdir/.gradle

    # tests will always fail, so disable them with -x test
    ./gradlew --no-daemon build -x test
install    : |
    # Install all build folder
    install -dm00755 $installdir/usr/share/bisq/{desktop,cli,daemon,apitest,seednode,statsnode}/
    cp -R desktop/build/app/* $installdir/usr/share/bisq/desktop/
    cp -R cli/build/app/* $installdir/usr/share/bisq/cli/
    cp -R daemon/build/app/* $installdir/usr/share/bisq/daemon/
    cp -R apitest/build/app/* $installdir/usr/share/bisq/apitest/
    cp -R seednode/build/app/* $installdir/usr/share/bisq/seednode/
    cp -R statsnode/build/app/* $installdir/usr/share/bisq/statsnode/

    # Install wrapper scripts to /usr/bin/
    install -dm00755 $installdir/usr/bin/

    # Create wrapper scripts that call the actual binaries directly
    for app in desktop cli daemon apitest seednode statsnode; do
        cp $pkgfiles/java-shim.sh $installdir/usr/bin/bisq-$app
        echo "/usr/share/bisq/$app/bin/bisq-$app \"\$@\"" >> $installdir/usr/bin/bisq-$app
        chmod +x $installdir/usr/bin/bisq-$app
    done

    # Install icon, desktop file and appdata
    install -Dm00644 desktop/package/linux/icon.png $installdir/usr/share/pixmaps/network.bisq.Bisq.png
    install -Dm00644 Bisq1_icon.svg $installdir/usr/share/icons/hicolor/scalable/apps/network.bisq.Bisq.svg
    install -Dm00644 $pkgfiles/network.bisq.Bisq.desktop -t $installdir/usr/share/applications
    install -Dm00644 $pkgfiles/network.bisq.Bisq.appdata.xml -t $installdir/usr/share/metainfo

    %install_license LICENSE
