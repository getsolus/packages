From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Thomas Staudinger <Staudi.Kaos@gmail.com>
Date: Fri, 23 May 2025 14:20:42 +0200
Subject: [PATCH] nvidia: Add support for open kernel modules

Signed-off-by: Thomas Staudinger <Staudi.Kaos@gmail.com>
---
 crapshoot                 |  2 ++
 doflicky/bundleset.py     |  2 ++
 doflicky/detection.py     |  2 +-
 doflicky/driver/nvidia.py | 26 ++++++++++++++++++++++++--
 4 files changed, 29 insertions(+), 3 deletions(-)

diff --git a/crapshoot b/crapshoot
index 6ceacd5..e07a40d 100755
--- a/crapshoot
+++ b/crapshoot
@@ -12,6 +12,7 @@
 
 from doflicky import OSContext
 from doflicky.driver.nvidia import DriverBundleNvidia
+from doflicky.driver.nvidia import DriverBundleNvidiaOpen
 from doflicky.driver.broadcom import DriverBundleBroadcom
 import pisi
 from pisi.db.installdb import InstallDB
@@ -29,6 +30,7 @@ class BundleSet:
         """ Initialise the potential driver bundle set """
         self.drivers = [
             DriverBundleNvidia(),
+            DriverBundleNvidiaOpen(),
             DriverBundleBroadcom(),
         ]
         self.allDrivers = list()
diff --git a/doflicky/bundleset.py b/doflicky/bundleset.py
index e5ba39f..50c8261 100644
--- a/doflicky/bundleset.py
+++ b/doflicky/bundleset.py
@@ -12,6 +12,7 @@
 
 from doflicky import OSContext
 from doflicky.driver.nvidia import DriverBundleNvidia
+from doflicky.driver.nvidia import DriverBundleNvidiaOpen
 from doflicky.driver.broadcom import DriverBundleBroadcom
 from pisi.db.installdb import InstallDB
 
@@ -29,6 +30,7 @@ class BundleSet:
         """ Initialise the potential driver bundle set """
         self.drivers = [
             DriverBundleNvidia(),
+            DriverBundleNvidiaOpen(),
             DriverBundleBroadcom(),
         ]
         self.allDrivers = list()
diff --git a/doflicky/detection.py b/doflicky/detection.py
index 543b27f..12be53c 100644
--- a/doflicky/detection.py
+++ b/doflicky/detection.py
@@ -66,7 +66,7 @@ class DriverBundlePCI(DriverBundle):
         return False
 
 
-nvidia_driver_priority = ['nvidia-glx-driver']
+nvidia_driver_priority = ['nvidia-open', 'nvidia-glx-driver']
 
 
 def detect_hardware_packages():
diff --git a/doflicky/driver/nvidia.py b/doflicky/driver/nvidia.py
index f5793e6..c061d6d 100644
--- a/doflicky/driver/nvidia.py
+++ b/doflicky/driver/nvidia.py
@@ -33,9 +33,31 @@ class DriverBundleNvidiaBase(DriverBundlePCI):
         """ For GPU drivers we'll suggest 32-bit when we find related pkgs """
         return ["wine-32bit", "steam", "mesalib-32bit"]
 
+class DriverBundleNvidiaOpen(DriverBundleNvidiaBase):
+    """ Main NVIDIA driver, open kernel modules (nvidia-open) """
+
+    def __init__(self):
+        DriverBundleNvidiaBase.__init__(self, "nvidia-open.modaliases")
+
+    def get_name(self):
+        return "NVIDIA Graphics Driver (main series, open kernel modules)"
+
+    def get_priority(self):
+        return 3
+
+    def get_packages(self, context, emul32=False):
+        basePackages = ["nvidia-glx-driver-common"]
+        if emul32:
+            basePackages.append("nvidia-glx-driver-32bit")
+        if context.get_active_kernel_series() == "current":
+            basePackages.append("nvidia-open-current")
+        else:
+            basePackages.append("nvidia-open")
+        return basePackages
+
 
 class DriverBundleNvidia(DriverBundleNvidiaBase):
-    """ Main NVIDIA driver (nvidia-glx-driver) """
+    """ Main NVIDIA driver, proprietary kernel modules (nvidia-glx-driver) """
 
     def __init__(self):
         DriverBundleNvidiaBase.__init__(self, "nvidia-glx-driver.modaliases")
@@ -44,7 +66,7 @@ class DriverBundleNvidia(DriverBundleNvidiaBase):
         return "NVIDIA Graphics Driver (main series)"
 
     def get_priority(self):
-        return 3
+        return 2
 
     def get_packages(self, context, emul32=False):
         basePackages = ["nvidia-glx-driver-common"]
