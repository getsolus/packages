# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name: mozjs
version: 140.4.0
release: 38
source:
    - https://archive.mozilla.org/pub/firefox/releases/140.4.0esr/source/firefox-140.4.0esr.source.tar.xz: 49f20673171046bc7b64f4caa340c46e1e105b9107f0ef68b7a94f379bcea4f7
homepage: https://www.mozilla.org/
license:
    - GPL-2.0-or-later
    - MPL-1.1
component: desktop.library
summary: JS is Mozilla's JavaScript engine written in C/C++
description: |
    JS is Mozilla's JavaScript engine written in C/C++
strip: false
libsplit: false
networking: true
builddeps:
    - pkgconfig(icu-uc)
    - autoconf213
    - cbindgen
    - llvm-clang
    - rust
environment: |
    export AR=llvm-ar
    export NM=llvm-nm
    export RANLIB=llvm-ranlib
setup: |
    %apply_patches
    head -n -1 config/milestone.txt > config/milestone.txt
    echo "${version}" >> config/milestone.txt

    %patch -p1 -i $pkgfiles/0001-Bug-1973994-mozjs-140.pc-does-not-contain-DXP_UNIX-o.patch

    mkdir $workdir/building
    cd $workdir/building

    ../js/src/%configure \
        --disable-debug \
        --disable-debug-symbols \
        --disable-jemalloc \
        --disable-strip \
        --disable-tests \
        --enable-optimize \
        --enable-posix-nspr-emulation \
        --enable-readline \
        --enable-release \
        --enable-shared-js \
        --enable-unaligned-private-values \
        --with-system-zlib \
        --with-system-icu
build: |
    cd $workdir/building
    %make
install: |
    cd $workdir/building
    %make_install
    rm -r $installdir/%libdir%/*.ajs
patterns:
    - devel:
          - /usr/bin/js*-config
