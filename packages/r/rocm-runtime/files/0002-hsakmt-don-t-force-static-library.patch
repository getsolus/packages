From def319e609df295afa6e2bb793e6b27aa3e29a6d Mon Sep 17 00:00:00 2001
From: Gavin Zhao <git@gzgz.dev>
Date: Sat, 17 Jan 2026 19:35:58 -0500
Subject: [PATCH 2/2] hsakmt: don't force static library

---
 libhsakmt/CMakeLists.txt                          | 8 +++-----
 libhsakmt/src/libhsakmt.ver                       | 3 +++
 runtime/hsa-runtime/CMakeLists.txt                | 2 +-
 runtime/hsa-runtime/hsa-runtime64-config.cmake.in | 4 +++-
 4 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/libhsakmt/CMakeLists.txt b/libhsakmt/CMakeLists.txt
index 8b0ad114..4ccf80c6 100644
--- a/libhsakmt/CMakeLists.txt
+++ b/libhsakmt/CMakeLists.txt
@@ -75,7 +75,7 @@ endif ()
 set ( BUILD_VERSION_STRING "${BUILD_VERSION_MAJOR}.${BUILD_VERSION_MINOR}.${BUILD_VERSION_PATCH}" )
 
 ## Compiler flags
-set (HSAKMT_C_FLAGS -fPIC -W -Wall -Wextra -Wno-unused-parameter -Wformat-security -Wswitch-default -Wundef -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations -Wredundant-decls -Wunreachable-code -std=gnu99 -fvisibility=hidden)
+set (HSAKMT_C_FLAGS -fPIC -W -Wall -Wextra -Wno-unused-parameter -Wformat-security -Wswitch-default -Wundef -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations -Wredundant-decls -Wunreachable-code -std=gnu99)
 if ( CMAKE_COMPILER_IS_GNUCC )
     set ( HSAKMT_C_FLAGS "${HSAKMT_C_FLAGS}" -Wlogical-op)
 endif ()
@@ -88,11 +88,9 @@ else ()
     set ( HSAKMT_C_FLAGS "${HSAKMT_C_FLAGS}" -g )
 endif ()
 
-set ( HSAKMT_LINKER_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/src/libhsakmt.ver" )
-
 ## Linker Flags
 ## Add --enable-new-dtags to generate DT_RUNPATH
-set (HSAKMT_LINK_FLAGS "${HSAKMT_LINK_FLAGS} -Wl,--enable-new-dtags -Wl,--version-script=${HSAKMT_LINKER_SCRIPT} -Wl,-soname=${HSAKMT_COMPONENT}.so.${LIB_VERSION_MAJOR} -Wl,-z,nodelete")
+set (HSAKMT_LINK_FLAGS "${HSAKMT_LINK_FLAGS} -Wl,--enable-new-dtags -Wl,-soname=${HSAKMT_COMPONENT}.so.${LIB_VERSION_MAJOR} -Wl,-z,nodelete")
 
 ## Address Sanitize Flag
 if ( ${ADDRESS_SANITIZER} )
@@ -132,7 +130,7 @@ set ( HSAKMT_SRC "src/debug.c"
                  "src/pc_sampling.c")
 
 ## Declare the library target name
-add_library (${HSAKMT_TARGET} STATIC "")
+add_library (${HSAKMT_TARGET} "")
 
 ## Add sources
 target_sources ( ${HSAKMT_TARGET} PRIVATE ${HSAKMT_SRC} )
diff --git a/libhsakmt/src/libhsakmt.ver b/libhsakmt/src/libhsakmt.ver
index fa2a427a..141fed67 100644
--- a/libhsakmt/src/libhsakmt.ver
+++ b/libhsakmt/src/libhsakmt.ver
@@ -18,6 +18,7 @@ hsaKmtQueryEventState;
 hsaKmtWaitOnEvent;
 hsaKmtWaitOnMultipleEvents;
 hsaKmtCreateQueue;
+hsaKmtCreateQueueExt;
 hsaKmtUpdateQueue;
 hsaKmtDestroyQueue;
 hsaKmtSetQueueCUMask;
@@ -30,6 +31,7 @@ hsaKmtRegisterMemory;
 hsaKmtRegisterMemoryToNodes;
 hsaKmtRegisterMemoryWithFlags;
 hsaKmtRegisterGraphicsHandleToNodes;
+hsaKmtRegisterGraphicsHandleToNodesExt;
 hsaKmtShareMemory;
 hsaKmtRegisterSharedHandle;
 hsaKmtRegisterSharedHandleToNodes;
@@ -89,6 +91,7 @@ hsaKmtPcSamplingDestroy;
 hsaKmtPcSamplingStart;
 hsaKmtPcSamplingStop;
 hsaKmtPcSamplingSupport;
+hsaKmtModelEnabled;
 local: *;
 };
 
diff --git a/runtime/hsa-runtime/CMakeLists.txt b/runtime/hsa-runtime/CMakeLists.txt
index d40b8936..8c1d0e97 100644
--- a/runtime/hsa-runtime/CMakeLists.txt
+++ b/runtime/hsa-runtime/CMakeLists.txt
@@ -301,7 +301,7 @@ target_link_libraries ( ${CORE_RUNTIME_TARGET} PRIVATE elf::elf dl pthread rt )
 # Link to hsakmt target for shared library builds
 # Link to hsakmt-staticdrm target for static library builds
 if( BUILD_SHARED_LIBS )
-  target_link_libraries ( ${CORE_RUNTIME_TARGET} PRIVATE hsakmt::hsakmt PkgConfig::drm)
+  target_link_libraries ( ${CORE_RUNTIME_TARGET} PUBLIC hsakmt::hsakmt PRIVATE PkgConfig::drm)
   find_package(rocprofiler-register)
   if(rocprofiler-register_FOUND)
     target_compile_definitions(${CORE_RUNTIME_TARGET} PRIVATE HSA_ROCPROFILER_REGISTER=1
diff --git a/runtime/hsa-runtime/hsa-runtime64-config.cmake.in b/runtime/hsa-runtime/hsa-runtime64-config.cmake.in
index 58351314..2f569715 100644
--- a/runtime/hsa-runtime/hsa-runtime64-config.cmake.in
+++ b/runtime/hsa-runtime/hsa-runtime64-config.cmake.in
@@ -44,13 +44,15 @@
 
 include( CMakeFindDependencyMacro )
 
+# hsakmt is always required as it's a public dependency
+find_dependency(hsakmt 1.0)
+
 # Client apps only need our private dependencies if rocr is a static lib.
 set( _is_hsa_runtime_dynamic @BUILD_SHARED_LIBS@ )
 if( NOT _is_hsa_runtime_dynamic )
 
   set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_CURRENT_LIST_DIR}")
 
-  find_dependency(hsakmt 1.0)
   find_dependency(LibElf)
 
 endif()
-- 
2.52.0

