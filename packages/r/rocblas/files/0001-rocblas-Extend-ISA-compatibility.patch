From 2850f22f80f90c9e498f520608a82989a4932ec3 Mon Sep 17 00:00:00 2001
From: Gavin Zhao <git@gzgz.dev>
Date: Sat, 13 Dec 2025 23:41:17 -0500
Subject: [PATCH] [rocblas] Extend ISA compatibility

---
 projects/rocblas/library/src/handle.cpp       | 31 ++++++++++++-----
 .../rocblas/library/src/rocblas_auxiliary.cpp | 31 ++++++++++++++---
 projects/rocblas/library/src/tensile_host.cpp | 34 ++++++++++++++-----
 3 files changed, 74 insertions(+), 22 deletions(-)

diff --git a/projects/rocblas/library/src/handle.cpp b/projects/rocblas/library/src/handle.cpp
index dcf0469c3d..5c37b84eec 100644
--- a/projects/rocblas/library/src/handle.cpp
+++ b/projects/rocblas/library/src/handle.cpp
@@ -366,14 +366,6 @@ Processor _rocblas_handle::getActiveArch()
     {
         return Processor::gfx1010;
     }
-    else if(deviceString.find("gfx1011") != std::string::npos)
-    {
-        return Processor::gfx1011;
-    }
-    else if(deviceString.find("gfx1012") != std::string::npos)
-    {
-        return Processor::gfx1012;
-    }
     else if(deviceString.find("gfx1030") != std::string::npos)
     {
         return Processor::gfx1030;
@@ -406,6 +398,29 @@ Processor _rocblas_handle::getActiveArch()
     {
         return Processor::gfx1201;
     }
+
+    size_t pos = std::string::npos;
+    if((pos = deviceString.find("gfx103")) != std::string::npos)
+    {
+        return Processor::gfx1030;
+    }
+    else if((pos = deviceString.find("gfx101")) != std::string::npos)
+    {
+        return Processor::gfx1010;
+    }
+    else if((pos = deviceString.find("gfx90")) != std::string::npos)
+    {
+        constexpr int cmpIdx = std::char_traits<char>::length("gfx90");
+        if(pos + cmpIdx < deviceString.size())
+        {
+            if(deviceString.at(pos + cmpIdx) == '2' || deviceString.at(pos + cmpIdx) == '9'
+               || deviceString.at(pos + cmpIdx) == 'c')
+            {
+                return Processor::gfx900;
+            }
+        }
+    }
+
     return static_cast<Processor>(0);
 }
 
diff --git a/projects/rocblas/library/src/rocblas_auxiliary.cpp b/projects/rocblas/library/src/rocblas_auxiliary.cpp
index 58720f9646..35487aab6b 100644
--- a/projects/rocblas/library/src/rocblas_auxiliary.cpp
+++ b/projects/rocblas/library/src/rocblas_auxiliary.cpp
@@ -909,11 +909,7 @@ bool rocblas_internal_tensile_supports_ldc_ne_ldd(rocblas_handle handle)
 
 bool rocblas_internal_tensile_supports_xdl_math_op(rocblas_math_mode mode)
 {
-    int deviceId;
-    hipGetDevice(&deviceId);
-    hipDeviceProp_t deviceProperties;
-    hipGetDeviceProperties(&deviceProperties, deviceId);
-    std::string deviceString(deviceProperties.gcnArchName);
+    std::string deviceString = rocblas_internal_get_arch_name();
     return (deviceString.find("gfx942") != std::string::npos);
 }
 
@@ -924,6 +920,31 @@ std::string rocblas_internal_get_arch_name()
     hipGetDevice(&deviceId);
     hipDeviceProp_t deviceProperties;
     hipGetDeviceProperties(&deviceProperties, deviceId);
+
+    // coerce arch name
+    std::string archName(deviceProperties.gcnArchName);
+    size_t      pos = std::string::npos;
+    if((pos = archName.find("gfx103")) != std::string::npos)
+    {
+        std::strcpy(deviceProperties.gcnArchName, "gfx1030");
+    }
+    else if((pos = archName.find("gfx101")) != std::string::npos)
+    {
+        std::strcpy(deviceProperties.gcnArchName, "gfx1010");
+    }
+    else if((pos = archName.find("gfx90")) != std::string::npos)
+    {
+        constexpr int cmpIdx = std::char_traits<char>::length("gfx90");
+        if(pos + cmpIdx < archName.size())
+        {
+            if(archName.at(pos + cmpIdx) == '2' || archName.at(pos + cmpIdx) == '9'
+               || archName.at(pos + cmpIdx) == 'c')
+            {
+                std::strcpy(deviceProperties.gcnArchName, "gfx900");
+            }
+        }
+    }
+
     return ArchName<hipDeviceProp_t>{}(deviceProperties);
 }
 
diff --git a/projects/rocblas/library/src/tensile_host.cpp b/projects/rocblas/library/src/tensile_host.cpp
index a87bace8bb..7e54a8b0d6 100644
--- a/projects/rocblas/library/src/tensile_host.cpp
+++ b/projects/rocblas/library/src/tensile_host.cpp
@@ -269,14 +269,6 @@ namespace
         {
             return Tensile::LazyLoadingInit::gfx1010;
         }
-        else if(deviceString.find("gfx1011") != std::string::npos)
-        {
-            return Tensile::LazyLoadingInit::gfx1011;
-        }
-        else if(deviceString.find("gfx1012") != std::string::npos)
-        {
-            return Tensile::LazyLoadingInit::gfx1012;
-        }
         else if(deviceString.find("gfx1030") != std::string::npos)
         {
             return Tensile::LazyLoadingInit::gfx1030;
@@ -301,6 +293,29 @@ namespace
         {
             return Tensile::LazyLoadingInit::gfx1151;
         }
+
+        size_t pos = std::string::npos;
+        if((pos = deviceString.find("gfx103")) != std::string::npos)
+        {
+            return Tensile::LazyLoadingInit::gfx1030;
+        }
+        else if((pos = deviceString.find("gfx101")) != std::string::npos)
+        {
+            return Tensile::LazyLoadingInit::gfx1010;
+        }
+        else if((pos = deviceString.find("gfx90")) != std::string::npos)
+        {
+            constexpr int cmpIdx = std::char_traits<char>::length("gfx90");
+            if(pos + cmpIdx < deviceString.size())
+            {
+                if(deviceString.at(pos + cmpIdx) == '2' || deviceString.at(pos + cmpIdx) == '9'
+                   || deviceString.at(pos + cmpIdx) == 'c')
+                {
+                    return Tensile::LazyLoadingInit::gfx900;
+                }
+            }
+        }
+
         return Tensile::LazyLoadingInit::None;
     }
 
@@ -828,9 +843,10 @@ namespace
                         //populate device property map, used in finding solutions based on arch
                         HIP_CHECK_EXC(hipGetDeviceProperties(&prop, devId));
                         // strip out xnack/ecc from name
-                        std::string deviceFullString(prop.gcnArchName);
+                        std::string deviceFullString = rocblas_internal_get_arch_name();
                         std::string deviceString
                             = deviceFullString.substr(0, deviceFullString.find(":"));
+                        std::strcpy(prop.gcnArchName, deviceFullString.c_str());
                         m_devicePropMap[deviceString] = std::make_shared<hipDeviceProp_t>(prop);
                     }
                 }
-- 
2.52.0

