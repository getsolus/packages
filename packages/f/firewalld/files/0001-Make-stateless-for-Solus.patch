From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Evan Maddock <maddock.evan@vivaldi.net>
Date: Sun, 9 Feb 2025 12:24:07 -0500
Subject: [PATCH] Make stateless for Solus

Signed-off-by: Evan Maddock <maddock.evan@vivaldi.net>
---
 config/Makefile.am                 | 20 ++++++++------------
 src/firewall-applet.in             |  1 +
 src/firewall/config/__init__.py.in | 15 +++++++++++++--
 3 files changed, 22 insertions(+), 14 deletions(-)

diff --git a/config/Makefile.am b/config/Makefile.am
index 65151222..b1fe20ca 100644
--- a/config/Makefile.am
+++ b/config/Makefile.am
@@ -1,6 +1,9 @@
 sconfdir = $(sysconfdir)/firewalld
+libdir = ${prefix}/lib
 prefixlibdir = ${prefix}/lib/firewalld
-dist_sconf_DATA = firewalld.conf
+
+defaultsconfdir = $(datadir)/defaults/etc/firewalld
+dist_defaultsconf_DATA = firewalld.conf
 
 desktop_FILES = firewall-config.desktop.in
 desktopdir = $(datadir)/applications
@@ -11,10 +14,10 @@ appdatadir = $(datadir)/metainfo/
 appdata_DATA = $(appdata_FILES:.in=)
 
 applet_desktop_FILES = firewall-applet.desktop.in
-applet_desktopdir = $(sysconfdir)/xdg/autostart
+applet_desktopdir = $(datadir)/xdg/autostart
 applet_desktop_DATA = $(applet_desktop_FILES:.in=)
 
-confdir = $(sysconfdir)/firewall
+confdir = $(datadir)/defaults/etc/firewall
 dist_conf_DATA = applet.conf
 
 polkit1_action_FILES = org.fedoraproject.FirewallD1.server.policy.in \
@@ -505,8 +508,8 @@ uninstall-service: uninstall-sysconfig
 	rmdir $(DESTDIR)$(SYSTEMD_UNITDIR) || :
 
 install-modprobe.d:
-	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/modprobe.d
-	$(INSTALL_DATA) firewalld-sysctls.conf $(DESTDIR)$(sysconfdir)/modprobe.d/firewalld-sysctls.conf
+	$(MKDIR_P) $(DESTDIR)$(libdir)/modprobe.d
+	$(INSTALL_DATA) firewalld-sysctls.conf $(DESTDIR)$(libdir)/modprobe.d/firewalld-sysctls.conf
 
 uninstall-modprobe.d:
 	rm -f $(DESTDIR)$(sysconfdir)/modprobe.d/firewalld-sysctls.conf
@@ -521,13 +524,6 @@ uninstall-logrotate.d:
 	rmdir $(DESTDIR)$(sysconfdir)/logrotate.d || :
 
 install-config:
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/icmptypes
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/ipsets
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/policies
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/services
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/zones
-	$(MKDIR_P) $(DESTDIR)$(sconfdir)/helpers
 	$(MKDIR_P) $(DESTDIR)$(prefixlibdir)
 	cp -r $(srcdir)/icmptypes $(DESTDIR)$(prefixlibdir)
 	cp -r $(srcdir)/ipsets $(DESTDIR)$(prefixlibdir)
diff --git a/src/firewall-applet.in b/src/firewall-applet.in
index 7e223f1e..52126f0e 100755
--- a/src/firewall-applet.in
+++ b/src/firewall-applet.in
@@ -486,6 +486,7 @@ class TrayApplet(QtWidgets.QSystemTrayIcon):
         # file system watcher
 
         self.watcher = Watcher(self.load_settings, 2)
+        self.watcher.add_watch_file("/usr/share/defaults/etc/firewall/applet.conf")
         self.watcher.add_watch_file("/etc/firewall/applet.conf")
         self.watcher.add_watch_file(str(self.settings.fileName()))
 
diff --git a/src/firewall/config/__init__.py.in b/src/firewall/config/__init__.py.in
index 4951d37c..6f865e6b 100644
--- a/src/firewall/config/__init__.py.in
+++ b/src/firewall/config/__init__.py.in
@@ -23,6 +23,8 @@ gettext.install(domain=DOMAIN)
 
 from . import dbus  # noqa: F401
 
+from os.path import exists
+
 # configuration
 DAEMON_NAME = "firewalld"
 CONFIG_NAME = "firewall-config"
@@ -53,10 +55,19 @@ LICENSE = gettext.gettext(
 WEBSITE = "http://www.firewalld.org"
 
 
+def set_firewall_config_path():
+    global FIREWALLD_CONF
+    FIREWALLD_CONF = "/etc/firewalld/firewalld.conf"
+    if not exists(FIREWALLD_CONF):
+        FIREWALLD_CONF = "/usr/share/defaults/etc/firewalld/firewalld.conf"
+
+
+set_firewall_config_path()
+
+
 def set_system_config_paths(path):
-    global ETC_FIREWALLD, FIREWALLD_CONF, ETC_FIREWALLD_ZONES, ETC_FIREWALLD_SERVICES, ETC_FIREWALLD_ICMPTYPES, ETC_FIREWALLD_IPSETS, ETC_FIREWALLD_HELPERS, FIREWALLD_DIRECT, ETC_FIREWALLD_POLICIES
+    global ETC_FIREWALLD, ETC_FIREWALLD_ZONES, ETC_FIREWALLD_SERVICES, ETC_FIREWALLD_ICMPTYPES, ETC_FIREWALLD_IPSETS, ETC_FIREWALLD_HELPERS, FIREWALLD_DIRECT, ETC_FIREWALLD_POLICIES
     ETC_FIREWALLD = path
-    FIREWALLD_CONF = path + "/firewalld.conf"
     ETC_FIREWALLD_ZONES = path + "/zones"
     ETC_FIREWALLD_SERVICES = path + "/services"
     ETC_FIREWALLD_ICMPTYPES = path + "/icmptypes"
