# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name       : fontconfig
version    : 2.17.1
release    : 51
source     :
    - https://gitlab.freedesktop.org/api/v4/projects/890/packages/generic/fontconfig/2.17.1/fontconfig-2.17.1.tar.xz : 9f5cae93f4fffc1fbc05ae99cdfc708cd60dfd6612ffc0512827025c026fa541
homepage   : https://www.freedesktop.org/wiki/Software/fontconfig/
license    :
    - MIT
    - HPND
summary    : Font configuration utilities
component  : desktop.library
description: |
    The Fontconfig package contains a library and support programs used for configuring and customizing font access
emul32     : true
clang      : true
optimize   :
    - lto
    - speed
builddeps  :
    - pkgconfig32(freetype2)
    - pkgconfig32(libxml-2.0)
    - pkgconfig32(uuid)
    - gperf
rundeps    :
    - 32bit : harfbuzz-32bit
    - harfbuzz
setup      : |
    %patch -p1 -i ${pkgfiles}/0003-Support-local-configs-too-for-stateless-implementati.patch

    %meson_configure \
        -Dbaseconfig-dir=/etc/fonts \
        -Dbitmap-conf=noinstall \
        -Dconfig-dir=/etc/fonts/conf.d \
        -Ddefault-hinting=slight \
        -Ddefault-sub-pixel-rendering=noinstall \
        -Ddoc=disabled \
        -Dxml-backend=libxml2
build      : |
    %ninja_build
install    : |
    %ninja_install
    %install_license COPYING

    if [[ ! -z "${EMUL32BUILD}" ]]; then
        # Prevent these from conflicting with the 64-bit build
        rm -rfv $installdir/etc \
                $installdir/usr/bin \
                $installdir/usr/include \
                $installdir/usr/share
        exit 0
    fi

    # Stateless
    install -Ddm00755 ${installdir}/usr/share/fontconfig/conf.default
    mv ${installdir}/etc/fonts/fonts.conf ${installdir}/usr/share/fontconfig/fonts.conf
    for _f in ${installdir}/etc/fonts/conf.d/*.conf; do
        ln -srvf "${installdir}"/usr/share/fontconfig/conf.{avail,default}/"${_f##*/}"
    done
    rm -vrf $installdir/etc/

    # This config file will serve as the entry point for all fontconfig configuration
    install -Dm00644 $pkgfiles/fonts.conf $installdir/usr/share/fontconfig/fonts.conf.link

    # Install docs manually
    install -dm00755 ${installdir}/usr/share/man/man1
    install -dm00755 ${installdir}/usr/share/man/man3
    install -dm00755 ${installdir}/usr/share/man/man5

    for _f in doc/*.1; do
        install -p -Dm00644 ${_f} ${installdir}/usr/share/man/man1
    done
    for _f in doc/*.3; do
        install -p -Dm00644 ${_f} ${installdir}/usr/share/man/man3
    done
    for _f in doc/*.5; do
        install -p -Dm00644 ${_f} ${installdir}/usr/share/man/man5
    done

    # Tmpfiles
    install -Dm00644 $pkgfiles/fontconfig.tmpfiles $installdir/%libdir%/tmpfiles.d/fontconfig.conf

    rm -vrf ${installdir}/var
check      : |
    %ninja_check
