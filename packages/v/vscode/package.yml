name       : vscode
version    : 1.85.1
release    : 202
source     :
    - git|https://github.com/Microsoft/vscode.git : 1.85.1
homepage   : https://code.visualstudio.com/
license    :
    - GPL-3.0-or-later # Icon (from Papirus)
    - MIT # VS Code
component  : programming.ide
summary    : Visual Studio Code (open source version) is a new type of tool that combines the simplicity of a code editor with what developers need for their core edit-build-debug cycle.
description: |
    Visual Studio Code (open source version) is a new type of tool that combines the simplicity of a code editor with what developers need for their core edit-build-debug cycle.
networking : yes
builddeps  :
    - pkgconfig(alsa)
    - pkgconfig(gbm)
    - pkgconfig(gtk+-3.0)
    - pkgconfig(krb5-gssapi)
    - pkgconfig(libdrm)
    - pkgconfig(libsecret-1)
    - pkgconfig(xcomposite)
    - pkgconfig(xcursor)
    - pkgconfig(xkbfile)
    - pkgconfig(xrandr)
    - pkgconfig(xscrnsaver)
    - pkgconfig(xshmfence)
    - pkgconfig(xtst)
    - yarn
    - yq
rundeps    :
    - git
    - libxscrnsaver
    - nodejs
replaces   :
    - vscode-ms
setup      : |
    %patch -p1 -i $pkgfiles/0001-Attempt-to-symlink-.config-Code-to-.config-Code-OSS-.patch
    cp $pkgfiles/code.png $workdir/resources/linux/

    # Appdata/MIME
    sed -i -e 's|@@NAME@@|code-oss|g' \
           -e 's|@@NAME_LONG@@|Visual Studio Code|g' \
           -e 's|@@LICENSE@@|MIT|g' resources/linux/code.appdata.xml
    sed -i -e 's|@@NAME@@|code|g' \
           -e 's|@@NAME_LONG@@|Visual Studio Code|g' resources/linux/code-workspace.xml

    # Add icon to MIME
    yq -o=xml '.mime-info.mime-type.icon.+@name = "visual-studio-code"' -i resources/linux/code-workspace.xml

    # Bug in newer npm: https://github.com/npm/cli/issues/6842 
    yarn global add node-gyp

    # Override Electron version to one that doesn't crash on Wayland
    export ELECTRON_VERSION=25.9.4
    sed -i "s|^target.*|target \"$ELECTRON_VERSION\"|" .yarnrc
    yarn add electron@$ELECTRON_VERSION

    # This file is only needed if you're overriding the Electron version. You can download the files from the Electron github releases and checksum them
    cat $pkgfiles/electron-override.checksums >> $workdir/build/checksums/electron.txt

    yarn install --frozen-lockfile --network-timeout 180000
build      : |
    yarn run gulp vscode-linux-x64
install    : |
    export vsdir=/usr/share/vscode
    install -dm00755 $installdir/usr/bin
    install -dm00755 $installdir/$vsdir
    cp -R $workdir/../VSCode-linux-x64/* $installdir/$vsdir/
    ln -s $vsdir/bin/code-oss $installdir/usr/bin/code-oss
    install -Dm00644 $pkgfiles/product.json $installdir/$vsdir/resources/app/product.json
    install -Dm00644 $pkgfiles/code-oss.desktop $installdir/usr/share/applications/code-oss.desktop
    install -Dm00644 $pkgfiles/code-oss-url-handler.desktop $installdir/usr/share/applications/code-oss-url-handler.desktop
    install -Dm00644 $pkgfiles/visual-studio-code.svg $installdir/usr/share/icons/hicolor/scalable/apps/visual-studio-code.svg
    install -Dm00755 $pkgfiles/code-oss $installdir/$vsdir/bin/code-oss
    install -Dm00644 $installdir/$vsdir/resources/completions/bash/code-oss $installdir/usr/share/bash-completion/completions/code-oss
    install -Dm00644 $installdir/$vsdir/resources/completions/zsh/_code-oss $installdir/usr/share/zsh/site-functions/_code-oss

    # Fix Wayland/Xorg window associations
    sed -i 's|Code - OSS|code-oss|g' $installdir/$vsdir/resources/app/package.json

    # Appdata/MIME
    install -Dm00644 $workdir/resources/linux/code.appdata.xml $installdir/usr/share/metainfo/com.visualstudio.code.appdata.xml
    install -Dm00644 $workdir/resources/linux/code-workspace.xml $installdir/usr/share/mime/packages/code-workspace.xml
