# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name       : openimagedenoise
version    : 2.3.0
release    : 13
source     :
    - https://github.com/RenderKit/oidn/releases/download/v2.3.0/oidn-2.3.0.src.tar.gz : cce3010962ec84e0ba1acd8c9055a3d8de402fedb1b463517cfeb920a276e427
license    : Apache-2.0
homepage   : https://www.openimagedenoise.org/
component  : multimedia.library
summary    : High-Performance Denoising Library for Ray Tracing
description: |
    The purpose of Intel Open Image Denoise is to provide an open, high-quality, efficient, and easy-to-use denoising library that allows one to significantly reduce rendering times in ray tracing based rendering applications.
clang      : true
avx2       : true
optimize   :
    - icf-all
    - thin-lto
builddeps  :
    - pkgconfig(OpenImageIO)
    - composable-kernel-devel
    - intel-tbb-devel
    - ispc
    - rocm-hip
environment: |
    export HIP_PATH=/usr
    export HIP_CLANG_PATH=/usr/lib64/llvm-rocm/bin
    export HIP_CXX_COMPILER=$HIP_CLANG_PATH/clang++
    export HIP_DEVICE_LIB_PATH=/usr/lib64/amdgcn/bitcode
setup      : |
    rm -rf exeternal/composable_kernel/include/{ck,ck_tile}
    cp -r /usr/include/{ck,ck_tile} external/composable_kernel/include/

    # OpenImageIO v3 headers only work with C++ 17 and above
    sed -i 's|CXX_STANDARD 14|CXX_STANDARD 17|' apps/utils/CMakeLists.txt

    # TODO(GZGavinZhao): enable HIP support again, have issues with CK headers.
    # OIDN's HIP backend is rarely, if ever used, inside Blender anyway.
    %cmake_ninja -L \
      -DOIDN_APPS="$((1-${AVX2BUILD:-0}))" \
      -DOIDN_APPS_OPENIMAGEIO=ON \
      -DOIDN_DEVICE_HIP=OFF \
      -DROCM_PATH=$HIP_PATH \
      -DCMAKE_CXX_STANDARD=17
build      : |
    %ninja_build
install    : |
    %ninja_install
    rm -f $installdir/usr/bin/oidnTest
check      : |
    if [[ -z "${AVX2BUILD}" ]]; then
        ./solusBuildDir/oidnTest
    fi
