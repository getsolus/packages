# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name: openssh
version: 10.2_p1
release: 63
source:
    - https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-10.2p1.tar.gz: ccc42c0419937959263fa1dbd16dafc18c56b984c03562d2937ce56a60f798b2
homepage: https://www.openssh.com/
license:
    - BSD-2-Clause
    - BSD-3-Clause
    - ISC
    - MIT
summary:
    - OpenSSH (OpenBSD Secure Shell)
    - server: OpenSSH Daemon
description: |
    OpenSSH is a free version of secure shell tools developed by the OpenBSD project to help facilitate secure connections and communications.
component:
    - network.clients
    - server: network.clients
builddeps:
    - pkgconfig(ext2fs)
    - pkgconfig(krb5)
    - pkgconfig(libedit)
    - pkgconfig(libfido2)
    - pkgconfig(libldns)
    - pkgconfig(libsystemd)
    - pkgconfig(libxcrypt)
    - groff
    - xauth
rundeps:
    - server:
          - openssh
          - xauth
setup: |
    %apply_patches

    # --disable-strip is specified because we want the build toolchain to do it instead
    %configure --sysconfdir=/etc/ssh \
               --datadir=/usr/share/sshd \
               --with-pid-dir=/run \
               --with-xauth=/usr/bin/xauth \
               --with-kerberos5=/usr \
               --with-ldns=/usr \
               --with-libedit \
               --with-pam \
               --with-ssl-engine \
               --with-security-key-builtin \
               --with-privsep-path=/var/lib/sshd \
               --disable-lastlog \
               --disable-strip
build: |
    %make
install: |
    %make_install

    # PAM
    install -Dm 00644 $pkgfiles/sshd.pam $installdir/usr/share/defaults/etc/pam.d/sshd

    # systemd
    install -Dm 00644 $pkgfiles/sshd.service $installdir/usr/lib/systemd/system/sshd.service
    install -Dm 00644 $pkgfiles/sshd@.service $installdir/usr/lib/systemd/system/sshd@.service
    install -Dm 00644 $pkgfiles/sshd-keygen.service $installdir/usr/lib/systemd/system/sshd-keygen.service

    # Folks want ssh-copy-id :)
    install -Dm 00755 contrib/ssh-copy-id $installdir/usr/bin/.

    install -Dm 00644 $pkgfiles/openssh.tmpfiles $installdir/usr/lib/tmpfiles.d/openssh.conf
    install -Dm 00644 $pkgfiles/openssh-server.tmpfiles $installdir/usr/lib/tmpfiles.d/openssh-server.conf
    install -Dm 00644 $pkgfiles/openssh.sysusers $installdir/usr/lib/sysusers.d/openssh.conf

    # Stateless
    install -dm00755 $installdir/usr/share/defaults/
    mv $installdir/etc/ssh $installdir/usr/share/defaults/
    ls -ahl $installdir/var/lib
    rmdir $installdir/var/lib/sshd
    rmdir $installdir/var/lib
    rmdir $installdir/var
    rmdir $installdir/etc
patterns:
    - server:
          - /usr/sbin
          - /usr/lib/systemd/system
          - /usr/lib/sysusers.d
          - /usr/lib/tmpfiles.d/openssh-server.conf
          - /usr/lib64/openssh/sftp*
          - /usr/lib64/openssh/sshd-session
          - /usr/share/defaults/etc/pam.d/sshd
          - /usr/share/defaults/ssh/moduli
          - /usr/share/defaults/ssh/sshd_config
          - /usr/share/man/*/moduli*
          - /usr/share/man/*/sshd*
          - /usr/share/man/*/sftp-*
