# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name       : python-pyside6
version    : 6.10.1
release    : 30
source     :
    - https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-6.10.1-src/pyside-setup-everywhere-src-6.10.1.tar.xz : fd54f40853d61dfd845dbb40d4f89fbd63df5ed341b3d9a2c77bb5c947a0a838
homepage   : https://www.qt.io
license    :
    - GPL-2.0-or-later
    - LGPL-3.0-or-later
component  :
    - ^shiboken6 : programming.python
    - ^shiboken6-devel : programming.devel
    - programming.python
summary    :
    - ^shiboken6 : Python / C++ bindings generator for PySide6
    - ^shiboken6-devel : Development files for shiboken6
    - Python bindings for the Qt 6 cross-platform application and UI framework
description:
    - ^shiboken6 : Shiboken is the Python binding generator that Qt for Python uses to create the PySide module, in other words, is the system we use to expose the Qt C++ API to Python.
    - ^shiboken6-devel : Shiboken is the Python binding generator that Qt for Python uses to create the PySide module, in other words, is the system we use to expose the Qt C++ API to Python.
    - PySide6 is the official Python module from the Qt for Python project, which provides access to the complete Qt6 framework.
clang      : true
builddeps  :
    - pkgconfig(Qt63DCore)
    - pkgconfig(Qt6Bluetooth)
    - pkgconfig(Qt6Charts)
    - pkgconfig(Qt6DataVisualization)
    - pkgconfig(Qt6Location)
    - pkgconfig(Qt6Multimedia)
    - pkgconfig(Qt6NetworkAuth)
    - pkgconfig(Qt6Pdf)
    - pkgconfig(Qt6Qml)
    - pkgconfig(Qt6Quick3D)
    - pkgconfig(Qt6RemoteObjects)
    - pkgconfig(Qt6Scxml)
    - pkgconfig(Qt6Sensors)
    - pkgconfig(Qt6SerialBus)
    - pkgconfig(Qt6SerialPort)
    - pkgconfig(Qt6ShaderTools)
    - pkgconfig(Qt6Svg)
    - pkgconfig(Qt6TextToSpeech)
    - pkgconfig(Qt6WebEngineCore)
    - pkgconfig(Qt6WebSockets)
    - pkgconfig(Qt6WebView)
    - pkgconfig(libxslt)
    - pkgconfig(python3)
    - pkgconfig(xcb)
    - clang-devel
    - numpy
    - python-packaging
    - python-setuptools
    - python-six
    - qt6-base-private-devel
    - qt6-positioning-devel
rundeps    :
    - ^shiboken6-devel :
        - shiboken6
    - devel :
        - shiboken6
environment: |
    export PYTHONPATH=$PWD/solusBuildDir/sources
setup      : |
    %patch -p1 -i $pkgfiles/0001-Revert-Modify-headers-installation-for-CMake-builds.patch
    %patch -p1 -i $pkgfiles/0001-Always-link-to-python-libraries.patch
    %patch -p1 -i $pkgfiles/0001-Fix-installation.patch

    # https://build.opensuse.org/package/view_file/KDE:Qt6/python3-pyside6/python3-pyside6.spec?expand=1
    # Restore 6.6.1 RPATH value.
    sed -i 's#${base}/../shiboken6/##' sources/pyside6/CMakeLists.txt

    %cmake_ninja \
        -DSHIBOKEN_PYTHON_LIBRARIES=`pkgconf python3-embed --libs` \
        -DBUILD_TESTS=OFF \
        -DCMAKE_BUILD_RPATH_USE_ORIGIN:BOOL=ON \
        -DCMAKE_SKIP_INSTALL_RPATH:BOOL=ON \
        -DFORCE_LIMITED_API=no \
        -DNO_QT_TOOLS=yes
build      : |
    %ninja_build
install    : |
    %ninja_install

    # Generate egg-info manually and install since we're performing a cmake build.
    #
    # Copy CMake configuration files from the BINARY dir back to the SOURCE dir so
    # setuptools can find them.
    cp solusBuildDir/sources/shiboken6/shibokenmodule/{*.py,*.txt} sources/shiboken6/shibokenmodule/
    cp solusBuildDir/sources/pyside6/PySide6/*.py sources/pyside6/PySide6/
    python3 setup.py --qtpaths=/usr/lib64/qt6/bin/qtpaths install_scripts --install-dir=$installdir/usr/bin

    for name in PySide6 shiboken6 shiboken6_generator; do
        mkdir -p $installdir/usr/lib/python%python3_version%/site-packages/$name-$version-py%python3_version%.egg-info
        cp -p $name.egg-info/{PKG-INFO,top_level.txt} \
            $installdir/usr/lib/python%python3_version%/site-packages/$name-$version-py%python3_version%.egg-info/

        if [ -f $name.egg-info/entry_points.txt ]; then
            cp $name.egg-info/entry_points.txt $installdir/usr/lib/python%python3_version%/site-packages/$name-$version-py%python3_version%.egg-info/
        fi
    done

    # Add symlinks for tools used by pyside_tool.py
    mkdir -p $installdir/usr/lib/python%python3_version%/site-packages/PySide6/Qt/libexec
    ln -sf /usr/lib64/qt6/{qmlcachegen,qmlimportscanner,qmltyperegistrar,rcc,uic} $installdir/usr/lib/python%python3_version%/site-packages/PySide6/Qt/libexec
    ln -sf /usr/lib64/qt6/bin/{assistant,balsam,balsamui,designer,linguist,lrelease,lupdate,qmlformat,qmllint,qmlls,qsb} $installdir/usr/lib/python%python3_version%/site-packages/PySide6/Qt/libexec

    # Create scripts folders (this basically replicates prepare_packages() in build_scripts/main.py)
    mkdir -p $installdir/usr/lib/python%python3_version%/site-packages/PySide6/scripts
    mv $installdir/usr/bin/{android_deploy.py,deploy_lib,deploy.py,metaobjectdump.py,project_lib,project.py,pyside_tool.py,qml.py,qtpy2cpp_lib,qtpy2cpp.py,requirements-android.txt} $installdir/usr/lib/python%python3_version%/site-packages/PySide6/scripts
    mkdir -p $installdir/usr/lib/python%python3_version%/site-packages/shiboken6_generator/scripts
    mv $installdir/usr/bin/shiboken_tool.py $installdir/usr/lib/python%python3_version%/site-packages/shiboken6_generator/scripts

    # Install shiboken6
    mv solusBuildDir/sources/shiboken6/generator/shiboken6 $installdir/usr/lib/python%python3_version%/site-packages/shiboken6_generator

    # Fix CMake config files to use correct absolute paths (OpenSUSE solution)
    # The upstream build is designed for wheel installation with relative paths,
    # but for system installation we need absolute paths
    sed -i 's#/typesystems#/share/PySide6/typesystems#g' $installdir/usr/lib/cmake/PySide6/*.cmake
    sed -i 's#/glue#/share/PySide6/glue#g' $installdir/usr/lib/cmake/PySide6/*.cmake
patterns   :
    - ^shiboken6 :
        - /usr/lib/cmake/Shiboken6Tools/*
        - /usr/lib/libshiboken6*.so.6.10*
        - /usr/lib/python3.*/site-packages/shiboken6
        - /usr/lib/python3.*/site-packages/shiboken6-*.egg-info
    - ^shiboken6-devel :
        - /usr/bin/shiboken6*
        - /usr/include/shiboken6/
        - /usr/lib/cmake/Shiboken6/
        - /usr/lib/libshiboken6*.so
        - /usr/lib/pkgconfig/shiboken6.pc
        - /usr/lib/python3.*/site-packages/shiboken6_generator
        - /usr/lib/python3.*/site-packages/shiboken6_generator-*.egg-info
