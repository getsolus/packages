# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name: ypkg
version: 35.0.2
release: 212
source:
    - https://github.com/getsolus/ypkg/archive/refs/tags/v35.0.2.tar.gz: c944b5129aeb33d245cbdaabeaa55fb65dcdc7dcab80e32ef10dc59f96d31bc0
homepage: https://github.com/getsolus/ypkg
license: GPL-3.0-or-later
component: system.devel
summary: Modern, declarative, structured build format
description: |
    ypkg is the build tool of choice for Solus.

    Simply put, it is a tool to convert a build process into a packaging operation.
mancompress: true
strip: false
debug: false
builddeps:
    - pkgconfig(python3)
    - nuitka
    - patchelf
    - python-build
    - python-eopkg
    - python-hatchling
    - python-humanize
    - python-installer
    - python-setuptools
    - python-typer
    - python-typing-extensions
    - python-wheel
    - python-xattr
    - python-zstandard
rundeps:
    - python-eopkg
    - python-humanize
    - python-typer
    - python-typing-extensions
    - python-xattr
    - python-zstandard
    - pyyaml
    - ruamel_yaml
clang: true
environment: |
    # ensure our nuitka build doesn't pull in -v3 hwcaps libs
    export GLIBC_TUNABLES=glibc.cpu.hwcaps=-AVX
build: |
    %python3_setup
install: |
    %python3_install

    # build static bins from ypkg
    time nuitka3 --onefile --include-module=dbm.gnu --show-scons --lto=yes --no-deployment-flag=self-execution --main=$installdir/usr/bin/ypkg --jobs=%YJOBS%

    # Install main ypkg binary
    mv $installdir/usr/bin/ypkg $installdir/usr/bin/ypkg.py
    install -Dm0755 $workdir/ypkg.bin -t $installdir/usr/bin/
    ln -srvf $installdir/usr/bin/ypkg.bin $installdir/usr/bin/ypkg
