# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name: yubico-authenticator
version: 7.3.1
release: 13
source:
    - https://github.com/Yubico/yubioath-flutter/archive/refs/tags/7.3.1.tar.gz: 3ed9387cd1b4d3cbdcd3448bf4660460dc7f46ba811c47a69180a3971319f27c
    - https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.35.3-stable.tar.xz#flutter.tar.xz: 791550652e29a9588815c0e3aac7cf7cd1d1d5d6a1f1631d46cb146e8a2e1a1d
homepage: https://www.yubico.com/products/yubico-authenticator/
license: Apache-2.0
component: security
summary: Yubico Authenticator for Desktop
description: |
    Store your unique credential on a hardware-backed security key and take it wherever you go from mobile to desktop. No more storing sensitive secrets on your mobile phone, leaving your account vulnerable to takeovers. With the Yubico Authenticator you can raise the bar for security.

    The Yubico Authenticator will work with any USB or NFC-enabled YubiKeys

    The Yubico Authenticator securely generates a code used to verify your identity as you are logging into various services. No connectivity needed!
patterns:
    - /*
networking: true
clang: true # For Flutter
builddeps:
    - pkgconfig(ayatana-appindicator-0.1)
    - pkgconfig(gtk+-3.0)
    - pkgconfig(libnotify)
    - pkgconfig(libpcsclite)
    - pkgconfig(python3)
    - git # For Flutter
    - pip
    - swig
    - uv
rundeps:
    - ccid
    - pcsc-lite
environment: |
    # Flutter
    export PATH="$PATH:$sources/flutter/bin"
setup: |
    # Extract Flutter
    tar -xf $sources/flutter.tar.xz -C $sources/
    # Flutter detects the version of itself through git
    git config --global --add safe.directory /home/build/YPKG/sources/flutter
build: |
    # First, build the Python authentication helper
    ./build-helper.sh

    # Then, build the Flutter GUI
    flutter pub get
    flutter build linux --release
install: |
    export YUBIOATH_DIR=/usr/share/yubioath-desktop

    # Flutter GUI
    install -dm00755 $installdir/usr/share
    mv build/linux/x64/release/bundle $installdir/$YUBIOATH_DIR/

    # Desktop, icon and appstream metainfo
    sed -i 's|\(Exec="\)@EXEC_PATH|\1/usr/share/yubioath-desktop|' $installdir/$YUBIOATH_DIR/linux_support/com.yubico.yubioath.desktop
    sed -i 's|\(Icon=\)@EXEC_PATH/linux_support/|\1|' $installdir/$YUBIOATH_DIR/linux_support/com.yubico.yubioath.desktop
    # appstream builder cannot handle symlink, do install instead
    install -Dm00644 $installdir/$YUBIOATH_DIR/linux_support/com.yubico.yubioath.desktop $installdir/usr/share/applications/com.yubico.yubioath.desktop
    install -Dm00644 $installdir/$YUBIOATH_DIR/linux_support/com.yubico.yubioath.png $installdir/usr/share/icons/hicolor/128x128/apps/com.yubico.yubioath.png
    install -Dm00644 $pkgfiles/com.yubico.yubioath.appdata.xml -t $installdir/usr/share/metainfo/

    # Binary
    install -dm00755 $installdir/usr/bin
    ln -sv $YUBIOATH_DIR/authenticator $installdir/usr/bin/authenticator

    # Lastly, remove some unnecessary files
    rm $installdir/$YUBIOATH_DIR/{desktop_integration.sh,README.adoc}
    rm $installdir/$YUBIOATH_DIR/data/flutter_assets/assets/licenses/.gitignore
    rm $installdir/$YUBIOATH_DIR/data/flutter_assets/assets/licenses/raw/.gitignore
replaces:
    - yubioath-desktop
    - dbginfo: yubioath-desktop-dbginfo
