From 6715609da71987d6db7a70b4640f3b830dc405f8 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Mon, 12 May 2014 14:57:18 +0200
Subject: [PATCH 01/16] Restore transparency

The transparency settings were removed as a side effect of
2bff4b63ed3ceef6055e35563e9b0b33ad57349d

This restores them and you will need a compositing window manager to
use it. The background image setting, also known as faux transparency,
was not restored.

The transparency checkbox lost its mnemonic accelerator because 't'
is already taken and using any other letter would make it hard to
restore the translations of the string.

Some changes by Peter Weber <peter.weber@mailbox.org>
---
 src/org.gnome.Terminal.gschema.xml | 10 +++++++
 src/preferences.ui                 | 47 ++++++++++++++++++++++++++++++
 src/profile-editor.c               | 16 ++++++++++
 src/terminal-schemas.h             |  3 ++
 src/terminal-screen.c              | 22 +++++++++++++-
 src/terminal-window.c              |  7 +++++
 6 files changed, 104 insertions(+), 1 deletion(-)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index be00aa2d80de..7b04919202b7 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -349,6 +349,16 @@
       <default>'narrow'</default>
       <summary>Whether ambiguous-width characters are narrow or wide when using UTF-8 encoding</summary>
     </key>
+    <key name="use-transparent-background" type="b">
+      <default>false</default>
+      <summary>Whether to use a transparent background</summary>
+    </key>
+    <key name="background-transparency-percent" type="i">
+      <default>50</default>
+      <range min="0" max="100"/>
+      <summary>Adjust the amount of transparency</summary>
+      <description>A value between 0 and 100, where 0 is opaque and 100 is fully transparent.</description>
+    </key>
   </schema>
 
   <!-- Keybinding settings -->
diff --git a/src/preferences.ui b/src/preferences.ui
index d1aca7b2c35c..64f8295bf2b0 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -95,6 +95,11 @@
     <property name="step_increment">0.05</property>
     <property name="page_increment">0.25</property>
   </object>
+  <object class="GtkAdjustment" id="background-transparent-adjustment">
+    <property name="upper">100</property>
+    <property name="step_increment">1</property>
+    <property name="page_increment">10</property>
+  </object>
   <object class="GtkListStore" id="cjk-ambiguous-width-model">
     <columns>
       <!-- column-name gchararray -->
@@ -1402,6 +1407,48 @@
                                             <property name="position">1</property>
                                           </packing>
                                         </child>
+                                        <child>
+                                          <object class="GtkBox" id="use-transparent-background-box">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="orientation">horizontal</property>
+                                            <property name="spacing">12</property>
+                                            <child>
+                                              <object class="GtkCheckButton" id="use-transparent-background">
+                                                <property name="label" translatable="yes">Transparent background</property>
+                                                <property name="visible">True</property>
+                                                <property name="can_focus">True</property>
+                                                <property name="receives_default">False</property>
+                                                <property name="use_underline">True</property>
+                                                <property name="xalign">0</property>
+                                                <property name="draw_indicator">True</property>
+                                              </object>
+                                              <packing>
+                                                <property name="expand">False</property>
+                                                <property name="fill">False</property>
+                                                <property name="position">0</property>
+                                              </packing>
+                                            </child>
+                                            <child>
+                                              <object class="GtkScale" id="background-transparent-scale">
+                                                <property name="visible">True</property>
+                                                <property name="can_focus">True</property>
+                                                <property name="adjustment">background-transparent-adjustment</property>
+                                                <property name="draw_value">False</property>
+                                              </object>
+                                              <packing>
+                                                <property name="expand">True</property>
+                                                <property name="fill">True</property>
+                                                <property name="position">1</property>
+                                              </packing>
+                                            </child>
+                                          </object>
+                                          <packing>
+                                            <property name="expand">True</property>
+                                            <property name="fill">True</property>
+                                            <property name="position">2</property>
+                                          </packing>
+                                        </child>
                                       </object>
                                     </child>
                                   </object>
diff --git a/src/profile-editor.c b/src/profile-editor.c
index 4098f90bf10e..35bd24791417 100644
--- a/src/profile-editor.c
+++ b/src/profile-editor.c
@@ -1431,6 +1431,22 @@ profile_prefs_load (const char *uuid, GSettings *profile)
   profile_prefs_settings_bind (profile, TERMINAL_PROFILE_ENABLE_SIXEL_KEY, w,
                                "active", G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
   gtk_widget_set_visible (w, (vte_get_feature_flags() & VTE_FEATURE_FLAG_SIXEL) != 0);
+
+  profile_prefs_settings_bind (profile,
+                               TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
+                               gtk_builder_get_object (builder, "use-transparent-background"),
+                               "active",
+                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+  profile_prefs_settings_bind (profile,
+                               TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
+                               gtk_builder_get_object (builder, "background-transparent-scale"),
+                               "sensitive",
+                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_NO_SENSITIVITY);
+  profile_prefs_settings_bind (profile,
+                               TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT,
+                               gtk_builder_get_object (builder, "background-transparent-adjustment"),
+                               "value",
+                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
 }
 
 /* Called once per Preferences window, to destroy stuff that doesn't depend on the profile being edited */
diff --git a/src/terminal-schemas.h b/src/terminal-schemas.h
index cffc4ed86b9f..6bfd3e346895 100644
--- a/src/terminal-schemas.h
+++ b/src/terminal-schemas.h
@@ -76,6 +76,9 @@ G_BEGIN_DECLS
 #define TERMINAL_PROFILE_VISIBLE_NAME_KEY               "visible-name"
 #define TERMINAL_PROFILE_WORD_CHAR_EXCEPTIONS_KEY       "word-char-exceptions"
 
+#define TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND      "use-transparent-background"
+#define TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT "background-transparency-percent"
+
 #define TERMINAL_SETTING_CONFIRM_CLOSE_KEY              "confirm-close"
 #define TERMINAL_SETTING_DEFAULT_SHOW_MENUBAR_KEY       "default-show-menubar"
 #define TERMINAL_SETTING_ENABLE_MENU_BAR_ACCEL_KEY      "menu-accelerator-enabled"
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 0c4ee5035215..128b74befc1e 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -1075,7 +1075,9 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       prop_name == I_(TERMINAL_PROFILE_HIGHLIGHT_COLORS_SET_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_HIGHLIGHT_BACKGROUND_COLOR_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_HIGHLIGHT_FOREGROUND_COLOR_KEY) ||
-      prop_name == I_(TERMINAL_PROFILE_PALETTE_KEY))
+      prop_name == I_(TERMINAL_PROFILE_PALETTE_KEY) ||
+      prop_name == I_(TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND) ||
+      prop_name == I_(TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT))
     update_color_scheme (screen);
 
   if (!prop_name || prop_name == I_(TERMINAL_PROFILE_AUDIBLE_BELL_KEY))
@@ -1160,6 +1162,8 @@ update_color_scheme (TerminalScreen *screen)
   GdkRGBA *cursor_bgp = NULL, *cursor_fgp = NULL;
   GdkRGBA *highlight_bgp = NULL, *highlight_fgp = NULL;
   GtkStyleContext *context;
+  GtkWidget *toplevel;
+  gboolean transparent;
   gboolean use_theme_colors;
 
   context = gtk_widget_get_style_context (widget);
@@ -1203,6 +1207,18 @@ update_color_scheme (TerminalScreen *screen)
     }
 
   colors = terminal_g_settings_get_rgba_palette (priv->profile, TERMINAL_PROFILE_PALETTE_KEY, &n_colors);
+
+  transparent = g_settings_get_boolean (profile, TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND);
+  if (transparent)
+    {
+      gint transparency_percent;
+
+      transparency_percent = g_settings_get_int (profile, TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT);
+      bg.alpha = (100 - transparency_percent) / 100.0;
+    }
+  else
+    bg.alpha = 1.0;
+
   vte_terminal_set_colors (VTE_TERMINAL (screen), &fg, &bg,
                            colors, n_colors);
   vte_terminal_set_color_bold (VTE_TERMINAL (screen), boldp);
@@ -1210,6 +1226,10 @@ update_color_scheme (TerminalScreen *screen)
   vte_terminal_set_color_cursor_foreground (VTE_TERMINAL (screen), cursor_fgp);
   vte_terminal_set_color_highlight (VTE_TERMINAL (screen), highlight_bgp);
   vte_terminal_set_color_highlight_foreground (VTE_TERMINAL (screen), highlight_fgp);
+
+  toplevel = gtk_widget_get_toplevel (GTK_WIDGET (screen));
+  if (toplevel != NULL && gtk_widget_is_toplevel (toplevel))
+    gtk_widget_set_app_paintable (toplevel, transparent);
 }
 
 static void
diff --git a/src/terminal-window.c b/src/terminal-window.c
index 7a8953c50388..a3d77bf6719d 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -2094,6 +2094,8 @@ terminal_window_init (TerminalWindow *window)
   };
   TerminalWindowPrivate *priv;
   TerminalApp *app;
+  GdkScreen *screen;
+  GdkVisual *visual;
   GSettings *gtk_debug_settings;
   GtkWindowGroup *window_group;
   //  GtkAccelGroup *accel_group;
@@ -2109,6 +2111,11 @@ terminal_window_init (TerminalWindow *window)
 
   gtk_widget_init_template (GTK_WIDGET (window));
 
+  screen = gtk_widget_get_screen (GTK_WIDGET (window));
+  visual = gdk_screen_get_rgba_visual (screen);
+  if (visual != NULL)
+    gtk_widget_set_visual (GTK_WIDGET (window), visual);
+
   uuid_generate (u);
   uuid_unparse (u, uuidstr);
   priv->uuid = g_strdup (uuidstr);
-- 
2.25.4


From c75db4814eaee946daccc526c5f37124f1981352 Mon Sep 17 00:00:00 2001
From: Lars Uebernickel <lars.uebernickel@canonical.com>
Date: Wed, 28 May 2014 14:11:02 +0200
Subject: [PATCH 02/16] window: Make the drawing robust across all themes

There are lots of themes out there in the wild that do not specify a
background-color for all widgets and the default is transparent. This
is usually not a problem because GTK+ sets an opaque region on the
whole window and things without a background-color get drawn with the
theme's default background colour. However, to achieve transparency
we disable the opaque region by making the window app-paintable. This
can lead to transparent menubars or notebook tabs in some themes. We
can avoid this by ensuring that the window always renders a background.

https://bugzilla.gnome.org/show_bug.cgi?id=730016
---
 src/terminal-window.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/src/terminal-window.c b/src/terminal-window.c
index a3d77bf6719d..36d155a9e420 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -1953,6 +1953,26 @@ terminal_window_realize (GtkWidget *widget)
   terminal_window_update_size (window);
 }
 
+static gboolean
+terminal_window_draw (GtkWidget *widget,
+                      cairo_t   *cr)
+{
+  if (gtk_widget_get_app_paintable (widget))
+    {
+      GtkStyleContext *context;
+      int width;
+      int height;
+
+      context = gtk_widget_get_style_context (widget);
+      width = gtk_widget_get_allocated_width (widget);
+      height = gtk_widget_get_allocated_height (widget);
+      gtk_render_background (context, cr, 0, 0, width, height);
+      gtk_render_frame (context, cr, 0, 0, width, height);
+    }
+
+  return GTK_WIDGET_CLASS (terminal_window_parent_class)->draw (widget, cr);
+}
+
 static gboolean
 terminal_window_state_event (GtkWidget            *widget,
                              GdkEventWindowState  *event)
@@ -2270,6 +2290,7 @@ terminal_window_class_init (TerminalWindowClass *klass)
 
   widget_class->show = terminal_window_show;
   widget_class->realize = terminal_window_realize;
+  widget_class->draw = terminal_window_draw;
   widget_class->window_state_event = terminal_window_state_event;
   widget_class->screen_changed = terminal_window_screen_changed;
   widget_class->style_updated = terminal_window_style_updated;
-- 
2.25.4


From e7810e47cf096ce6901e572bb9f5256601aed62d Mon Sep 17 00:00:00 2001
From: "Owen W. Taylor" <otaylor@fishsoup.net>
Date: Fri, 13 Nov 2015 15:16:42 +0100
Subject: [PATCH 03/16] screen, window: Extra padding around transparent
 terminals in Wayland

https://bugzilla.redhat.com/show_bug.cgi?id=1207943
---
 src/terminal-screen.c | 41 +++++++++++++++++++++++++++++++++++++----
 src/terminal-window.c | 18 ++++++++++++------
 2 files changed, 49 insertions(+), 10 deletions(-)

diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 128b74befc1e..a1c3161391da 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -151,6 +151,8 @@ static void terminal_screen_system_font_changed_cb (GSettings *,
 static gboolean terminal_screen_popup_menu (GtkWidget *widget);
 static gboolean terminal_screen_button_press (GtkWidget *widget,
                                               GdkEventButton *event);
+static void terminal_screen_hierarchy_changed (GtkWidget *widget,
+                                               GtkWidget *previous_toplevel);
 static void terminal_screen_child_exited  (VteTerminal *terminal,
                                            int status);
 
@@ -620,6 +622,7 @@ terminal_screen_class_init (TerminalScreenClass *klass)
   widget_class->drag_data_received = terminal_screen_drag_data_received;
   widget_class->button_press_event = terminal_screen_button_press;
   widget_class->popup_menu = terminal_screen_popup_menu;
+  widget_class->hierarchy_changed = terminal_screen_hierarchy_changed;
 
   terminal_class->child_exited = terminal_screen_child_exited;
 
@@ -1147,6 +1150,32 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
   g_object_thaw_notify (object);
 }
 
+static void
+update_toplevel_transparency (TerminalScreen *screen)
+{
+  GtkWidget *widget = GTK_WIDGET (screen);
+  TerminalScreenPrivate *priv = screen->priv;
+  GSettings *profile = priv->profile;
+  GtkWidget *toplevel;
+
+  toplevel = gtk_widget_get_toplevel (widget);
+  if (toplevel != NULL && gtk_widget_is_toplevel (toplevel))
+    {
+      gboolean transparent;
+
+      transparent = g_settings_get_boolean (profile, TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND);
+      if (gtk_widget_get_app_paintable (toplevel) != transparent)
+        {
+          gtk_widget_set_app_paintable (toplevel, transparent);
+
+          /* The opaque region of the toplevel isn't updated until the toplevel is allocated;
+           * set_app_paintable() doesn't force an allocation, so do that manually.
+           */
+          gtk_widget_queue_resize (toplevel);
+        }
+    }
+}
+
 static void
 update_color_scheme (TerminalScreen *screen)
 {
@@ -1162,7 +1191,6 @@ update_color_scheme (TerminalScreen *screen)
   GdkRGBA *cursor_bgp = NULL, *cursor_fgp = NULL;
   GdkRGBA *highlight_bgp = NULL, *highlight_fgp = NULL;
   GtkStyleContext *context;
-  GtkWidget *toplevel;
   gboolean transparent;
   gboolean use_theme_colors;
 
@@ -1227,9 +1255,7 @@ update_color_scheme (TerminalScreen *screen)
   vte_terminal_set_color_highlight (VTE_TERMINAL (screen), highlight_bgp);
   vte_terminal_set_color_highlight_foreground (VTE_TERMINAL (screen), highlight_fgp);
 
-  toplevel = gtk_widget_get_toplevel (GTK_WIDGET (screen));
-  if (toplevel != NULL && gtk_widget_is_toplevel (toplevel))
-    gtk_widget_set_app_paintable (toplevel, transparent);
+  update_toplevel_transparency (screen);
 }
 
 static void
@@ -1748,6 +1774,13 @@ terminal_screen_do_popup (TerminalScreen *screen,
   terminal_screen_popup_info_unref (info);
 }
 
+static void
+terminal_screen_hierarchy_changed (GtkWidget *widget,
+                                   GtkWidget *previous_toplevel)
+{
+  update_toplevel_transparency (TERMINAL_SCREEN (widget));
+}
+
 static gboolean
 terminal_screen_button_press (GtkWidget      *widget,
                               GdkEventButton *event)
diff --git a/src/terminal-window.c b/src/terminal-window.c
index 36d155a9e420..c0219d872725 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -1959,15 +1959,21 @@ terminal_window_draw (GtkWidget *widget,
 {
   if (gtk_widget_get_app_paintable (widget))
     {
+      GtkAllocation child_allocation;
       GtkStyleContext *context;
-      int width;
-      int height;
+      GtkWidget *child;
+
+      /* Get the *child* allocation, so we don't overwrite window borders */
+      child = gtk_bin_get_child (GTK_BIN (widget));
+      gtk_widget_get_allocation (child, &child_allocation);
 
       context = gtk_widget_get_style_context (widget);
-      width = gtk_widget_get_allocated_width (widget);
-      height = gtk_widget_get_allocated_height (widget);
-      gtk_render_background (context, cr, 0, 0, width, height);
-      gtk_render_frame (context, cr, 0, 0, width, height);
+      gtk_render_background (context, cr,
+                             child_allocation.x, child_allocation.y,
+                             child_allocation.width, child_allocation.height);
+      gtk_render_frame (context, cr,
+                        child_allocation.x, child_allocation.y,
+                        child_allocation.width, child_allocation.height);
     }
 
   return GTK_WIDGET_CLASS (terminal_window_parent_class)->draw (widget, cr);
-- 
2.25.4


From de1231cf68fbe55ab7b7b2c4660091bfb05ec493 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Fri, 18 May 2018 20:15:34 +0200
Subject: [PATCH 04/16] screen: Try harder to find a foreground process group
 member

For pipelined commands, it's possible that the process group leader,
whose PID is used as the group ID, has terminated but not the entire
group. eg., $ cat <file> | less.  Sadly, there's no nice user-space
API to list the members of a group, and crawling the entire /proc like
pgrep might be overkill if the system is overloaded.

Therefore, the next 20 PIDs after the group ID and the first 20 PIDs
starting from 2 are checked in the hope that one of them would belong
to the foreground process group.

Subsequent commits will use this to track the current foreground
process, instead of using the shell's history, to notify when a
long-running foreground process group terminates.

https://bugzilla.gnome.org/show_bug.cgi?id=711059
---
 src/terminal-screen.c | 30 +++++++++++++++++++++++++++++-
 1 file changed, 29 insertions(+), 1 deletion(-)

diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index a1c3161391da..e2545c3f9288 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -2334,7 +2334,35 @@ terminal_screen_has_foreground_process (TerminalScreen *screen,
 #else
   g_snprintf (filename, sizeof (filename), "/proc/%d/cmdline", fgpid);
   if (!g_file_get_contents (filename, &data_buf, &len, NULL))
-    return TRUE;
+    {
+      int j;
+
+      for (j = 0; j < 20; j++)
+        {
+          pid_t pgid;
+          pid_t pid;
+
+          pid = (pid_t) (fgpid + 1 + j);
+          pgid = getpgid (pid);
+          if (pgid != fgpid)
+            {
+              pid = (pid_t) (2 + j);
+              pgid = getpgid (pid);
+              if (pgid != fgpid)
+                continue;
+            }
+
+          g_snprintf (filename, sizeof (filename), "/proc/%d/cmdline", (int) pid);
+
+          g_clear_pointer (&data_buf, g_free);
+          if (g_file_get_contents (filename, &data_buf, &len, NULL))
+            break;
+        }
+
+      if (j == 20)
+        return TRUE;
+    }
+
   data = data_buf;
 #endif
 
-- 
2.25.4


From b4a8b69b27a26f95371a1780ad61e97529cb8f90 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 3 May 2018 16:49:28 +0200
Subject: [PATCH 05/16] screen: Track the current foreground process

... using the interactive shell's precmd and preexec hooks, by
monitoring the contents of the terminal, and a combination of
tcgetpgrp(3) and /proc, instead of relying on the shell's history.

The shell's history cannot be reliably used to find out the current
foreground process. The history can be optionally turned off, and when
job control is in play, it will mistakenly record 'fg' as the current
process.

https://bugzilla.gnome.org/show_bug.cgi?id=711059
---
 src/terminal-debug.c  |   1 +
 src/terminal-debug.h  |   3 +-
 src/terminal-screen.c | 148 ++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 151 insertions(+), 1 deletion(-)

diff --git a/src/terminal-debug.c b/src/terminal-debug.c
index d08829e93ff4..6d325b5aee9d 100644
--- a/src/terminal-debug.c
+++ b/src/terminal-debug.c
@@ -38,6 +38,7 @@ _terminal_debug_init(void)
     { "profile",       TERMINAL_DEBUG_PROFILE       },
     { "settings-list", TERMINAL_DEBUG_SETTINGS_LIST },
     { "search",        TERMINAL_DEBUG_SEARCH        },
+    { "shell-command", TERMINAL_DEBUG_SHELL_COMMAND },
   };
 
   _terminal_debug_flags = g_parse_debug_string (g_getenv ("GNOME_TERMINAL_DEBUG"),
diff --git a/src/terminal-debug.h b/src/terminal-debug.h
index 0fafcc3a846c..b0f2fc9df7f6 100644
--- a/src/terminal-debug.h
+++ b/src/terminal-debug.h
@@ -34,7 +34,8 @@ typedef enum {
   TERMINAL_DEBUG_PROCESSES     = 1 << 6,
   TERMINAL_DEBUG_PROFILE       = 1 << 7,
   TERMINAL_DEBUG_SETTINGS_LIST = 1 << 8,
-  TERMINAL_DEBUG_SEARCH        = 1 << 9
+  TERMINAL_DEBUG_SEARCH        = 1 << 9,
+  TERMINAL_DEBUG_SHELL_COMMAND = 1 << 10,
 } TerminalDebugFlags;
 
 void _terminal_debug_init(void);
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index e2545c3f9288..57ea1cce26d5 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -107,6 +107,11 @@ struct _TerminalScreenPrivate
   gboolean exec_on_realize;
   guint idle_exec_source;
   ExecData *exec_data;
+
+  gboolean between_preexec_and_precmd;
+  char *current_cmdline;
+  guint contents_changed_source_id;
+  guint shell_preexec_source_id;
 };
 
 enum
@@ -156,6 +161,12 @@ static void terminal_screen_hierarchy_changed (GtkWidget *widget,
 static void terminal_screen_child_exited  (VteTerminal *terminal,
                                            int status);
 
+static void terminal_screen_contents_changed (VteTerminal *terminal);
+
+static void terminal_screen_shell_precmd (VteTerminal *terminal);
+
+static void terminal_screen_shell_preexec (VteTerminal *terminal);
+
 static void terminal_screen_window_title_changed      (VteTerminal *vte_terminal,
                                                        TerminalScreen *screen);
 
@@ -625,6 +636,9 @@ terminal_screen_class_init (TerminalScreenClass *klass)
   widget_class->hierarchy_changed = terminal_screen_hierarchy_changed;
 
   terminal_class->child_exited = terminal_screen_child_exited;
+  terminal_class->contents_changed = terminal_screen_contents_changed;
+  terminal_class->shell_precmd = terminal_screen_shell_precmd;
+  terminal_class->shell_preexec = terminal_screen_shell_preexec;
 
   signals[PROFILE_SET] =
     g_signal_new (I_("profile-set"),
@@ -724,6 +738,18 @@ terminal_screen_dispose (GObject *object)
                                         0, 0, NULL, NULL,
                                         screen);
 
+  if (priv->contents_changed_source_id != 0)
+    {
+      g_source_remove (priv->contents_changed_source_id);
+      priv->contents_changed_source_id = 0;
+    }
+
+  if (priv->shell_preexec_source_id != 0)
+    {
+      g_source_remove (priv->shell_preexec_source_id);
+      priv->shell_preexec_source_id = 0;
+    }
+
   if (priv->idle_exec_source != 0)
     {
       g_source_remove (priv->idle_exec_source);
@@ -760,6 +786,7 @@ terminal_screen_finalize (GObject *object)
   g_slist_free_full (priv->match_tags, (GDestroyNotify) free_tag_data);
 
   g_free (priv->uuid);
+  g_free (priv->current_cmdline);
 
   G_OBJECT_CLASS (terminal_screen_parent_class)->finalize (object);
 }
@@ -1959,6 +1986,123 @@ terminal_screen_child_exited (VteTerminal *terminal,
     }
 }
 
+static gboolean
+terminal_screen_contents_changed_cb (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  gs_free char *cmdline = NULL;
+
+  g_return_val_if_fail (priv->between_preexec_and_precmd, G_SOURCE_REMOVE);
+  g_return_val_if_fail (priv->shell_preexec_source_id == 0, G_SOURCE_REMOVE);
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Contents changed [timeout]\n");
+
+  if (!terminal_screen_has_foreground_process (screen, NULL, &cmdline))
+    goto out;
+
+  if (g_strcmp0 (priv->current_cmdline, cmdline) == 0)
+    goto out;
+
+  g_free (priv->current_cmdline);
+  priv->current_cmdline = g_steal_pointer (&cmdline);
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: %s\n", priv->current_cmdline);
+
+ out:
+  priv->contents_changed_source_id = 0;
+  return G_SOURCE_REMOVE;
+}
+
+static void
+terminal_screen_contents_changed (VteTerminal *terminal)
+{
+  TerminalScreen *screen = TERMINAL_SCREEN (terminal);
+  TerminalScreenPrivate *priv = screen->priv;
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Contents changed\n");
+
+  if (!priv->between_preexec_and_precmd)
+    return;
+
+  if (priv->shell_preexec_source_id != 0)
+    return;
+
+  if (priv->contents_changed_source_id != 0)
+    return;
+
+  priv->contents_changed_source_id = g_timeout_add (500,
+                                                    (GSourceFunc) terminal_screen_contents_changed_cb,
+                                                    screen);
+}
+
+static void
+terminal_screen_shell_precmd (VteTerminal *terminal)
+{
+  TerminalScreen *screen = TERMINAL_SCREEN (terminal);
+  TerminalScreenPrivate *priv = screen->priv;
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Shell precmd\n");
+
+  priv->between_preexec_and_precmd = FALSE;
+
+  if (priv->contents_changed_source_id != 0)
+    {
+      g_source_remove (priv->contents_changed_source_id);
+      priv->contents_changed_source_id = 0;
+    }
+
+  if (priv->shell_preexec_source_id != 0)
+    {
+      g_source_remove (priv->shell_preexec_source_id);
+      priv->shell_preexec_source_id = 0;
+    }
+
+  g_clear_pointer (&priv->current_cmdline, g_free);
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: (none)\n");
+}
+
+static gboolean
+terminal_screen_shell_preexec_cb (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  gboolean retval = G_SOURCE_CONTINUE;
+  gs_free char *cmdline = NULL;
+
+  g_return_val_if_fail (priv->between_preexec_and_precmd, G_SOURCE_REMOVE);
+  g_return_val_if_fail (priv->current_cmdline == NULL, G_SOURCE_REMOVE);
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Shell preexec [timeout]\n");
+
+  if (!terminal_screen_has_foreground_process (screen, NULL, &cmdline))
+    goto out;
+
+  priv->current_cmdline = g_steal_pointer (&cmdline);
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: %s\n", priv->current_cmdline);
+
+  priv->shell_preexec_source_id = 0;
+  retval = G_SOURCE_REMOVE;
+
+ out:
+  return retval;
+}
+
+static void
+terminal_screen_shell_preexec (VteTerminal *terminal)
+{
+  TerminalScreen *screen = TERMINAL_SCREEN (terminal);
+  TerminalScreenPrivate *priv = screen->priv;
+
+  g_return_if_fail (!priv->between_preexec_and_precmd);
+  g_return_if_fail (priv->contents_changed_source_id == 0);
+  g_return_if_fail (priv->current_cmdline == NULL);
+  g_return_if_fail (priv->shell_preexec_source_id == 0);
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Shell preexec\n");
+
+  priv->between_preexec_and_precmd = TRUE;
+
+  priv->shell_preexec_source_id = g_timeout_add (200, (GSourceFunc) terminal_screen_shell_preexec_cb, screen);
+}
+
 static void
 terminal_screen_drag_data_received (GtkWidget        *widget,
                                     GdkDragContext   *context,
@@ -2303,7 +2447,11 @@ terminal_screen_has_foreground_process (TerminalScreen *screen,
   if (fd == -1)
     return FALSE;
 
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Child PID: %d\n", priv->child_pid);
+
   fgpid = tcgetpgrp (fd);
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground process group [tcgetpgrp]: %d\n", fgpid);
+
   if (fgpid == -1 || fgpid == priv->child_pid)
     return FALSE;
 
-- 
2.25.4


From 3e7242e41500b5a7c85133dc15a0b290cd67d861 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 10 May 2018 19:23:16 +0200
Subject: [PATCH 06/16] Notify when a long-running foreground process group
 terminates

Notifications are only sent if the VteTerminal in which the process
was running doesn't have the keyboard focus. If it's a tab in the
currently active window then the dialog-information-symbolic icon is
used to highlight the tab's label; otherwise a desktop-wide
notification is sent.

https://bugzilla.gnome.org/show_bug.cgi?id=711059
---
 src/terminal-app.c       |  32 ++++++++++++
 src/terminal-screen.c    | 109 +++++++++++++++++++++++++++++++++++++++
 src/terminal-tab-label.c |  30 ++++++++++-
 src/terminal-tab-label.h |   4 ++
 4 files changed, 174 insertions(+), 1 deletion(-)

diff --git a/src/terminal-app.c b/src/terminal-app.c
index 6a4fe03f2756..4e70facf9a43 100644
--- a/src/terminal-app.c
+++ b/src/terminal-app.c
@@ -730,6 +730,31 @@ app_menu_quit_cb (GSimpleAction *action,
     gtk_widget_destroy (GTK_WIDGET (window));
 }
 
+/* Other action callbacks */
+
+static void
+action_activate_tab_cb (GSimpleAction *action,
+                        GVariant      *parameter,
+                        gpointer       user_data)
+{
+  GtkApplication *application = user_data;
+  GtkWidget *toplevel;
+  TerminalScreen *screen;
+  const char *uuid;
+
+  g_variant_get (parameter, "&s", &uuid);
+  screen = terminal_app_get_screen_by_uuid (TERMINAL_APP (application), uuid);
+  if (screen == NULL)
+    return;
+
+  toplevel = gtk_widget_get_toplevel (GTK_WIDGET (screen));
+  if (!gtk_widget_is_toplevel (toplevel))
+    return;
+
+  terminal_window_switch_screen (TERMINAL_WINDOW (toplevel), screen);
+  gtk_window_present (GTK_WINDOW (toplevel));
+}
+
 /* Class implementation */
 
 G_DEFINE_TYPE (TerminalApp, terminal_app, GTK_TYPE_APPLICATION)
@@ -753,6 +778,10 @@ terminal_app_startup (GApplication *application)
     { "quit",        app_menu_quit_cb,          NULL, NULL, NULL }
   };
 
+  const GActionEntry other_actions[] = {
+    { "activate-tab",   action_activate_tab_cb, "s",  NULL, NULL }
+  };
+
   g_application_set_resource_base_path (application, TERMINAL_RESOURCES_PATH_PREFIX);
 
   G_APPLICATION_CLASS (terminal_app_parent_class)->startup (application);
@@ -763,6 +792,9 @@ terminal_app_startup (GApplication *application)
   g_action_map_add_action_entries (G_ACTION_MAP (application),
                                    action_entries, G_N_ELEMENTS (action_entries),
                                    application);
+  g_action_map_add_action_entries (G_ACTION_MAP (application),
+                                   other_actions, G_N_ELEMENTS (other_actions),
+                                   application);
 
   app_load_css (application);
 
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 57ea1cce26d5..d25b36597396 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -54,6 +54,7 @@
 #include "terminal-marshal.h"
 #include "terminal-schemas.h"
 #include "terminal-screen-container.h"
+#include "terminal-tab-label.h"
 #include "terminal-util.h"
 #include "terminal-window.h"
 #include "terminal-info-bar.h"
@@ -156,6 +157,10 @@ static void terminal_screen_system_font_changed_cb (GSettings *,
 static gboolean terminal_screen_popup_menu (GtkWidget *widget);
 static gboolean terminal_screen_button_press (GtkWidget *widget,
                                               GdkEventButton *event);
+
+static gboolean terminal_screen_focus_in (GtkWidget *widget,
+                                          GdkEventFocus *event);
+
 static void terminal_screen_hierarchy_changed (GtkWidget *widget,
                                                GtkWidget *previous_toplevel);
 static void terminal_screen_child_exited  (VteTerminal *terminal,
@@ -628,6 +633,7 @@ terminal_screen_class_init (TerminalScreenClass *klass)
   object_class->get_property = terminal_screen_get_property;
   object_class->set_property = terminal_screen_set_property;
 
+  widget_class->focus_in_event = terminal_screen_focus_in;
   widget_class->realize = terminal_screen_realize;
   widget_class->style_updated = terminal_screen_style_updated;
   widget_class->drag_data_received = terminal_screen_drag_data_received;
@@ -727,6 +733,10 @@ terminal_screen_dispose (GObject *object)
   TerminalScreen *screen = TERMINAL_SCREEN (object);
   TerminalScreenPrivate *priv = screen->priv;
   GtkSettings *settings;
+  TerminalApp *app;
+
+  app = terminal_app_get ();
+  g_application_withdraw_notification (G_APPLICATION (app), priv->uuid);
 
   /* Unset child PID so that when an eventual child-exited signal arrives,
    * we don't emit "close".
@@ -1890,6 +1900,45 @@ terminal_screen_button_press (GtkWidget      *widget,
   return FALSE;
 }
 
+static gboolean
+terminal_screen_focus_in (GtkWidget     *widget,
+                          GdkEventFocus *event)
+{
+  TerminalScreen *screen = TERMINAL_SCREEN (widget);
+  TerminalApp *app;
+  TerminalWindow *window;
+
+  _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Notification withdrawn\n");
+
+  window = terminal_screen_get_window (screen);
+  if (window != NULL)
+    {
+      TerminalScreenContainer *screen_container;
+
+      screen_container = terminal_screen_container_get_from_screen (screen);
+      if (screen_container != NULL)
+        {
+          GtkWidget *mdi_container;
+
+          mdi_container = terminal_window_get_mdi_container (window);
+          /* FIXME: add interface method to retrieve tab label */
+          if (GTK_IS_NOTEBOOK (mdi_container))
+            {
+              GtkWidget *tab_label;
+
+              tab_label = gtk_notebook_get_tab_label (GTK_NOTEBOOK (mdi_container), GTK_WIDGET (screen_container));
+              terminal_tab_label_set_bold (TERMINAL_TAB_LABEL (tab_label), FALSE);
+              terminal_tab_label_set_icon (TERMINAL_TAB_LABEL (tab_label), NULL, NULL);
+            }
+        }
+    }
+
+  app = terminal_app_get ();
+  g_application_withdraw_notification (G_APPLICATION (app), screen->priv->uuid);
+
+  return GTK_WIDGET_CLASS (terminal_screen_parent_class)->focus_in_event (widget, event);
+}
+
 /**
  * terminal_screen_get_current_dir:
  * @screen:
@@ -2034,6 +2083,63 @@ terminal_screen_contents_changed (VteTerminal *terminal)
                                                     screen);
 }
 
+static void
+terminal_screen_show_notification (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  TerminalWindow *window;
+
+  window = terminal_screen_get_window (screen);
+  if (window == NULL)
+    return;
+
+  if (gtk_window_is_active (GTK_WINDOW (window)))
+    {
+      GtkWidget *mdi_container;
+      TerminalScreenContainer *screen_container;
+
+      if (screen == terminal_window_get_active (window))
+        return;
+
+      screen_container = terminal_screen_container_get_from_screen (screen);
+      if (screen_container == NULL)
+        return;
+
+      mdi_container = terminal_window_get_mdi_container (window);
+      /* FIXME: add interface method to retrieve tab label */
+      if (GTK_IS_NOTEBOOK (mdi_container))
+        {
+          GtkWidget *tab_label;
+
+          tab_label = gtk_notebook_get_tab_label (GTK_NOTEBOOK (mdi_container), GTK_WIDGET (screen_container));
+          terminal_tab_label_set_bold (TERMINAL_TAB_LABEL (tab_label), TRUE);
+          terminal_tab_label_set_icon (TERMINAL_TAB_LABEL (tab_label),
+                                       "dialog-information-symbolic",
+                                       _("Command completed"));
+          _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Notify tab\n");
+        }
+    }
+  else
+    {
+      gs_unref_object GNotification *notification = NULL;
+      TerminalApp *app;
+      gs_free char *current_cmdline_valid = NULL;
+      gs_free char *detailed_action = NULL;
+
+      notification = g_notification_new (_("Command completed"));
+
+      current_cmdline_valid = g_utf8_make_valid (priv->current_cmdline, -1);
+      g_notification_set_body (notification, current_cmdline_valid);
+
+      detailed_action = g_strdup_printf ("app.activate-tab::%s", priv->uuid);
+      g_notification_set_default_action (notification, detailed_action);
+
+      app = terminal_app_get ();
+      g_application_send_notification (G_APPLICATION (app), priv->uuid, notification);
+      _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Notify desktop\n");
+    }
+}
+
 static void
 terminal_screen_shell_precmd (VteTerminal *terminal)
 {
@@ -2056,6 +2162,9 @@ terminal_screen_shell_precmd (VteTerminal *terminal)
       priv->shell_preexec_source_id = 0;
     }
 
+  if (priv->current_cmdline != NULL)
+    terminal_screen_show_notification (screen);
+
   g_clear_pointer (&priv->current_cmdline, g_free);
   _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: (none)\n");
 }
diff --git a/src/terminal-tab-label.c b/src/terminal-tab-label.c
index 7b4b0849ad8d..4fd0af13484a 100644
--- a/src/terminal-tab-label.c
+++ b/src/terminal-tab-label.c
@@ -34,6 +34,7 @@
 struct _TerminalTabLabelPrivate
 {
   TerminalScreen *screen;
+  GtkWidget *icon;
   GtkWidget *label;
   GtkWidget *close_button;
   gboolean bold;
@@ -179,7 +180,7 @@ terminal_tab_label_constructed (GObject *object)
 {
   TerminalTabLabel *tab_label = TERMINAL_TAB_LABEL (object);
   TerminalTabLabelPrivate *priv = tab_label->priv;
-  GtkWidget *hbox, *label, *close_button;
+  GtkWidget *hbox, *icon, *label, *close_button;
 
   G_OBJECT_CLASS (terminal_tab_label_parent_class)->constructed (object);
 
@@ -189,6 +190,10 @@ terminal_tab_label_constructed (GObject *object)
   
   gtk_box_set_spacing (GTK_BOX (hbox), SPACING);
 
+  priv->icon = icon = gtk_image_new ();
+  gtk_widget_set_no_show_all (icon, TRUE);
+  gtk_box_pack_start (GTK_BOX (hbox), icon, FALSE, FALSE, 0);
+
   priv->label = label = gtk_label_new (NULL);
   gtk_widget_set_halign (label, GTK_ALIGN_CENTER);
   gtk_widget_set_valign (label, GTK_ALIGN_BASELINE);
@@ -376,6 +381,29 @@ terminal_tab_label_set_bold (TerminalTabLabel *tab_label,
     pango_attr_list_unref (attr_list);
 }
 
+/**
+ * terminal_tab_label_set_icon:
+ * @tab_label: a #TerminalTabLabel
+ * @icon_name: (allow-none): an icon name
+ * @tooltip: (allow-none): text to be used as tooltip
+ *
+ * Shows an icon at the beginning of @tab_label. If @icon_name is
+ * %NULL, then the icon will be hidden.
+ */
+void
+terminal_tab_label_set_icon (TerminalTabLabel *tab_label,
+                             const char *icon_name,
+                             const char *tooltip)
+{
+  TerminalTabLabelPrivate *priv = tab_label->priv;
+
+  g_return_if_fail (TERMINAL_IS_TAB_LABEL (tab_label));
+
+  gtk_widget_set_visible (priv->icon, icon_name != NULL);
+  gtk_image_set_from_icon_name (GTK_IMAGE (priv->icon), icon_name, GTK_ICON_SIZE_MENU);
+  gtk_widget_set_tooltip_text (GTK_WIDGET (priv->icon), tooltip);
+}
+
 /**
  * terminal_tab_label_get_screen:
  * @tab_label: a #TerminalTabLabel
diff --git a/src/terminal-tab-label.h b/src/terminal-tab-label.h
index 20cfbceb36b0..a987025e0524 100644
--- a/src/terminal-tab-label.h
+++ b/src/terminal-tab-label.h
@@ -59,6 +59,10 @@ GtkWidget *     terminal_tab_label_new        (TerminalScreen *screen);
 void            terminal_tab_label_set_bold   (TerminalTabLabel *tab_label,
                                                gboolean bold);
 
+void            terminal_tab_label_set_icon   (TerminalTabLabel *tab_label,
+                                               const char *icon_name,
+                                               const char *tooltip);
+
 TerminalScreen *terminal_tab_label_get_screen (TerminalTabLabel *tab_label);
 
 G_END_DECLS
-- 
2.25.4


From a6dbcf9b15ae96829c5a1c20e2901c722457b3c6 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Tue, 10 Apr 2018 15:39:35 +0200
Subject: [PATCH 07/16] profile: Split the Command tab into two nested GtkGrids

This will let the subsequent patch add a "Command" sub-heading to keep
the command settings separate from the to-be-restored title settings.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/preferences.ui | 239 +++++++++++++++++++++++----------------------
 1 file changed, 123 insertions(+), 116 deletions(-)

diff --git a/src/preferences.ui b/src/preferences.ui
index 64f8295bf2b0..426993a4e154 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -1965,130 +1965,137 @@
                             <property name="visible">True</property>
                             <property name="can_focus">False</property>
                             <property name="border_width">12</property>
-                            <property name="column_spacing">12</property>
-                            <property name="row_spacing">6</property>
-                            <child>
-                              <object class="GtkCheckButton" id="login-shell-checkbutton">
-                                <property name="label" translatable="yes">_Run command as a login shell</property>
-                                <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="receives_default">False</property>
-                                <property name="use_underline">True</property>
-                                <property name="draw_indicator">True</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">0</property>
-                                <property name="left_attach">0</property>
-                                <property name="width">2</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkCheckButton" id="use-custom-command-checkbutton">
-                                <property name="label" translatable="yes">Ru_n a custom command instead of my shell</property>
-                                <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="receives_default">False</property>
-                                <property name="use_underline">True</property>
-                                <property name="draw_indicator">True</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">1</property>
-                                <property name="left_attach">0</property>
-                                <property name="width">2</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkLabel" id="custom-command-entry-label">
-                                <property name="visible">True</property>
-                                <property name="can_focus">False</property>
-                                <property name="label" translatable="yes">Custom co_mmand:</property>
-                                <property name="use_underline">True</property>
-                                <property name="mnemonic_widget">custom-command-entry</property>
-                                <property name="xalign">0</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">2</property>
-                                <property name="left_attach">0</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkEntry" id="custom-command-entry">
-                                <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="hexpand">True</property>
-                                <property name="input_hints">GTK_INPUT_HINT_NO_EMOJI</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">2</property>
-                                <property name="left_attach">1</property>
-                              </packing>
-                            </child>
+                            <property name="row_spacing">18</property>
                             <child>
-                              <object class="GtkLabel" id="preserve-working-directory-checkbutton-label">
+                              <object class="GtkGrid">
                                 <property name="visible">True</property>
                                 <property name="can_focus">False</property>
-                                <property name="label" translatable="yes">_Preserve working directory:</property>
-                                <property name="use_underline">True</property>
-                                <property name="justify">center</property>
-                                <property name="mnemonic_widget">preserve-working-directory-combobox</property>
-                                <property name="xalign">0</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">3</property>
-                                <property name="left_attach">0</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkComboBox" id="preserve-working-directory-combobox">
-                                <property name="visible">True</property>
-                                <property name="can_focus">False</property>
-                                <property name="model">preserve-working-directory-model</property>
-                                <property name="focus_on_click">False</property>
-                                <property name="halign">start</property>
+                                <property name="column_spacing">12</property>
+                                <property name="row_spacing">6</property>
                                 <child>
-                                  <object class="GtkCellRendererText" id="preserve-working-directory-renderer"/>
-                                  <attributes>
-                                    <attribute name="text">0</attribute>
-                                  </attributes>
+                                  <object class="GtkCheckButton" id="login-shell-checkbutton">
+                                    <property name="label" translatable="yes">_Run command as a login shell</property>
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="receives_default">False</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="draw_indicator">True</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">0</property>
+                                    <property name="left_attach">0</property>
+                                    <property name="width">2</property>
+                                  </packing>
                                 </child>
-                              </object>
-                              <packing>
-                                <property name="top_attach">3</property>
-                                <property name="left_attach">1</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkLabel" id="exit-action-combobox-label">
-                                <property name="visible">True</property>
-                                <property name="can_focus">False</property>
-                                <property name="label" translatable="yes">When command _exits:</property>
-                                <property name="use_underline">True</property>
-                                <property name="mnemonic_widget">exit-action-combobox</property>
-                                <property name="xalign">0</property>
-                              </object>
-                              <packing>
-                                <property name="top_attach">4</property>
-                                <property name="left_attach">0</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <object class="GtkComboBox" id="exit-action-combobox">
-                                <property name="visible">True</property>
-                                <property name="can_focus">False</property>
-                                <property name="model">model3</property>
-                                <property name="focus_on_click">False</property>
-                                <property name="halign">start</property>
                                 <child>
-                                  <object class="GtkCellRendererText" id="renderer3"/>
-                                  <attributes>
-                                    <attribute name="text">0</attribute>
-                                  </attributes>
+                                  <object class="GtkCheckButton" id="use-custom-command-checkbutton">
+                                    <property name="label" translatable="yes">Ru_n a custom command instead of my shell</property>
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="receives_default">False</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="draw_indicator">True</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">1</property>
+                                    <property name="left_attach">0</property>
+                                    <property name="width">2</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkLabel" id="custom-command-entry-label">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="label" translatable="yes">Custom co_mmand:</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="mnemonic_widget">custom-command-entry</property>
+                                    <property name="xalign">0</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">2</property>
+                                    <property name="left_attach">0</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkEntry" id="custom-command-entry">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="hexpand">True</property>
+                                    <property name="input_hints">GTK_INPUT_HINT_NO_EMOJI</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">2</property>
+                                    <property name="left_attach">1</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkLabel" id="preserve-working-directory-checkbutton-label">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="label" translatable="yes">_Preserve working directory:</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="justify">center</property>
+                                    <property name="mnemonic_widget">preserve-working-directory-combobox</property>
+                                    <property name="xalign">0</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">3</property>
+                                    <property name="left_attach">0</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkComboBox" id="preserve-working-directory-combobox">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="model">preserve-working-directory-model</property>
+                                    <property name="focus_on_click">False</property>
+                                    <property name="halign">start</property>
+                                    <child>
+                                      <object class="GtkCellRendererText" id="preserve-working-directory-renderer"/>
+                                      <attributes>
+                                        <attribute name="text">0</attribute>
+                                      </attributes>
+                                    </child>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">3</property>
+                                    <property name="left_attach">1</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkLabel" id="exit-action-combobox-label">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="label" translatable="yes">When command _exits:</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="mnemonic_widget">exit-action-combobox</property>
+                                    <property name="xalign">0</property>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">4</property>
+                                    <property name="left_attach">0</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkComboBox" id="exit-action-combobox">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="model">model3</property>
+                                    <property name="focus_on_click">False</property>
+                                    <property name="halign">start</property>
+                                    <child>
+                                      <object class="GtkCellRendererText" id="renderer3"/>
+                                      <attributes>
+                                        <attribute name="text">0</attribute>
+                                      </attributes>
+                                    </child>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">4</property>
+                                    <property name="left_attach">1</property>
+                                  </packing>
                                 </child>
                               </object>
-                              <packing>
-                                <property name="top_attach">4</property>
-                                <property name="left_attach">1</property>
-                              </packing>
                             </child>
                           </object>
                           <packing>
-- 
2.25.4


From 528ffc16192fbd45fdb709a0c58dd5f51ab524e9 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Tue, 10 Apr 2018 16:01:51 +0200
Subject: [PATCH 08/16] Revert "profile: Remove the "Command" sub-heading"

This reverts commit 8e27479299d075df0a52d0e8e7baeab344dcaa6c.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/preferences.ui | 247 ++++++++++++++++++++++++++-------------------
 1 file changed, 143 insertions(+), 104 deletions(-)

diff --git a/src/preferences.ui b/src/preferences.ui
index 426993a4e154..7f4a94c88b6b 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -1973,129 +1973,168 @@
                                 <property name="column_spacing">12</property>
                                 <property name="row_spacing">6</property>
                                 <child>
-                                  <object class="GtkCheckButton" id="login-shell-checkbutton">
-                                    <property name="label" translatable="yes">_Run command as a login shell</property>
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="receives_default">False</property>
-                                    <property name="use_underline">True</property>
-                                    <property name="draw_indicator">True</property>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">0</property>
-                                    <property name="left_attach">0</property>
-                                    <property name="width">2</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkCheckButton" id="use-custom-command-checkbutton">
-                                    <property name="label" translatable="yes">Ru_n a custom command instead of my shell</property>
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="receives_default">False</property>
-                                    <property name="use_underline">True</property>
-                                    <property name="draw_indicator">True</property>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">1</property>
-                                    <property name="left_attach">0</property>
-                                    <property name="width">2</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkLabel" id="custom-command-entry-label">
+                                  <object class="GtkLabel">
                                     <property name="visible">True</property>
                                     <property name="can_focus">False</property>
-                                    <property name="label" translatable="yes">Custom co_mmand:</property>
-                                    <property name="use_underline">True</property>
-                                    <property name="mnemonic_widget">custom-command-entry</property>
-                                    <property name="xalign">0</property>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">2</property>
-                                    <property name="left_attach">0</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkEntry" id="custom-command-entry">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="hexpand">True</property>
-                                    <property name="input_hints">GTK_INPUT_HINT_NO_EMOJI</property>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">2</property>
-                                    <property name="left_attach">1</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkLabel" id="preserve-working-directory-checkbutton-label">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">False</property>
-                                    <property name="label" translatable="yes">_Preserve working directory:</property>
-                                    <property name="use_underline">True</property>
-                                    <property name="justify">center</property>
-                                    <property name="mnemonic_widget">preserve-working-directory-combobox</property>
                                     <property name="xalign">0</property>
+                                    <property name="label" translatable="yes">Command</property>
+                                    <attributes>
+                                      <attribute name="weight" value="bold"/>
+                                    </attributes>
                                   </object>
                                   <packing>
-                                    <property name="top_attach">3</property>
+                                    <property name="top_attach">0</property>
                                     <property name="left_attach">0</property>
                                   </packing>
                                 </child>
                                 <child>
-                                  <object class="GtkComboBox" id="preserve-working-directory-combobox">
+                                  <object class="GtkAlignment">
                                     <property name="visible">True</property>
                                     <property name="can_focus">False</property>
-                                    <property name="model">preserve-working-directory-model</property>
-                                    <property name="focus_on_click">False</property>
-                                    <property name="halign">start</property>
+                                    <property name="left_padding">12</property>
                                     <child>
-                                      <object class="GtkCellRendererText" id="preserve-working-directory-renderer"/>
-                                      <attributes>
-                                        <attribute name="text">0</attribute>
-                                      </attributes>
+                                      <object class="GtkGrid">
+                                        <property name="visible">True</property>
+                                        <property name="can_focus">False</property>
+                                        <property name="column_spacing">12</property>
+                                        <property name="row_spacing">6</property>
+                                        <child>
+                                          <object class="GtkCheckButton" id="login-shell-checkbutton">
+                                            <property name="label" translatable="yes">_Run command as a login shell</property>
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">True</property>
+                                            <property name="receives_default">False</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="draw_indicator">True</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">0</property>
+                                            <property name="left_attach">0</property>
+                                            <property name="width">2</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkCheckButton" id="use-custom-command-checkbutton">
+                                            <property name="label" translatable="yes">Ru_n a custom command instead of my shell</property>
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">True</property>
+                                            <property name="receives_default">False</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="draw_indicator">True</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">1</property>
+                                            <property name="left_attach">0</property>
+                                            <property name="width">2</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkLabel" id="custom-command-entry-label">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="label" translatable="yes">Custom co_mmand:</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="mnemonic_widget">custom-command-entry</property>
+                                            <property name="xalign">0</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">2</property>
+                                            <property name="left_attach">0</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkEntry" id="custom-command-entry">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">True</property>
+                                            <property name="hexpand">True</property>
+                                            <property name="input_hints">GTK_INPUT_HINT_NO_EMOJI</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">2</property>
+                                            <property name="left_attach">1</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkLabel" id="preserve-working-directory-checkbutton-label">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="label" translatable="yes">_Preserve working directory:</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="justify">center</property>
+                                            <property name="mnemonic_widget">preserve-working-directory-combobox</property>
+                                            <property name="xalign">0</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">3</property>
+                                            <property name="left_attach">0</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkComboBox" id="preserve-working-directory-combobox">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="model">preserve-working-directory-model</property>
+                                            <property name="focus_on_click">False</property>
+                                            <property name="halign">start</property>
+                                            <child>
+                                              <object class="GtkCellRendererText" id="preserve-working-directory-renderer"/>
+                                              <attributes>
+                                                <attribute name="text">0</attribute>
+                                              </attributes>
+                                            </child>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">3</property>
+                                            <property name="left_attach">1</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkLabel" id="exit-action-combobox-label">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="label" translatable="yes">When command _exits:</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="mnemonic_widget">exit-action-combobox</property>
+                                            <property name="xalign">0</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">4</property>
+                                            <property name="left_attach">0</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkComboBox" id="exit-action-combobox">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="model">model3</property>
+                                            <property name="focus_on_click">False</property>
+                                            <property name="halign">start</property>
+                                            <child>
+                                              <object class="GtkCellRendererText" id="renderer3"/>
+                                              <attributes>
+                                                <attribute name="text">0</attribute>
+                                              </attributes>
+                                            </child>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">4</property>
+                                            <property name="left_attach">1</property>
+                                          </packing>
+                                        </child>
+                                      </object>
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="top_attach">3</property>
-                                    <property name="left_attach">1</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkLabel" id="exit-action-combobox-label">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">False</property>
-                                    <property name="label" translatable="yes">When command _exits:</property>
-                                    <property name="use_underline">True</property>
-                                    <property name="mnemonic_widget">exit-action-combobox</property>
-                                    <property name="xalign">0</property>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">4</property>
+                                    <property name="top_attach">1</property>
                                     <property name="left_attach">0</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <object class="GtkComboBox" id="exit-action-combobox">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">False</property>
-                                    <property name="model">model3</property>
-                                    <property name="focus_on_click">False</property>
-                                    <property name="halign">start</property>
-                                    <child>
-                                      <object class="GtkCellRendererText" id="renderer3"/>
-                                      <attributes>
-                                        <attribute name="text">0</attribute>
-                                      </attributes>
-                                    </child>
-                                  </object>
-                                  <packing>
-                                    <property name="top_attach">4</property>
-                                    <property name="left_attach">1</property>
+                                    <property name="width">3</property>
                                   </packing>
                                 </child>
                               </object>
+                              <packing>
+                                <property name="top_attach">1</property>
+                                <property name="left_attach">0</property>
+                              </packing>
                             </child>
                           </object>
                           <packing>
-- 
2.25.4


From c95d6adef9b1c1c447249a44eb56750b321000e0 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 30 Jun 2016 16:02:13 +0200
Subject: [PATCH 09/16] Revert "screen: Remove unused description and
 user_title API"

This reverts commit 3bb41272b7509a16ec2a5cd93e44f73d5743b626.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/terminal-screen.c | 63 +++++++++++++++++++++++++++++++++++++++++++
 src/terminal-screen.h |  5 ++++
 2 files changed, 68 insertions(+)

diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index d25b36597396..91c76df3feea 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -111,6 +111,7 @@ struct _TerminalScreenPrivate
 
   gboolean between_preexec_and_precmd;
   char *current_cmdline;
+  char *title;
   guint contents_changed_source_id;
   guint shell_preexec_source_id;
 };
@@ -128,6 +129,7 @@ enum {
   PROP_0,
   PROP_PROFILE,
   PROP_TITLE,
+  PROP_DESCRIPTION
 };
 
 enum
@@ -592,6 +594,9 @@ terminal_screen_get_property (GObject *object,
       case PROP_TITLE:
         g_value_set_string (value, terminal_screen_get_title (screen));
         break;
+      case PROP_DESCRIPTION:
+        g_value_take_string (value, terminal_screen_get_description (screen));
+        break;
       default:
         G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
         break;
@@ -612,6 +617,7 @@ terminal_screen_set_property (GObject *object,
         terminal_screen_set_profile (screen, g_value_get_object (value));
         break;
       case PROP_TITLE:
+      case PROP_DESCRIPTION:
         /* not writable */
       default:
         G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
@@ -701,6 +707,13 @@ terminal_screen_class_init (TerminalScreenClass *klass)
                           NULL,
                           G_PARAM_READABLE | G_PARAM_STATIC_NAME | G_PARAM_STATIC_NICK | G_PARAM_STATIC_BLURB));
 
+  g_object_class_install_property (object_class,
+                                   PROP_DESCRIPTION,
+                                   g_param_spec_string ("description", NULL, NULL,
+                                                        NULL,
+                                                        G_PARAM_READABLE |
+                                                        G_PARAM_STATIC_STRINGS));
+
   g_type_class_add_private (object_class, sizeof (TerminalScreenPrivate));
 
   n_url_regexes = G_N_ELEMENTS (url_regex_patterns);
@@ -797,6 +810,7 @@ terminal_screen_finalize (GObject *object)
 
   g_free (priv->uuid);
   g_free (priv->current_cmdline);
+  g_free (priv->title);
 
   G_OBJECT_CLASS (terminal_screen_parent_class)->finalize (object);
 }
@@ -1056,6 +1070,21 @@ terminal_screen_get_title (TerminalScreen *screen)
   return vte_terminal_get_window_title (VTE_TERMINAL (screen));
 }
 
+char *
+terminal_screen_get_description (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  const char *title;
+
+  /* use --title argument if one was supplied, otherwise ask the profile */
+  if (priv->title)
+    title = priv->title;
+
+  return g_strdup_printf ("%s  %d",
+                          title && title[0] ? title : _("Terminal"),
+                          screen->priv->child_pid);
+}
+
 static void
 terminal_screen_profile_changed_cb (GSettings     *profile,
                                     const char    *prop_name,
@@ -1384,6 +1413,7 @@ terminal_screen_set_profile (TerminalScreen *screen,
     g_object_unref (old_profile);
 
   g_object_notify (G_OBJECT (screen), "profile");
+  g_object_notify (G_OBJECT (screen), "description");
 }
 
 GSettings*
@@ -1655,6 +1685,8 @@ spawn_result_cb (VteTerminal *terminal,
 
   priv->child_pid = pid;
 
+  g_object_notify (G_OBJECT (screen), "description");
+
   if (error) {
      // FIXMEchpe should be unnecessary, vte already does this internally
     vte_terminal_set_pty (terminal, NULL);
@@ -1939,6 +1971,35 @@ terminal_screen_focus_in (GtkWidget     *widget,
   return GTK_WIDGET_CLASS (terminal_screen_parent_class)->focus_in_event (widget, event);
 }
 
+void
+terminal_screen_set_user_title (TerminalScreen *screen,
+                                const char     *title)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+
+  g_return_if_fail (TERMINAL_IS_SCREEN (screen));
+
+  if (g_strcmp0 (priv->title, title) == 0)
+    return;
+
+  g_free (priv->title);
+  priv->title = title && title[0] ? g_strdup (title) : NULL;
+
+  g_object_notify (G_OBJECT (screen), "description");
+}
+
+const char*
+terminal_screen_get_user_title (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv;
+
+  g_return_val_if_fail (TERMINAL_IS_SCREEN (screen), NULL);
+
+  priv = screen->priv;
+
+  return priv->title ? priv->title : _("Terminal");
+}
+
 /**
  * terminal_screen_get_current_dir:
  * @screen:
@@ -1992,6 +2053,8 @@ terminal_screen_child_exited (VteTerminal *terminal,
 
   priv->child_pid = -1;
 
+  g_object_notify (G_OBJECT (screen), "description");
+
   action = g_settings_get_enum (priv->profile, TERMINAL_PROFILE_EXIT_ACTION_KEY);
 
   switch (action)
diff --git a/src/terminal-screen.h b/src/terminal-screen.h
index 8ea337867222..049bbe5a2b8b 100644
--- a/src/terminal-screen.h
+++ b/src/terminal-screen.h
@@ -113,7 +113,12 @@ void terminal_screen_set_profile (TerminalScreen *screen,
 GSettings* terminal_screen_get_profile (TerminalScreen *screen);
 GSettings* terminal_screen_ref_profile (TerminalScreen *screen);
 
+const char *terminal_screen_get_user_title     (TerminalScreen *screen);
 const char* terminal_screen_get_title          (TerminalScreen *screen);
+char *      terminal_screen_get_description    (TerminalScreen *screen);
+
+void terminal_screen_set_user_title (TerminalScreen *screen,
+                                     const char *text);
 
 char *terminal_screen_get_current_dir (TerminalScreen *screen);
 
-- 
2.25.4


From 9c755aefcb53d63da73214a911ab75dd4fe6b7e2 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 30 Jun 2016 17:39:48 +0200
Subject: [PATCH 10/16] Revert "Remove the static title setting from profile
 preferences"

This reverts commit e9cb8fea14a849704074c5d69f173bcf4dc2fb27.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/org.gnome.Terminal.gschema.xml |  5 +++
 src/preferences.ui                 | 71 ++++++++++++++++++++++++++++++
 src/profile-editor.c               |  5 +++
 src/terminal-schemas.h             |  1 +
 src/terminal-screen.c              |  9 ++++
 5 files changed, 91 insertions(+)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index 7b04919202b7..1c458a9fb9ec 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -209,6 +209,11 @@
       <summary>Whether to enable SIXEL images</summary>
       <description>If true, SIXEL sequences are parsed and images are rendered.</description>
     </key>
+    <key name="title" type="s">
+      <default l10n="messages" context="title">'Terminal'</default>
+      <summary>Title for terminal</summary>
+      <description>Title to display for the terminal window or tab. This title may be replaced by or combined with the title set by the application inside the terminal, depending on the title_mode setting.</description>
+    </key>
     <key name="bold-is-bright" type="b">
       <default>false</default>
       <summary>Whether bold is also bright</summary>
diff --git a/src/preferences.ui b/src/preferences.ui
index 7f4a94c88b6b..f86f8c980f89 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -1966,6 +1966,77 @@
                             <property name="can_focus">False</property>
                             <property name="border_width">12</property>
                             <property name="row_spacing">18</property>
+                            <child>
+                              <object class="GtkGrid">
+                                <property name="visible">True</property>
+                                <property name="can_focus">False</property>
+                                <property name="row_spacing">6</property>
+                                <child>
+                                  <object class="GtkLabel">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="xalign">0</property>
+                                    <property name="label" translatable="yes">Title</property>
+                                    <attributes>
+                                      <attribute name="weight" value="bold"/>
+                                    </attributes>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">0</property>
+                                    <property name="left_attach">0</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <object class="GtkAlignment">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">False</property>
+                                    <property name="left_padding">12</property>
+                                    <child>
+                                      <object class="GtkGrid">
+                                        <property name="visible">True</property>
+                                        <property name="can_focus">False</property>
+                                        <property name="column_spacing">12</property>
+                                        <property name="row_spacing">6</property>
+                                        <child>
+                                          <object class="GtkLabel" id="title-entry-label">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="xalign">0</property>
+                                            <property name="label" translatable="yes">Title:</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="mnemonic_widget">title-entry</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">0</property>
+                                            <property name="left_attach">0</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkEntry" id="title-entry">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">True</property>
+                                            <property name="hexpand">True</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">0</property>
+                                            <property name="left_attach">1</property>
+                                          </packing>
+                                        </child>
+                                      </object>
+                                    </child>
+                                  </object>
+                                  <packing>
+                                    <property name="top_attach">1</property>
+                                    <property name="left_attach">0</property>
+                                    <property name="width">3</property>
+                                  </packing>
+                                </child>
+                              </object>
+                              <packing>
+                                <property name="top_attach">0</property>
+                                <property name="left_attach">0</property>
+                              </packing>
+                            </child>
                             <child>
                               <object class="GtkGrid">
                                 <property name="visible">True</property>
diff --git a/src/profile-editor.c b/src/profile-editor.c
index 35bd24791417..df1f219608c4 100644
--- a/src/profile-editor.c
+++ b/src/profile-editor.c
@@ -1368,6 +1368,11 @@ profile_prefs_load (const char *uuid, GSettings *profile)
                                             (GSettingsBindSetMapping) enum_to_string,
                                             terminal_preserve_working_directory_get_type, NULL);
 
+  profile_prefs_settings_bind (profile,
+                               TERMINAL_PROFILE_TITLE_KEY,
+                               gtk_builder_get_object (builder, "title-entry"),
+                               "text",
+                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
   profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_CUSTOM_COMMAND_KEY,
                                gtk_builder_get_object (builder,
                                                        "use-custom-command-checkbutton"),
diff --git a/src/terminal-schemas.h b/src/terminal-schemas.h
index 6bfd3e346895..cbb59a2301e6 100644
--- a/src/terminal-schemas.h
+++ b/src/terminal-schemas.h
@@ -69,6 +69,7 @@ G_BEGIN_DECLS
 #define TERMINAL_PROFILE_SCROLL_ON_KEYSTROKE_KEY        "scroll-on-keystroke"
 #define TERMINAL_PROFILE_SCROLL_ON_OUTPUT_KEY           "scroll-on-output"
 #define TERMINAL_PROFILE_TEXT_BLINK_MODE_KEY            "text-blink-mode"
+#define TERMINAL_PROFILE_TITLE_KEY                      "title"
 #define TERMINAL_PROFILE_USE_CUSTOM_COMMAND_KEY         "use-custom-command"
 #define TERMINAL_PROFILE_USE_SKEY_KEY                   "use-skey"
 #define TERMINAL_PROFILE_USE_SYSTEM_FONT_KEY            "use-system-font"
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 91c76df3feea..7724af0dfa04 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -1074,11 +1074,14 @@ char *
 terminal_screen_get_description (TerminalScreen *screen)
 {
   TerminalScreenPrivate *priv = screen->priv;
+  gs_free char *title_string = NULL;
   const char *title;
 
   /* use --title argument if one was supplied, otherwise ask the profile */
   if (priv->title)
     title = priv->title;
+  else
+    title = title_string = g_settings_get_string (priv->profile, TERMINAL_PROFILE_TITLE_KEY);
 
   return g_strdup_printf ("%s  %d",
                           title && title[0] ? title : _("Terminal"),
@@ -1124,6 +1127,12 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       vte_terminal_set_cjk_ambiguous_width (vte_terminal, (int) width);
     }
 
+  if (!prop_name ||
+      prop_name == I_(TERMINAL_PROFILE_TITLE_KEY))
+    {
+      g_object_notify (object, "description");
+    }
+
   if (gtk_widget_get_realized (GTK_WIDGET (screen)) &&
       (!prop_name ||
        prop_name == I_(TERMINAL_PROFILE_USE_SYSTEM_FONT_KEY) ||
-- 
2.25.4


From f0e0ecdab4c22e7e1f44b5da9a6618c6563c5f5b Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Tue, 17 Feb 2015 17:06:17 +0100
Subject: [PATCH 11/16] Restore translations for setting a title and
 transparency

---
 po/am.po          |  8 ++++----
 po/an.po          | 12 ++++++------
 po/ar.po          | 16 ++++++++--------
 po/as.po          | 16 ++++++++--------
 po/ast.po         |  8 ++++----
 po/az.po          |  8 ++++----
 po/be.po          |  3 +++
 po/be@latin.po    |  8 ++++----
 po/bg.po          |  9 +++++++++
 po/bn.po          |  8 ++++----
 po/bn_IN.po       | 11 +++++++----
 po/br.po          |  6 +++---
 po/bs.po          | 10 ++++++++++
 po/ca.po          | 12 ++++++++++++
 po/ca@valencia.po | 12 ++++++++++++
 po/cs.po          | 12 ++++++++++++
 po/cy.po          |  8 ++++----
 po/da.po          | 12 ++++++++++++
 po/de.po          | 12 ++++++++++++
 po/dz.po          |  8 ++++----
 po/el.po          | 15 +++++++++------
 po/en@shaw.po     |  8 ++++----
 po/en_CA.po       |  8 ++++----
 po/en_GB.po       | 16 ++++++++--------
 po/eo.po          |  8 ++++----
 po/es.po          | 16 ++++++++--------
 po/et.po          |  3 +++
 po/eu.po          | 12 ++++++++++++
 po/fa.po          | 15 +++++++++------
 po/fi.po          | 12 ++++++++++++
 po/fr.po          | 12 ++++++++++++
 po/fur.po         | 11 +++++++++--
 po/ga.po          |  3 +++
 po/gl.po          | 12 ++++++++++++
 po/gu.po          | 16 ++++++++--------
 po/he.po          | 16 ++++++++--------
 po/hi.po          | 17 ++++++++---------
 po/hr.po          | 10 ++++++++++
 po/hu.po          | 12 ++++++++++++
 po/hy.po          |  8 ++++----
 po/id.po          | 12 ++++++++++++
 po/it.po          | 12 ++++++++++++
 po/ja.po          | 12 ++++++++++++
 po/ka.po          |  6 +++---
 po/kk.po          | 12 ++++++++++++
 po/km.po          |  4 ++--
 po/kn.po          | 15 +++++++++------
 po/ko.po          | 12 ++++++++++++
 po/ku.po          |  8 ++++----
 po/lt.po          | 12 ++++++++++++
 po/lv.po          | 16 ++++++++++++++++
 po/mai.po         |  8 ++++----
 po/mg.po          |  8 ++++----
 po/mk.po          |  8 ++++----
 po/ml.po          |  3 +++
 po/mn.po          |  8 ++++----
 po/mr.po          | 16 ++++++++--------
 po/ms.po          |  4 ++--
 po/nb.po          | 12 ++++++++++++
 po/nds.po         |  8 ++++----
 po/ne.po          | 12 ++++++------
 po/nl.po          | 12 ++++++++++++
 po/nn.po          |  8 ++++----
 po/oc.po          | 12 ++++++------
 po/or.po          |  4 ++--
 po/pa.po          | 23 +++++++++++------------
 po/ps.po          |  8 ++++----
 po/pt.po          | 16 ++++++++--------
 po/pt_BR.po       | 15 +++++++++------
 po/ro.po          |  4 ++--
 po/ru.po          | 16 ++++++++++++++++
 po/rw.po          |  3 +--
 po/si.po          |  8 ++++----
 po/sk.po          | 12 ++++++++++++
 po/sl.po          | 15 +++++++++------
 po/sq.po          |  8 ++++----
 po/sr.po          | 22 ++++++++++++----------
 po/sr@latin.po    | 22 ++++++++++++----------
 po/sv.po          | 12 ++++++++++++
 po/ta.po          | 27 +++++++++++++--------------
 po/te.po          | 27 +++++++++++++--------------
 po/tg.po          | 16 ++++++++--------
 po/th.po          | 20 ++++++++++----------
 po/tr.po          | 12 ++++++++++++
 po/ug.po          |  4 ++--
 po/uk.po          | 15 +++++++++++++++
 po/vi.po          | 15 +++++++++------
 po/wa.po          | 12 ++++++------
 po/xh.po          | 12 ++++++------
 po/zh_CN.po       | 15 +++++++++------
 po/zh_HK.po       | 15 +++++++++------
 po/zh_TW.po       | 15 +++++++++------
 92 files changed, 719 insertions(+), 343 deletions(-)

diff --git a/po/am.po b/po/am.po
index 3445d96da657..ee992f0712a5 100644
--- a/po/am.po
+++ b/po/am.po
@@ -214,8 +214,8 @@ msgid "<b>Background</b>"
 msgstr "<b></b>"
 
 #: ../src/gnome-terminal.glade2.h:2
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/gnome-terminal.glade2.h:3
 msgid "<b>Compatibility</b>"
@@ -614,8 +614,8 @@ msgid "_Text color:"
 msgstr "_ "
 
 #: ../src/gnome-terminal.glade2.h:102
-msgid "_Transparent background"
-msgstr "_ "
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/gnome-terminal.glade2.h:103
 msgid "_Update login records when command is launched"
diff --git a/po/an.po b/po/an.po
index fcec2668aa11..9e07cb682c57 100644
--- a/po/an.po
+++ b/po/an.po
@@ -2241,8 +2241,8 @@ msgstr "_Zarrar a finestra"
 #~ msgid "Use custom default terminal si_ze"
 #~ msgstr "Emplegar grandaria predeterminada presonali_zada de terminal"
 
-#~ msgid "Title"
-#~ msgstr "Titol"
+msgid "Title"
+msgstr "Titol"
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr ""
@@ -2266,8 +2266,8 @@ msgstr "_Zarrar a finestra"
 #~ msgid "Close Window"
 #~ msgstr "Zarrar a finestra"
 
-#~ msgid "Set Title"
-#~ msgstr "Establir titol"
+msgid "Set Title"
+msgstr "Establir titol"
 
 #~ msgid "Switch to Tab 2"
 #~ msgstr "Cambiar a la pestanya 2"
@@ -2340,8 +2340,8 @@ msgstr "_Zarrar a finestra"
 #~ msgid "_Input Methods"
 #~ msgstr "Me_todos de dentrada"
 
-#~ msgid "_Title:"
-#~ msgstr "_Titol:"
+msgid "_Title:"
+msgstr "_Titol:"
 
 #~ msgid "Keyboard Shortcuts"
 #~ msgstr "Alcorces de teclau"
diff --git a/po/ar.po b/po/ar.po
index fac62fd10680..f77804d8aec4 100644
--- a/po/ar.po
+++ b/po/ar.po
@@ -2574,11 +2574,11 @@ msgstr "_ "
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr " "
@@ -2586,8 +2586,8 @@ msgstr "_ "
 #~ msgid "_Unlimited"
 #~ msgstr "_ "
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
@@ -3330,8 +3330,8 @@ msgstr "_ "
 #~ msgid "Background image _scrolls"
 #~ msgstr "  _"
 
-#~ msgid "_Transparent background"
-#~ msgstr " _"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "_    :"
diff --git a/po/as.po b/po/as.po
index 3fade2b8cb12..5b905340f89f 100644
--- a/po/as.po
+++ b/po/as.po
@@ -2163,11 +2163,11 @@ msgstr "   (_l)"
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr " (_T):"
+msgid "_Title:"
+msgstr " (_T):"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
@@ -2175,8 +2175,8 @@ msgstr "   (_l)"
 #~ msgid "_Unlimited"
 #~ msgstr " (_U)"
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
@@ -2979,8 +2979,8 @@ msgstr "   (_l)"
 #~ msgid "Background image _scrolls"
 #~ msgstr "    (_s)"
 
-#~ msgid "_Transparent background"
-#~ msgstr "  (_T)"
+msgid "Transparent background"
+msgstr "  "
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "        (_h):"
diff --git a/po/ast.po b/po/ast.po
index d1c6e7b8174a..4dc0892ed9c4 100644
--- a/po/ast.po
+++ b/po/ast.po
@@ -1304,8 +1304,8 @@ msgid "_Base on:"
 msgstr "_Basu en:"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Comandu</b>"
+msgid "Command"
+msgstr "Comandu"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground, Background, Bold and Underline</b>"
@@ -1598,8 +1598,8 @@ msgid "_Text color:"
 msgstr "Color del _testu:"
 
 #: ../src/profile-preferences.glade.h:77
-msgid "_Transparent background"
-msgstr "Fondu _tresparente"
+msgid "Transparent background"
+msgstr "Fondu tresparente"
 
 #: ../src/profile-preferences.glade.h:78
 msgid "_Underline color:"
diff --git a/po/az.po b/po/az.po
index 586c1e4d827b..4bd846797101 100644
--- a/po/az.po
+++ b/po/az.po
@@ -218,8 +218,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Arxa plan</b>"
 
 #: ../src/gnome-terminal.glade2.h:2
-msgid "<b>Command</b>"
-msgstr "<b>mr</b>"
+msgid "Command"
+msgstr "mr"
 
 #: ../src/gnome-terminal.glade2.h:3
 msgid "<b>Compatibility</b>"
@@ -620,8 +620,8 @@ msgid "_Text color:"
 msgstr "_Mtn rngi:"
 
 #: ../src/gnome-terminal.glade2.h:102
-msgid "_Transparent background"
-msgstr "_ffaf arxa plan"
+msgid "Transparent background"
+msgstr "ffaf arxa plan"
 
 #: ../src/gnome-terminal.glade2.h:103
 msgid "_Update login records when command is launched"
diff --git a/po/be.po b/po/be.po
index 298ec2d6ae0c..50f46093a712 100644
--- a/po/be.po
+++ b/po/be.po
@@ -2635,3 +2635,6 @@ msgstr "_ "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/be@latin.po b/po/be@latin.po
index 82ef0664ae1e..27e9877f96e8 100644
--- a/po/be@latin.po
+++ b/po/be@latin.po
@@ -1146,8 +1146,8 @@ msgid "_Base on:"
 msgstr "Na _bazie:"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Zahad</b>"
+msgid "Command"
+msgstr "Zahad"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1426,8 +1426,8 @@ msgid "_Text color:"
 msgstr "Koler _tekstu:"
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
-msgstr "_Prazrysty fon"
+msgid "Transparent background"
+msgstr "Prazrysty fon"
 
 #: ../src/profile-preferences.glade.h:74
 msgid "_Update login records when command is launched"
diff --git a/po/bg.po b/po/bg.po
index 9a4f32e4b135..6ac17c17efb8 100644
--- a/po/bg.po
+++ b/po/bg.po
@@ -2305,3 +2305,12 @@ msgstr ""
 #: ../src/terminal-window.c:3953
 msgid "C_lose Window"
 msgstr "_   "
+
+msgid "Transparent background"
+msgstr " "
+
+msgid "_Title:"
+msgstr "_:"
+
+msgid "Set Title"
+msgstr "  "
diff --git a/po/bn.po b/po/bn.po
index 4906009cf46f..f97d43b0e515 100644
--- a/po/bn.po
+++ b/po/bn.po
@@ -1217,8 +1217,8 @@ msgid "_Base on:"
 msgstr "    : (_B)"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground, Background, and Bold</b>"
@@ -1524,8 +1524,8 @@ msgid "_Text color:"
 msgstr " : (_T)"
 
 #: ../src/profile-preferences.glade.h:76
-msgid "_Transparent background"
-msgstr "  (_T)"
+msgid "Transparent background"
+msgstr "  "
 
 #: ../src/profile-preferences.glade.h:77
 msgid "_Unlimited"
diff --git a/po/bn_IN.po b/po/bn_IN.po
index f196e5084797..0ac3caf77e73 100644
--- a/po/bn_IN.po
+++ b/po/bn_IN.po
@@ -2296,8 +2296,8 @@ msgstr "   (_l)"
 #~ msgid "Close Window"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Switch to Tab 2"
 #~ msgstr " -  "
@@ -2356,5 +2356,8 @@ msgstr "   (_l)"
 #~ msgid "_Input Methods"
 #~ msgstr "  (_I)"
 
-#~ msgid "_Title:"
-#~ msgstr ": (_T)"
+msgid "_Title:"
+msgstr ": (_T)"
+
+msgid "Transparent background"
+msgstr "  "
diff --git a/po/br.po b/po/br.po
index e16ea07dfc21..f4cbe857d5ca 100644
--- a/po/br.po
+++ b/po/br.po
@@ -958,8 +958,8 @@ msgid "_Base on:"
 msgstr ""
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Arc'had</b>"
+msgid "Command"
+msgstr "Arc'had"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1211,7 +1211,7 @@ msgid "_Text color:"
 msgstr "Liv an destenn :"
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
+msgid "Transparent background"
 msgstr ""
 
 #: ../src/profile-preferences.glade.h:74
diff --git a/po/bs.po b/po/bs.po
index 49e710859ac9..8703552984b1 100644
--- a/po/bs.po
+++ b/po/bs.po
@@ -680,6 +680,10 @@ msgstr "Kratica tastature za poveavanje fonta"
 msgid "Keyboard shortcut to make font smaller"
 msgstr "Kratica tastature za smanjivanje fonta"
 
+#: ../src/gnome-terminal.glade2.h:102
+msgid "Transparent background"
+msgstr "Providna pozadina"
+
 #: ../src/org.gnome.Terminal.gschema.xml.h:78
 msgid "Keyboard shortcut to make font normal-size"
 msgstr "Kratica tastature za postavljanje fonta na normalnu veliinu"
@@ -2054,3 +2058,9 @@ msgstr ""
 #: ../src/terminal-window.c:3652
 msgid "C_lose Window"
 msgstr "_Zatvori prozor"
+
+msgid "_Title:"
+msgstr "_Naslov:"
+
+msgid "Set Title"
+msgstr "Postavi naslov"
diff --git a/po/ca.po b/po/ca.po
index d203c31406ea..a1d47c69679d 100644
--- a/po/ca.po
+++ b/po/ca.po
@@ -2490,3 +2490,15 @@ msgstr "Tanca la _finestra"
 
 #~ msgid "_Detach Tab"
 #~ msgstr "_Separa la pestanya"
+
+msgid "Transparent background"
+msgstr "Fons transparent"
+
+msgid "Title"
+msgstr "Ttol"
+
+msgid "_Title:"
+msgstr "Tt_ol:"
+
+msgid "Set Title"
+msgstr "Estableix el ttol"
diff --git a/po/ca@valencia.po b/po/ca@valencia.po
index a6e8fb4250dc..c9ed8508228d 100644
--- a/po/ca@valencia.po
+++ b/po/ca@valencia.po
@@ -2357,3 +2357,15 @@ msgstr "Tanca la _finestra"
 
 #~ msgid "Whether to use a dark theme variant"
 #~ msgstr "Si s'ha d'utilitzar la variant de tema fosc"
+
+msgid "Transparent background"
+msgstr "Fons transparent"
+
+msgid "Title"
+msgstr "Ttol"
+
+msgid "_Title:"
+msgstr "Tt_ol:"
+
+msgid "Set Title"
+msgstr "Estableix el ttol"
diff --git a/po/cs.po b/po/cs.po
index f0cf6b424ae0..873c127e0f84 100644
--- a/po/cs.po
+++ b/po/cs.po
@@ -2422,3 +2422,15 @@ msgstr ""
 #: src/terminal-window.c:3224
 msgid "C_lose Window"
 msgstr "_Zavt okno"
+
+msgid "Transparent background"
+msgstr "Prsvitn pozad"
+
+msgid "Title"
+msgstr "Zhlav"
+
+msgid "_Title:"
+msgstr "Z_hlav:"
+
+msgid "Set Title"
+msgstr "Nastavit zhlav"
diff --git a/po/cy.po b/po/cy.po
index 644df82363f1..cd862feb50c0 100644
--- a/po/cy.po
+++ b/po/cy.po
@@ -1167,8 +1167,8 @@ msgid "_Base on:"
 msgstr "Ei _seilio ar:"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Gorchymyn</b>"
+msgid "Command"
+msgstr "Gorchymyn"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1448,8 +1448,8 @@ msgid "_Text color:"
 msgstr "Lliw'r _testun:"
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
-msgstr "Cefndir _tryloyw"
+msgid "Transparent background"
+msgstr "Cefndir tryloyw"
 
 #: ../src/profile-preferences.glade.h:74
 msgid "_Update login records when command is launched"
diff --git a/po/da.po b/po/da.po
index eb21daa279ef..edebccb48e90 100644
--- a/po/da.po
+++ b/po/da.po
@@ -2459,3 +2459,15 @@ msgstr "_Luk vindue"
 
 #~ msgid "_Detach Tab"
 #~ msgstr "_Lsriv faneblad"
+
+msgid "Title"
+msgstr "Titel"
+
+msgid "_Title:"
+msgstr "_Titel:"
+
+msgid "Set Title"
+msgstr "St titel"
+
+msgid "Transparent background"
+msgstr "Gennemsigtig baggrund"
diff --git a/po/de.po b/po/de.po
index c123573f0cf1..6e40b82edea4 100644
--- a/po/de.po
+++ b/po/de.po
@@ -2538,3 +2538,15 @@ msgstr "Fenster _schlieen"
 
 #~ msgid "_Quit"
 #~ msgstr "_Beenden"
+
+msgid "Title"
+msgstr "Titel"
+
+msgid "_Title:"
+msgstr "_Titel:"
+
+msgid "Set Title"
+msgstr "Titel festlegen"
+
+msgid "Transparent background"
+msgstr "Transparenter Hintergrund"
diff --git a/po/dz.po b/po/dz.po
index d97e6102b850..a768fe4adc54 100644
--- a/po/dz.po
+++ b/po/dz.po
@@ -1255,8 +1255,8 @@ msgid "_Base on:"
 msgstr ":(_B)"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 #, fuzzy
@@ -1551,8 +1551,8 @@ msgid "_Text color:"
 msgstr ":(_T)"
 
 #: ../src/profile-preferences.glade.h:77
-msgid "_Transparent background"
-msgstr "(_T)"
+msgid "Transparent background"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:78
 #, fuzzy
diff --git a/po/el.po b/po/el.po
index 3e44ba5d24f6..f93ecb561ef4 100644
--- a/po/el.po
+++ b/po/el.po
@@ -2888,17 +2888,17 @@ msgstr "_ "
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Current Locale"
 #~ msgstr "  "
@@ -2936,3 +2936,6 @@ msgstr "_ "
 
 #~ msgid "_Input Methods"
 #~ msgstr "_ "
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/en@shaw.po b/po/en@shaw.po
index 5bdb39250e53..6fb8a7e1c3bb 100644
--- a/po/en@shaw.po
+++ b/po/en@shaw.po
@@ -1212,8 +1212,8 @@ msgid "_Base on:"
 msgstr "_ :"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground, Background, Bold and Underline</b>"
@@ -1468,8 +1468,8 @@ msgid "_Text color:"
 msgstr "_ :"
 
 #: ../src/profile-preferences.glade.h:78
-msgid "_Transparent background"
-msgstr "_ "
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/profile-preferences.glade.h:79
 msgid "_Underline color:"
diff --git a/po/en_CA.po b/po/en_CA.po
index 6c9e0cd73d63..db4aa891dd45 100644
--- a/po/en_CA.po
+++ b/po/en_CA.po
@@ -219,8 +219,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Background</b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b>Command</b>"
+msgid "Command"
+msgstr "Command"
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -557,8 +557,8 @@ msgid "_Text color:"
 msgstr "_Text colour:"
 
 #: ../src/gnome-terminal.glade2.h:86
-msgid "_Transparent background"
-msgstr "_Transparent background"
+msgid "Transparent background"
+msgstr "Transparent background"
 
 #: ../src/gnome-terminal.glade2.h:87
 msgid "_Update login records when command is launched"
diff --git a/po/en_GB.po b/po/en_GB.po
index d2542ff7db4a..dc3bdf23ca9e 100644
--- a/po/en_GB.po
+++ b/po/en_GB.po
@@ -2828,8 +2828,8 @@ msgstr "C_lose Window"
 #~ msgid "Default size:"
 #~ msgstr "Default size:"
 
-#~ msgid "Title"
-#~ msgstr "Title"
+msgid "Title"
+msgstr "Title"
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "When terminal commands set their o_wn titles:"
@@ -2846,8 +2846,8 @@ msgstr "C_lose Window"
 #~ msgid "_Unlimited"
 #~ msgstr "_Unlimited"
 
-#~ msgid "Set Title"
-#~ msgstr "Set Title"
+msgid "Set Title"
+msgstr "Set Title"
 
 #~ msgid "Switch to Tab 3"
 #~ msgstr "Switch to Tab 3"
@@ -2888,8 +2888,8 @@ msgstr "C_lose Window"
 #~ msgid "_Input Methods"
 #~ msgstr "_Input Methods"
 
-#~ msgid "_Title:"
-#~ msgstr "_Title:"
+msgid "_Title:"
+msgstr "_Title:"
 
 #~ msgid "Add or Remove Terminal Encodings"
 #~ msgstr "Add or Remove Terminal Encodings"
@@ -3584,8 +3584,8 @@ msgstr "C_lose Window"
 #~ msgid "Background image _scrolls"
 #~ msgstr "Background image _scrolls"
 
-#~ msgid "_Transparent background"
-#~ msgstr "_Transparent background"
+msgid "Transparent background"
+msgstr "Transparent background"
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "S_hade transparent or image background:"
diff --git a/po/eo.po b/po/eo.po
index 0e83b981753b..0d98ea57c90a 100644
--- a/po/eo.po
+++ b/po/eo.po
@@ -2827,8 +2827,8 @@ msgstr "_Fermi la fenestron"
 #~ msgid "_Font:"
 #~ msgstr "_Tiparo:"
 
-#~ msgid "Set Title"
-#~ msgstr "Agordi titolon"
+msgid "Set Title"
+msgstr "Agordi titolon"
 
 #~ msgid "Switch to Tab 3"
 #~ msgstr "alti al langeto 3"
@@ -2890,8 +2890,8 @@ msgstr "_Fermi la fenestron"
 #~ msgid "_Input Methods"
 #~ msgstr "_Enigmetodoj"
 
-#~ msgid "_Title:"
-#~ msgstr "_Titolo:"
+msgid "_Title:"
+msgstr "_Titolo:"
 
 #~ msgid "On the left side"
 #~ msgstr "Maldekstre"
diff --git a/po/es.po b/po/es.po
index 4a169d0d76ff..2a38bed154bf 100644
--- a/po/es.po
+++ b/po/es.po
@@ -2889,17 +2889,17 @@ msgstr "_Cerrar ventana"
 #~ msgid "Default size:"
 #~ msgstr "Tamao predeterminado:"
 
-#~ msgid "Title"
-#~ msgstr "Titulo"
+msgid "Title"
+msgstr "Titulo"
 
-#~ msgid "_Title:"
-#~ msgstr "_Ttulo:"
+msgid "_Title:"
+msgstr "_Ttulo:"
 
 #~ msgid "Title and Command"
 #~ msgstr "Ttulo y comando"
 
-#~ msgid "Set Title"
-#~ msgstr "Establecer ttulo"
+msgid "Set Title"
+msgstr "Establecer ttulo"
 
 #~ msgid "Current Locale"
 #~ msgstr "Configuracin regional actual"
@@ -3725,8 +3725,8 @@ msgstr "_Cerrar ventana"
 #~ msgid "_Solid color"
 #~ msgstr "Color _slido"
 
-#~ msgid "_Transparent background"
-#~ msgstr "Fondo _transparente"
+msgid "Transparent background"
+msgstr "Fondo transparente"
 
 #~ msgid "No such profile \"%s\", using default profile\n"
 #~ msgstr "No existe el perfil %s, usando el perfil predeterminado\n"
diff --git a/po/et.po b/po/et.po
index 4b1c2a7c67e4..770761168806 100644
--- a/po/et.po
+++ b/po/et.po
@@ -1747,3 +1747,6 @@ msgstr "Su_lge aken"
 
 #~ msgid "Choose base profile"
 #~ msgstr "Vali phiprofiil"
+
+msgid "Transparent background"
+msgstr "Lbipaistev taust"
diff --git a/po/eu.po b/po/eu.po
index eaf053b7395d..d657371ac667 100644
--- a/po/eu.po
+++ b/po/eu.po
@@ -2333,3 +2333,15 @@ msgstr "It_xi leihoa"
 
 #~ msgid "_Detach Tab"
 #~ msgstr "_Desuztartu fitxa"
+
+msgid "Title"
+msgstr "Titulua"
+
+msgid "_Title:"
+msgstr "_Titulua:"
+
+msgid "Set Title"
+msgstr "Ezarri titulua"
+
+msgid "Transparent background"
+msgstr "Atzeko plano gardena"
diff --git a/po/fa.po b/po/fa.po
index 320667da5c90..af24d78d8acc 100644
--- a/po/fa.po
+++ b/po/fa.po
@@ -2773,8 +2773,8 @@ msgstr "_ "
 #~ msgid "Use custom default terminal si_ze"
 #~ msgstr "   _  "
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "     _   :"
@@ -2788,8 +2788,8 @@ msgstr "_ "
 #~ msgid "_Unlimited"
 #~ msgstr "_"
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Switch to Tab 3"
 #~ msgstr "   "
@@ -2830,5 +2830,8 @@ msgstr "_ "
 #~ msgid "_Input Methods"
 #~ msgstr " _"
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/fi.po b/po/fi.po
index 72581abb7462..2b1efadccd42 100644
--- a/po/fi.po
+++ b/po/fi.po
@@ -2751,9 +2751,21 @@ msgstr "_Sulje ikkuna"
 #~ msgid "_Update login records when command is launched"
 #~ msgstr "_Pivit kirjautumistallenne kun komento kynnistetn"
 
+msgid "Transparent background"
+msgstr "Lpinkyv tausta"
+
 #~| msgid "Error parsing command: %s"
 #~ msgid "Missing command"
 #~ msgstr "Puuttuva komento"
 
 #~ msgid "Whether to use a dark theme variant"
 #~ msgstr "Kytetnk teeman tummaan muunnelmaa"
+
+msgid "Title"
+msgstr "Otsikko"
+
+msgid "_Title:"
+msgstr "_Otsikko:"
+
+msgid "Set Title"
+msgstr "Aseta otsikko"
diff --git a/po/fr.po b/po/fr.po
index 44bdeb2c7520..ba398e4f3c04 100644
--- a/po/fr.po
+++ b/po/fr.po
@@ -2513,3 +2513,15 @@ msgstr "Fermer _la fentre"
 
 #~ msgid "_Detach Tab"
 #~ msgstr "_Dtacher longlet"
+
+msgid "Transparent background"
+msgstr "Arrire-plan transparent"
+
+msgid "Title"
+msgstr "Titre"
+
+msgid "_Title:"
+msgstr "_Titre:"
+
+msgid "Set Title"
+msgstr "Dfinir le titre"
diff --git a/po/fur.po b/po/fur.po
index ced8f56677f7..c869f85f66ee 100644
--- a/po/fur.po
+++ b/po/fur.po
@@ -545,6 +545,10 @@ msgstr ""
 msgid "Which encoding to use"
 msgstr "Codifiche di dopr"
 
+#: ../src/gnome-terminal.glade2.h:86
+msgid "Transparent background"
+msgstr "Fondl trasparent"
+
 #: src/org.gnome.Terminal.gschema.xml:350
 msgid ""
 "Whether ambiguous-width characters are narrow or wide when using UTF-8 "
@@ -3546,6 +3550,9 @@ msgstr "_Siere barcon"
 #~ msgid "The text you clicked on doesn't seem to be a valid OTP challenge."
 #~ msgstr "Il test fract nol samee jessi un OTP challenge."
 
+msgid "Set Title"
+msgstr "Imposte titul"
+
 #~ msgid "Switch to Tab 3"
 #~ msgstr "Passe a la schede 3"
 
@@ -3601,8 +3608,8 @@ msgstr "_Siere barcon"
 #~ msgid "_Input Methods"
 #~ msgstr "_Cemt inser test"
 
-#~ msgid "_Title:"
-#~ msgstr "_Titul:"
+msgid "_Title:"
+msgstr "_Titul:"
 
 #~ msgid ""
 #~ "text/plain dropped on terminal had wrong format (%d) or length (%d)\n"
diff --git a/po/ga.po b/po/ga.po
index 93d5fa9d1481..feb87dce3d6b 100644
--- a/po/ga.po
+++ b/po/ga.po
@@ -1925,3 +1925,6 @@ msgstr "_Dn Fuinneog"
 #: ../src/terminal-window.c:3582
 msgid "C_lose Terminal"
 msgstr "_Dn Teirminal"
+
+msgid "Transparent background"
+msgstr "Clra trdhearcach"
diff --git a/po/gl.po b/po/gl.po
index d411ea4f1347..f8a48d82635c 100644
--- a/po/gl.po
+++ b/po/gl.po
@@ -2445,3 +2445,15 @@ msgstr ""
 #: src/terminal-window.c:3224
 msgid "C_lose Window"
 msgstr "P_echar a xanela"
+
+msgid "Title"
+msgstr "Ttulo"
+
+msgid "_Title:"
+msgstr "_Ttulo:"
+
+msgid "Set Title"
+msgstr "Definir o ttulo"
+
+msgid "Transparent background"
+msgstr "Fondo transparente"
diff --git a/po/gu.po b/po/gu.po
index 76b459cf8dc5..485beeac98b7 100644
--- a/po/gu.po
+++ b/po/gu.po
@@ -2155,8 +2155,8 @@ msgstr "   (_l)"
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "       (_w):"
@@ -2176,8 +2176,8 @@ msgstr "   (_l)"
 #~ msgid "Close Window"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "The shortcut key %s is already bound to the %s action"
 #~ msgstr "  %s    %s   "
@@ -2203,8 +2203,8 @@ msgstr "   (_l)"
 #~ msgid "_Input Methods"
 #~ msgstr "   (_I)"
 
-#~ msgid "_Title:"
-#~ msgstr " (_T):"
+msgid "_Title:"
+msgstr " (_T):"
 
 #~ msgid "Keyboard shortcut to switch to tab 1"
 #~ msgstr "      "
@@ -2944,8 +2944,8 @@ msgstr "   (_l)"
 #~ msgid "_Solid color"
 #~ msgstr "  (_S)"
 
-#~ msgid "_Transparent background"
-#~ msgstr "    (_T)"
+msgid "Transparent background"
+msgstr "   "
 
 #~ msgid "No such profile \"%s\", using default profile\n"
 #~ msgstr "\"%s\"    ,     \n"
diff --git a/po/he.po b/po/he.po
index ad00c9109e41..82fc3c9573e1 100644
--- a/po/he.po
+++ b/po/he.po
@@ -2769,17 +2769,17 @@ msgstr " _"
 #~ msgid "Default size:"
 #~ msgstr "  :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr " "
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
@@ -3591,8 +3591,8 @@ msgstr " _"
 #~ msgid "_Solid color"
 #~ msgstr " _"
 
-#~ msgid "_Transparent background"
-#~ msgstr " _"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "No such profile \"%s\", using default profile\n"
 #~ msgstr "No such profile \"%s\", using default profile\n"
diff --git a/po/hi.po b/po/hi.po
index 2d7dc5b14008..8d3d0529df61 100644
--- a/po/hi.po
+++ b/po/hi.po
@@ -2267,9 +2267,8 @@ msgstr "   (_l)"
 #~ msgid "Use custom default terminal si_ze"
 #~ msgstr "       (_z)"
 
-#~| msgid "_Title:"
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "         (_w):"
@@ -2289,8 +2288,8 @@ msgstr "   (_l)"
 #~ msgid "Close Window"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Switch to Tab 2"
 #~ msgstr " 2  "
@@ -2349,8 +2348,8 @@ msgstr "   (_l)"
 #~ msgid "_Input Methods"
 #~ msgstr "  (_I)"
 
-#~ msgid "_Title:"
-#~ msgstr " (_T):"
+msgid "_Title:"
+msgstr " (_T):"
 
 #~ msgid "Disable connection to session manager"
 #~ msgstr "     "
@@ -2979,8 +2978,8 @@ msgstr "   (_l)"
 #~ msgid "_Background image"
 #~ msgstr "  (_B)"
 
-#~ msgid "_Transparent background"
-#~ msgstr "  (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "S/Key Challenge Response"
 #~ msgstr "/  "
diff --git a/po/hr.po b/po/hr.po
index 8cb0df752f2f..d7f96a287470 100644
--- a/po/hr.po
+++ b/po/hr.po
@@ -2737,3 +2737,13 @@ msgstr "_Zatvori prozor"
 
 #~ msgid "Use transparency from system theme"
 #~ msgstr "Koristi prozirnost iz teme sustava"
+
+#: ../src/profile-preferences.glade.h:69
+msgid "Transparent background"
+msgstr "Prozirna pozadina"
+
+msgid "_Title:"
+msgstr "_Naslov:"
+
+msgid "Set Title"
+msgstr "Postavi naslov"
diff --git a/po/hu.po b/po/hu.po
index 9142e00ab1ac..33ff34110e05 100644
--- a/po/hu.po
+++ b/po/hu.po
@@ -2433,3 +2433,15 @@ msgstr ""
 #: src/terminal-window.c:3224
 msgid "C_lose Window"
 msgstr "_Ablak bezrsa"
+
+msgid "Title"
+msgstr "Cm"
+
+msgid "_Title:"
+msgstr "_Cm:"
+
+msgid "Set Title"
+msgstr "Cm belltsa"
+
+msgid "Transparent background"
+msgstr "ttetsz httr"
diff --git a/po/hy.po b/po/hy.po
index aaf2d9b292da..4d466f164420 100644
--- a/po/hy.po
+++ b/po/hy.po
@@ -757,8 +757,8 @@ msgid "_Base on:"
 msgstr ""
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1012,8 +1012,8 @@ msgid "_Text color:"
 msgstr "_ "
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
-msgstr "_ "
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/profile-preferences.glade.h:74
 msgid "_Update login records when command is launched"
diff --git a/po/id.po b/po/id.po
index 5e3f3617dbe8..9df577e3edfe 100644
--- a/po/id.po
+++ b/po/id.po
@@ -2442,3 +2442,15 @@ msgstr "Tutup Jende_la"
 
 #~ msgid "_Detach Tab"
 #~ msgstr "_Pisahkan Tab"
+
+msgid "Transparent background"
+msgstr "Latar belakang transparan"
+
+msgid "Title"
+msgstr "Judul"
+
+msgid "_Title:"
+msgstr "_Judul:"
+
+msgid "Set Title"
+msgstr "Atur Judul"
diff --git a/po/it.po b/po/it.po
index 3d6e7f02c168..d9560a1a5b1c 100644
--- a/po/it.po
+++ b/po/it.po
@@ -2459,3 +2459,15 @@ msgstr ""
 #: src/terminal-window.c:3224
 msgid "C_lose Window"
 msgstr "Chiudi _finestra"
+
+msgid "Transparent background"
+msgstr "Sfondo trasparente"
+
+msgid "Title"
+msgstr "Titolo"
+
+msgid "_Title:"
+msgstr "_Titolo:"
+
+msgid "Set Title"
+msgstr "Imposta titolo"
diff --git a/po/ja.po b/po/ja.po
index ab72bc42e70b..690281a6713e 100644
--- a/po/ja.po
+++ b/po/ja.po
@@ -2534,3 +2534,15 @@ msgstr "(_L)"
 
 #~ msgid "_Incremental Search"
 #~ msgstr "(_I)"
+
+msgid "Transparent background"
+msgstr ""
+
+msgid "Title"
+msgstr ""
+
+msgid "_Title:"
+msgstr "(_T):"
+
+msgid "Set Title"
+msgstr ""
diff --git a/po/ka.po b/po/ka.po
index e0dd79f280a2..887d395ce150 100644
--- a/po/ka.po
+++ b/po/ka.po
@@ -219,8 +219,8 @@ msgid "<b>Background</b>"
 msgstr "<b></b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -569,7 +569,7 @@ msgstr "_ :"
 
 #: ../src/gnome-terminal.glade2.h:86
 #, fuzzy
-msgid "_Transparent background"
+msgid "Transparent background"
 msgstr ""
 
 #: ../src/gnome-terminal.glade2.h:87
diff --git a/po/kk.po b/po/kk.po
index d2487add3897..a2beab5fa3f6 100644
--- a/po/kk.po
+++ b/po/kk.po
@@ -2712,3 +2712,15 @@ msgstr " _"
 
 #~ msgid "Be quiet"
 #~ msgstr " "
+
+msgid "Transparent background"
+msgstr " "
+
+msgid "Title"
+msgstr ""
+
+msgid "_Title:"
+msgstr "_:"
+
+msgid "Set Title"
+msgstr " "
diff --git a/po/km.po b/po/km.po
index 352897d2963b..b6db9394a307 100644
--- a/po/km.po
+++ b/po/km.po
@@ -2909,8 +2909,8 @@ msgstr ""
 #~ msgid "Background image _scrolls"
 #~ msgstr ""
 
-#~ msgid "_Transparent background"
-#~ msgstr ""
+msgid "Transparent background"
+msgstr ""
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "  "
diff --git a/po/kn.po b/po/kn.po
index c887f88a2c87..0fc1c3139258 100644
--- a/po/kn.po
+++ b/po/kn.po
@@ -2261,8 +2261,8 @@ msgstr "   (_l)"
 #~ msgid "Use custom default terminal si_ze"
 #~ msgstr "    (_z)"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "     (_w):"
@@ -2282,8 +2282,8 @@ msgstr "   (_l)"
 #~ msgid "Close Window"
 #~ msgstr " "
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Switch to Tab 2"
 #~ msgstr "2   "
@@ -2342,5 +2342,8 @@ msgstr "   (_l)"
 #~ msgid "_Input Methods"
 #~ msgstr "  (_I)"
 
-#~ msgid "_Title:"
-#~ msgstr "(_T):"
+msgid "_Title:"
+msgstr "(_T):"
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/ko.po b/po/ko.po
index 8bddfb9141b8..0d37503a81f7 100644
--- a/po/ko.po
+++ b/po/ko.po
@@ -2474,3 +2474,15 @@ msgstr " (_L)"
 
 #~ msgid "Verbose output"
 #~ msgstr " "
+
+msgid "Transparent background"
+msgstr " "
+
+msgid "Title"
+msgstr ""
+
+msgid "_Title:"
+msgstr "(_T):"
+
+msgid "Set Title"
+msgstr " "
diff --git a/po/ku.po b/po/ku.po
index bc2bb7f03de4..d2a83a007097 100644
--- a/po/ku.po
+++ b/po/ku.po
@@ -223,8 +223,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Zemn</b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b>Ferman</b>"
+msgid "Command"
+msgstr "Ferman"
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -558,8 +558,8 @@ msgid "_Text color:"
 msgstr "Reng _nivs:"
 
 #: ../src/gnome-terminal.glade2.h:86
-msgid "_Transparent background"
-msgstr "Rerd _transparan"
+msgid "Transparent background"
+msgstr "Rerd transparan"
 
 #: ../src/gnome-terminal.glade2.h:87
 msgid "_Update login records when command is launched"
diff --git a/po/lt.po b/po/lt.po
index 3c62d2ffab11..11a04aa72fc5 100644
--- a/po/lt.po
+++ b/po/lt.po
@@ -2739,3 +2739,15 @@ msgstr "_Uverti lang"
 
 #~ msgid "Whether to use a dark theme variant"
 #~ msgstr "Ar naudoti tams temos variant"
+
+msgid "Transparent background"
+msgstr "Permatomas fonas"
+
+msgid "Title"
+msgstr "Pavadinimas"
+
+msgid "_Title:"
+msgstr "_Pavadinimas:"
+
+msgid "Set Title"
+msgstr "Nustatyti pavadinim"
diff --git a/po/lv.po b/po/lv.po
index 57637022c2ee..d495e18ac27a 100644
--- a/po/lv.po
+++ b/po/lv.po
@@ -2691,3 +2691,19 @@ msgstr "Aizvrt _logu"
 
 #~ msgid "_Add or Remove"
 #~ msgstr "_Pievienot vai izemt"
+
+msgid "Transparent background"
+msgstr "Caurspdgs fons"
+
+msgid "Title"
+msgstr "Nosaukums"
+
+msgid "_Title:"
+msgstr "_Nosaukums:"
+
+msgctxt "title"
+msgid "'Terminal'"
+msgstr "Terminlis"
+
+msgid "Set Title"
+msgstr "Iestatt nosaukumu"
diff --git a/po/mai.po b/po/mai.po
index 715d0b9e1c82..0f31634e4f2e 100644
--- a/po/mai.po
+++ b/po/mai.po
@@ -1044,8 +1044,8 @@ msgid "_Base on:"
 msgstr " : (_B)"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1291,8 +1291,8 @@ msgid "_Text color:"
 msgstr "  (_T):"
 
 #: ../src/profile-preferences.glade.h:69
-msgid "_Transparent background"
-msgstr "  (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/profile-preferences.glade.h:70
 msgid "_Update login records when command is launched"
diff --git a/po/mg.po b/po/mg.po
index 99fa0f5e4059..a216602569af 100644
--- a/po/mg.po
+++ b/po/mg.po
@@ -220,8 +220,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Afara</b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b>Baiko</b>"
+msgid "Command"
+msgstr "Baiko"
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -567,8 +567,8 @@ msgid "_Text color:"
 msgstr "Lokon'ny _soratra:"
 
 #: ../src/gnome-terminal.glade2.h:86
-msgid "_Transparent background"
-msgstr "_Afara tatera-pahazavana"
+msgid "Transparent background"
+msgstr "Afara tatera-pahazavana"
 
 #: ../src/gnome-terminal.glade2.h:87
 msgid "_Update login records when command is launched"
diff --git a/po/mk.po b/po/mk.po
index 4fe43192fe57..a5a874b49c59 100644
--- a/po/mk.po
+++ b/po/mk.po
@@ -863,8 +863,8 @@ msgid "_Base on:"
 msgstr "_ :"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 #| msgid "<b>Foreground and Background</b>"
@@ -1167,8 +1167,8 @@ msgid "_Text color:"
 msgstr "_  :"
 
 #: ../src/profile-preferences.glade.h:77
-msgid "_Transparent background"
-msgstr "_ "
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/profile-preferences.glade.h:78
 #| msgid "_Text color:"
diff --git a/po/ml.po b/po/ml.po
index 296149701e1f..e3bce1225738 100644
--- a/po/ml.po
+++ b/po/ml.po
@@ -2577,3 +2577,6 @@ msgstr "  (_l)"
 
 #~ msgid "_Unlimited"
 #~ msgstr " (_U)"
+
+msgid "Transparent background"
+msgstr "  "
diff --git a/po/mn.po b/po/mn.po
index 2f9d86072d1c..09c4437d10f9 100644
--- a/po/mn.po
+++ b/po/mn.po
@@ -217,8 +217,8 @@ msgid "<b>Background</b>"
 msgstr "<b></b>"
 
 #: ../src/gnome-terminal.glade2.h:2
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/gnome-terminal.glade2.h:3
 msgid "<b>Compatibility</b>"
@@ -618,8 +618,8 @@ msgid "_Text color:"
 msgstr "_ :"
 
 #: ../src/gnome-terminal.glade2.h:102
-msgid "_Transparent background"
-msgstr "_ "
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/gnome-terminal.glade2.h:103
 msgid "_Update login records when command is launched"
diff --git a/po/mr.po b/po/mr.po
index 61997dafbd03..9c7dc77abd22 100644
--- a/po/mr.po
+++ b/po/mr.po
@@ -2219,8 +2219,8 @@ msgstr "   (_l)"
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "       (_w):"
@@ -2240,8 +2240,8 @@ msgstr "   (_l)"
 #~ msgid "Close Window"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "The shortcut key %s is already bound to the %s action"
 #~ msgstr "%s    %s    "
@@ -2267,8 +2267,8 @@ msgstr "   (_l)"
 #~ msgid "_Input Methods"
 #~ msgstr "  (_I)"
 
-#~ msgid "_Title:"
-#~ msgstr " (_T):"
+msgid "_Title:"
+msgstr " (_T):"
 
 #~ msgid "Keyboard shortcut to switch to tab 1"
 #~ msgstr " 1   "
@@ -3015,8 +3015,8 @@ msgstr "   (_l)"
 #~ msgid "_Solid color"
 #~ msgstr "  (_S)"
 
-#~ msgid "_Transparent background"
-#~ msgstr " (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "Disabled"
 #~ msgstr ""
diff --git a/po/ms.po b/po/ms.po
index 114f0d4e50c2..5d3f2e011f1c 100644
--- a/po/ms.po
+++ b/po/ms.po
@@ -2717,8 +2717,8 @@ msgstr "T_utup Tetingkap"
 #~ msgid "_Profile name:"
 #~ msgstr "_Nama profil: "
 
-#~ msgid "_Transparent background"
-#~ msgstr "LatarBelakang _Telus"
+msgid "Transparent background"
+msgstr "LatarBelakang Telus"
 
 #~ msgid "_Update login records when command is launched"
 #~ msgstr "_Kemaskini rekod logmasuk bila arahan dilancarkan"
diff --git a/po/nb.po b/po/nb.po
index 683acfe5221e..3dc97ee17fec 100644
--- a/po/nb.po
+++ b/po/nb.po
@@ -2261,3 +2261,15 @@ msgstr ""
 #: ../src/terminal-window.c:3210
 msgid "C_lose Window"
 msgstr "_Lukk vindu"
+
+msgid "Transparent background"
+msgstr "Gjennomsiktig bakgrunn"
+
+msgid "Title"
+msgstr "Tittel"
+
+msgid "_Title:"
+msgstr "_Tittel:"
+
+msgid "Set Title"
+msgstr "Sett tittel"
diff --git a/po/nds.po b/po/nds.po
index 82f930b1cc0c..d52fbd94eb58 100644
--- a/po/nds.po
+++ b/po/nds.po
@@ -748,8 +748,8 @@ msgid "_Base on:"
 msgstr "_Steiht op:"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Order</b>"
+msgid "Command"
+msgstr "Order"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -996,8 +996,8 @@ msgid "_Text color:"
 msgstr "_Textklr:"
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
-msgstr "_Drschienenachtergrund:"
+msgid "Transparent background"
+msgstr "Drschienenachtergrund:"
 
 #: ../src/profile-preferences.glade.h:74
 msgid "_Update login records when command is launched"
diff --git a/po/ne.po b/po/ne.po
index 4fe16cc88a9a..53fb89134be0 100644
--- a/po/ne.po
+++ b/po/ne.po
@@ -2398,8 +2398,8 @@ msgstr "  "
 #~ msgid "_None (use solid color)"
 #~ msgstr "   (   )"
 
-#~ msgid "_Transparent background"
-#~ msgstr " "
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "_Use the system fixed width font"
 #~ msgstr "      "
@@ -3052,8 +3052,8 @@ msgstr "  "
 #~ msgid "Close Tab"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Switch to Tab 2"
 #~ msgstr "    "
@@ -3232,8 +3232,8 @@ msgstr "  "
 #~ msgid "_Input Methods"
 #~ msgstr " "
 
-#~ msgid "_Title:"
-#~ msgstr ":"
+msgid "_Title:"
+msgstr ":"
 
 #~ msgid ""
 #~ "text/plain dropped on terminal had wrong format (%d) or length (%d)\n"
diff --git a/po/nl.po b/po/nl.po
index b493d43bbbaf..e97079afacad 100644
--- a/po/nl.po
+++ b/po/nl.po
@@ -2776,3 +2776,15 @@ msgstr "Venster sl_uiten"
 
 #~ msgid "_Add or Remove"
 #~ msgstr "_Toevoegen of verwijderen"
+
+msgid "Title"
+msgstr "Titel"
+
+msgid "_Title:"
+msgstr "_Titel:"
+
+msgid "Set Title"
+msgstr "Titel instellen"
+
+msgid "Transparent background"
+msgstr "Transparante achtergrond"
diff --git a/po/nn.po b/po/nn.po
index 5aa43b113ed9..f892290c256f 100644
--- a/po/nn.po
+++ b/po/nn.po
@@ -1149,8 +1149,8 @@ msgid "_Base on:"
 msgstr "_Tuft p:"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b>Kommando</b>"
+msgid "Command"
+msgstr "Kommando"
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1429,8 +1429,8 @@ msgid "_Text color:"
 msgstr "_Tekstfarge:"
 
 #: ../src/profile-preferences.glade.h:73
-msgid "_Transparent background"
-msgstr "_Gjennomskinleg bakgrunn"
+msgid "Transparent background"
+msgstr "Gjennomskinleg bakgrunn"
 
 #: ../src/profile-preferences.glade.h:74
 msgid "_Update login records when command is launched"
diff --git a/po/oc.po b/po/oc.po
index 9a6f6186019a..6e51ea2f8980 100644
--- a/po/oc.po
+++ b/po/oc.po
@@ -2944,8 +2944,8 @@ msgstr "Tampar _la fenstra"
 #~ msgid "Save as..."
 #~ msgstr "Enregistrar jos..."
 
-#~ msgid "_Title:"
-#~ msgstr "_Ttol :"
+msgid "_Title:"
+msgstr "_Ttol :"
 
 #~ msgid "_Detach tab"
 #~ msgstr "Des_tacar l'onglet"
@@ -3405,8 +3405,8 @@ msgstr "Tampar _la fenstra"
 #~ msgid "_Use the system fixed width font"
 #~ msgstr "_Utilizar la polia de chassa fixa del sistma"
 
-#~ msgid "Set Title"
-#~ msgstr "Definir lo ttol"
+msgid "Set Title"
+msgstr "Definir lo ttol"
 
 #~ msgid "The shortcut key %s is already bound to the %s action"
 #~ msgstr "L'acorchi de clavir  %s  es ja atribuit a l'accion  %s "
@@ -3723,8 +3723,8 @@ msgstr "Tampar _la fenstra"
 #~ msgid "Run;"
 #~ msgstr "Executar;Consla;Shell;"
 
-#~ msgid "_Transparent background"
-#~ msgstr "Rireplan _transparent"
+msgid "Transparent background"
+msgstr "Rireplan transparent"
 
 #~ msgid ""
 #~ "A subset of possible encodings are presented in the Encoding submenu. "
diff --git a/po/or.po b/po/or.po
index ec1e6bfb9a28..218acd712df6 100644
--- a/po/or.po
+++ b/po/or.po
@@ -2705,8 +2705,8 @@ msgstr " (_T):"
 #~ msgid "Background image _scrolls"
 #~ msgstr "   (_s)"
 
-#~ msgid "_Transparent background"
-#~ msgstr "  (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "     (_h):"
diff --git a/po/pa.po b/po/pa.po
index 1cb4b46dc2aa..2bdd01fecaab 100644
--- a/po/pa.po
+++ b/po/pa.po
@@ -2718,10 +2718,9 @@ msgstr "  (_l)"
 #~ msgid "GNOME Terminal Client"
 #~ msgstr "  "
 
-#~| msgid "Terminal"
-#~ msgctxt "title"
-#~ msgid "'Terminal'"
-#~ msgstr "''"
+msgctxt "title"
+msgid "'Terminal'"
+msgstr "''"
 
 #~ msgid "Title for terminal"
 #~ msgstr "  "
@@ -2766,11 +2765,11 @@ msgstr "  (_l)"
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "(_T):"
+msgid "_Title:"
+msgstr "(_T):"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
@@ -2778,8 +2777,8 @@ msgstr "  (_l)"
 #~ msgid "_Unlimited"
 #~ msgstr "(_U)"
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
@@ -3559,8 +3558,8 @@ msgstr "  (_l)"
 #~ msgid "_Solid color"
 #~ msgstr "  (_S)"
 
-#~ msgid "_Transparent background"
-#~ msgstr " (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "S/Key Challenge Response"
 #~ msgstr "S/  "
diff --git a/po/ps.po b/po/ps.po
index b25a2cb41712..3855b2f3423f 100644
--- a/po/ps.po
+++ b/po/ps.po
@@ -810,8 +810,8 @@ msgid "_Base on:"
 msgstr ":  _"
 
 #: ../src/profile-preferences.glade.h:1
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/profile-preferences.glade.h:2
 msgid "<b>Foreground and Background</b>"
@@ -1053,8 +1053,8 @@ msgid "_Text color:"
 msgstr ":  _"
 
 #: ../src/profile-preferences.glade.h:69
-msgid "_Transparent background"
-msgstr " _"
+msgid "Transparent background"
+msgstr " "
 
 #: ../src/profile-preferences.glade.h:70
 msgid "_Update login records when command is launched"
diff --git a/po/pt.po b/po/pt.po
index d7af9e54ce22..f6f92cbeac5a 100644
--- a/po/pt.po
+++ b/po/pt.po
@@ -2938,11 +2938,11 @@ msgstr "Fechar jane_la"
 #~ msgid "Default size:"
 #~ msgstr "Tamanho predefinido:"
 
-#~ msgid "Title"
-#~ msgstr "Ttulo"
+msgid "Title"
+msgstr "Ttulo"
 
-#~ msgid "_Title:"
-#~ msgstr "_Ttulo:"
+msgid "_Title:"
+msgstr "_Ttulo:"
 
 #~ msgid "Title and Command"
 #~ msgstr "Ttulo e comando"
@@ -2950,8 +2950,8 @@ msgstr "Fechar jane_la"
 #~ msgid "_Unlimited"
 #~ msgstr "_Ilimitado"
 
-#~ msgid "Set Title"
-#~ msgstr "Definir o Ttulo"
+msgid "Set Title"
+msgstr "Definir o Ttulo"
 
 #~ msgid "Current Locale"
 #~ msgstr "Configurao Regional Atual"
@@ -3705,8 +3705,8 @@ msgstr "Fechar jane_la"
 #~ msgid "Background image _scrolls"
 #~ msgstr "Imagem de fundo _rola"
 
-#~ msgid "_Transparent background"
-#~ msgstr "Fundo _transparente"
+msgid "Transparent background"
+msgstr "Fundo transparente"
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "Transparente som_breado ou imagem de fundo:"
diff --git a/po/pt_BR.po b/po/pt_BR.po
index 4152306f6e0c..c8590c320d36 100644
--- a/po/pt_BR.po
+++ b/po/pt_BR.po
@@ -2858,17 +2858,17 @@ msgstr "_Fechar janela"
 #~ msgid "Default size:"
 #~ msgstr "Tamanho padro:"
 
-#~ msgid "Title"
-#~ msgstr "Ttulo"
+msgid "Title"
+msgstr "Ttulo"
 
-#~ msgid "_Title:"
-#~ msgstr "_Ttulo:"
+msgid "_Title:"
+msgstr "_Ttulo:"
 
 #~ msgid "Title and Command"
 #~ msgstr "Ttulo e comando"
 
-#~ msgid "Set Title"
-#~ msgstr "Definir ttulo"
+msgid "Set Title"
+msgstr "Definir ttulo"
 
 #~ msgid "Current Locale"
 #~ msgstr "Codificao atual"
@@ -3494,3 +3494,6 @@ msgstr "_Fechar janela"
 #~ "terminal podero usar. Essa  a paleta, na forma de uma lista de nomes de "
 #~ "cores separada por dois pontos. Os nomes de cores devem estar no formato "
 #~ "hexadecimal. Exemplo: \"#FF00FF\""
+
+msgid "Transparent background"
+msgstr "Fundo transparente"
diff --git a/po/ro.po b/po/ro.po
index 84030877e73a..cbe1e739889b 100644
--- a/po/ro.po
+++ b/po/ro.po
@@ -3514,8 +3514,8 @@ msgstr "_nchide fereastra"
 #~ msgid "_Solid color"
 #~ msgstr "Culoare _solid"
 
-#~ msgid "_Transparent background"
-#~ msgstr "Fundal _transparent"
+msgid "Transparent background"
+msgstr "Fundal transparent"
 
 #~ msgid "_Unlimited"
 #~ msgstr "_Neliminat"
diff --git a/po/ru.po b/po/ru.po
index d6f6dd4f8279..814ba613679f 100644
--- a/po/ru.po
+++ b/po/ru.po
@@ -2552,3 +2552,19 @@ msgstr "_ "
 
 #~ msgid "_Add or Remove"
 #~ msgstr "_  "
+
+msgid "Transparent background"
+msgstr " "
+
+msgid "Title"
+msgstr ""
+
+msgid "_Title:"
+msgstr "_:"
+
+msgctxt "title"
+msgid "'Terminal'"
+msgstr "''"
+
+msgid "Set Title"
+msgstr " "
diff --git a/po/rw.po b/po/rw.po
index 012f64e325c3..5ff633f8b3c2 100644
--- a/po/rw.po
+++ b/po/rw.po
@@ -749,7 +749,7 @@ msgstr "Ibara ry'Inyandiko..."
 
 #: ../src/gnome-terminal.glade2.h:102
 #, fuzzy
-msgid "_Transparent background"
+msgid "Transparent background"
 msgstr "Mbuganyuma"
 
 #: ../src/gnome-terminal.glade2.h:103
@@ -2398,7 +2398,6 @@ msgstr ""
 
 # sch/source\ui\app\menu.src:RID_MENU.WORKAROUND_22.SID_INSERT_TITLE.text
 #: ../src/terminal-screen.c:2005
-#, fuzzy
 msgid "_Title:"
 msgstr "Umutwe..."
 
diff --git a/po/si.po b/po/si.po
index adca7d5acba9..6379cee7f0a3 100644
--- a/po/si.po
+++ b/po/si.po
@@ -218,8 +218,8 @@ msgid "<b>Background</b>"
 msgstr "<b></b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b></b>"
+msgid "Command"
+msgstr ""
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -538,8 +538,8 @@ msgid "_Text color:"
 msgstr " : (_T)"
 
 #: ../src/gnome-terminal.glade2.h:86
-msgid "_Transparent background"
-msgstr "   (_T)"
+msgid "Transparent background"
+msgstr "  "
 
 #: ../src/gnome-terminal.glade2.h:87
 msgid "_Update login records when command is launched"
diff --git a/po/sk.po b/po/sk.po
index 765dcf2a034d..96bff962d86e 100644
--- a/po/sk.po
+++ b/po/sk.po
@@ -3076,3 +3076,15 @@ msgstr "_Zavrie okno"
 #~ "\n"
 #~ "Viac informcii o jednotlivch prkazoch zskate pomocou %s PRKAZ --"
 #~ "help.\n"
+
+msgid "Transparent background"
+msgstr "Priehadn pozadie"
+
+msgid "Title"
+msgstr "Titulok"
+
+msgid "_Title:"
+msgstr "_Titulok:"
+
+msgid "Set Title"
+msgstr "Nastavi titulok"
diff --git a/po/sl.po b/po/sl.po
index 3108543b2ed6..2f7d4b389da1 100644
--- a/po/sl.po
+++ b/po/sl.po
@@ -2836,17 +2836,17 @@ msgstr "_Zapri okno"
 #~ msgid "Default size:"
 #~ msgstr "Privzeta velikost:"
 
-#~ msgid "Title"
-#~ msgstr "Naslov"
+msgid "Title"
+msgstr "Naslov"
 
-#~ msgid "_Title:"
-#~ msgstr "_Naziv:"
+msgid "_Title:"
+msgstr "_Naziv:"
 
 #~ msgid "Title and Command"
 #~ msgstr "Naziv in ukaz"
 
-#~ msgid "Set Title"
-#~ msgstr "Doloitev naziva okna"
+msgid "Set Title"
+msgstr "Doloitev naziva okna"
 
 #~ msgid "Current Locale"
 #~ msgstr "Trenutne jezikovne nastavitve"
@@ -2961,3 +2961,6 @@ msgstr "_Zapri okno"
 
 #~ msgid "_Profile Preferences"
 #~ msgstr "Monosti _profila ..."
+
+msgid "Transparent background"
+msgstr "Prosojno ozadje"
diff --git a/po/sq.po b/po/sq.po
index 158f6cb167cc..a3494fb70bd6 100644
--- a/po/sq.po
+++ b/po/sq.po
@@ -225,8 +225,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Sfondi</b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b>Komanda</b>"
+msgid "Command"
+msgstr "Komanda"
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -568,8 +568,8 @@ msgstr "Ngjyra e _tekstit:"
 
 # (pofilter) simplecaps: checks the capitalisation of two strings isn't wildly different
 #: ../src/gnome-terminal.glade2.h:85
-msgid "_Transparent background"
-msgstr "Sfond _Trasparent"
+msgid "Transparent background"
+msgstr "Sfond Trasparent"
 
 #: ../src/gnome-terminal.glade2.h:86
 msgid "_Update login records when command is launched"
diff --git a/po/sr.po b/po/sr.po
index 64a3ca2ba635..a8e565c04333 100644
--- a/po/sr.po
+++ b/po/sr.po
@@ -2746,10 +2746,9 @@ msgstr "_ "
 #~ msgid "GNOME Terminal Client"
 #~ msgstr "  "
 
-#~| msgid "Terminal"
-#~ msgctxt "title"
-#~ msgid "'Terminal'"
-#~ msgstr ""
+msgctxt "title"
+msgid "'Terminal'"
+msgstr ""
 
 #~ msgid "Title for terminal"
 #~ msgstr "  "
@@ -2795,11 +2794,11 @@ msgstr "_ "
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
@@ -2807,8 +2806,8 @@ msgstr "_ "
 #~ msgid "_Unlimited"
 #~ msgstr "_"
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
@@ -2818,3 +2817,6 @@ msgstr "_ "
 
 #~ msgid "Hidden"
 #~ msgstr ""
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/sr@latin.po b/po/sr@latin.po
index 45dbad07fba7..852c47cc6ee5 100644
--- a/po/sr@latin.po
+++ b/po/sr@latin.po
@@ -2576,10 +2576,9 @@ msgstr "_Zatvori prozor"
 #~ msgid "GNOME Terminal Client"
 #~ msgstr "Klijent Gnomovog terminala"
 
-#~| msgid "Terminal"
-#~ msgctxt "title"
-#~ msgid "'Terminal'"
-#~ msgstr "Terminal"
+msgctxt "title"
+msgid "'Terminal'"
+msgstr "Terminal"
 
 #~ msgid "Title for terminal"
 #~ msgstr "Naslov za terminal"
@@ -2625,11 +2624,11 @@ msgstr "_Zatvori prozor"
 #~ msgid "Default size:"
 #~ msgstr "Osnovna veliina:"
 
-#~ msgid "Title"
-#~ msgstr "Naslov"
+msgid "Title"
+msgstr "Naslov"
 
-#~ msgid "_Title:"
-#~ msgstr "_Naslov:"
+msgid "_Title:"
+msgstr "_Naslov:"
 
 #~ msgid "Title and Command"
 #~ msgstr "Naslov i naredba"
@@ -2637,8 +2636,8 @@ msgstr "_Zatvori prozor"
 #~ msgid "_Unlimited"
 #~ msgstr "_Neogranieno"
 
-#~ msgid "Set Title"
-#~ msgstr "Postavi naslov"
+msgid "Set Title"
+msgstr "Postavi naslov"
 
 #~ msgid "Current Locale"
 #~ msgstr "Tekui lokalitet"
@@ -2648,3 +2647,6 @@ msgstr "_Zatvori prozor"
 
 #~ msgid "Hidden"
 #~ msgstr "Skriven"
+
+msgid "Transparent background"
+msgstr "Providna pozadina"
diff --git a/po/sv.po b/po/sv.po
index 5c5fa345c9ad..de87367421d7 100644
--- a/po/sv.po
+++ b/po/sv.po
@@ -2737,5 +2737,17 @@ msgstr "Stn_g fnster"
 #~ msgid "Unknown completion request for \"%s\""
 #~ msgstr "Oknd kompletteringsbegran fr \"%s\""
 
+msgid "Transparent background"
+msgstr "Genomskinlig bakgrund"
+
 #~ msgid "Missing command"
 #~ msgstr "Kommando saknas"
+
+msgid "_Title:"
+msgstr "_Titel:"
+
+msgid "Set Title"
+msgstr "Stll in titel"
+
+msgid "_Set Title"
+msgstr "A_nge titel..."
diff --git a/po/ta.po b/po/ta.po
index 80aa2f684eec..afd335b0faf0 100644
--- a/po/ta.po
+++ b/po/ta.po
@@ -2171,10 +2171,9 @@ msgstr "_l  "
 #~ msgid "Show server options"
 #~ msgstr "  "
 
-#~| msgid "Terminal"
-#~ msgctxt "title"
-#~ msgid "'Terminal'"
-#~ msgstr "''"
+msgctxt "title"
+msgid "'Terminal'"
+msgstr "''"
 
 #~ msgid "Title for terminal"
 #~ msgstr " "
@@ -2221,11 +2220,11 @@ msgstr "_l  "
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_T :"
+msgid "_Title:"
+msgstr "_T :"
 
 #~ msgid "Title and Command"
 #~ msgstr " "
@@ -2233,8 +2232,8 @@ msgstr "_l  "
 #~ msgid "_Unlimited"
 #~ msgstr "_U  "
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~| msgid "_Terminal"
 #~ msgid "_About Terminal"
@@ -2243,8 +2242,8 @@ msgstr "_l  "
 #~ msgid "Current Locale"
 #~ msgstr " "
 
-#~ msgid "_Set Title"
-#~ msgstr "(_S)  ..."
+msgid "_Set Title"
+msgstr "(_S)  ..."
 
 #~ msgid "_Next Tab"
 #~ msgstr "  (_N)"
@@ -3028,8 +3027,8 @@ msgstr "_l  "
 #~ msgid "_Solid color"
 #~ msgstr "(_S)  "
 
-#~ msgid "_Transparent background"
-#~ msgstr "_T  "
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "No such profile \"%s\", using default profile\n"
 #~ msgstr "\"%s\"   ,   \n"
diff --git a/po/te.po b/po/te.po
index 82c0e0fc8f54..0dd3d871f639 100644
--- a/po/te.po
+++ b/po/te.po
@@ -2055,10 +2055,9 @@ msgstr "  (_l)"
 #~ msgid "Show server options"
 #~ msgstr "  "
 
-#, fuzzy
-#~ msgctxt "title"
-#~ msgid "'Terminal'"
-#~ msgstr ""
+msgctxt "title"
+msgid "'Terminal'"
+msgstr ""
 
 #~ msgid "Title for terminal"
 #~ msgstr "  "
@@ -2104,11 +2103,11 @@ msgstr "  (_l)"
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ":"
+msgid "Title"
+msgstr ":"
 
-#~ msgid "_Title:"
-#~ msgstr " (_T):"
+msgid "_Title:"
+msgstr " (_T):"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
@@ -2116,14 +2115,14 @@ msgstr "  (_l)"
 #~ msgid "_Unlimited"
 #~ msgstr " (_U)"
 
-#~ msgid "Set Title"
-#~ msgstr " "
+msgid "Set Title"
+msgstr " "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
 
-#~ msgid "_Set Title"
-#~ msgstr " ... (_S)"
+msgid "_Set Title"
+msgstr " ... (_S)"
 
 #~ msgid "_Next Tab"
 #~ msgstr " (_N)"
@@ -2898,8 +2897,8 @@ msgstr "  (_l)"
 #~ msgid "Background image _scrolls"
 #~ msgstr "  (_s)"
 
-#~ msgid "_Transparent background"
-#~ msgstr "  (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid "S_hade transparent or image background:"
 #~ msgstr "      (_h):"
diff --git a/po/tg.po b/po/tg.po
index e3feef658e1e..6371c036626f 100644
--- a/po/tg.po
+++ b/po/tg.po
@@ -2158,23 +2158,23 @@ msgstr "_ "
 #~ msgid "Default size:"
 #~ msgstr " :"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr "  "
 
-#~ msgid "Set Title"
-#~ msgstr "  "
+msgid "Set Title"
+msgstr "  "
 
 #~ msgid "Current Locale"
 #~ msgstr " "
 
-#~ msgid "_Set Title"
-#~ msgstr "_ ..."
+msgid "_Set Title"
+msgstr "_ ..."
 
 #~ msgid "_Next Tab"
 #~ msgstr "_ "
diff --git a/po/th.po b/po/th.po
index 63263749655c..496da331bbf9 100644
--- a/po/th.po
+++ b/po/th.po
@@ -2308,23 +2308,23 @@ msgstr "_"
 #~ msgid "Default size:"
 #~ msgstr ":"
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "_:"
+msgid "_Title:"
+msgstr "_:"
 
 #~ msgid "Title and Command"
 #~ msgstr ""
 
-#~ msgid "Set Title"
-#~ msgstr ""
+msgid "Set Title"
+msgstr ""
 
 #~ msgid "Current Locale"
 #~ msgstr ""
 
-#~ msgid "_Set Title"
-#~ msgstr "_"
+msgid "_Set Title"
+msgstr "_"
 
 #~ msgid "_Next Tab"
 #~ msgstr "_"
@@ -2803,8 +2803,8 @@ msgstr "_"
 #~ msgid "_Solid color"
 #~ msgstr "_"
 
-#~ msgid "_Transparent background"
-#~ msgstr "_"
+msgid "Transparent background"
+msgstr ""
 
 #~ msgid ""
 #~ "You already have a profile called %s. Do you want to create another "
diff --git a/po/tr.po b/po/tr.po
index 3ac22937b896..bd971dd81d73 100644
--- a/po/tr.po
+++ b/po/tr.po
@@ -2731,3 +2731,15 @@ msgstr "_Pencereyi Kapat"
 
 #~ msgid "_Same as text color"
 #~ msgstr "_Metin rengiyle ayn"
+
+msgid "Transparent background"
+msgstr "effaf arkaplan"
+
+msgid "_Title:"
+msgstr "_Balk:"
+
+msgid "Set Title"
+msgstr "Bal Dzenle"
+
+msgid "_Set Title"
+msgstr "_Bal Ata..."
diff --git a/po/ug.po b/po/ug.po
index 313f76b98eae..be6089762082 100644
--- a/po/ug.po
+++ b/po/ug.po
@@ -2616,8 +2616,8 @@ msgstr " (_T):"
 #~ msgid "_Solid color"
 #~ msgstr " (_S)"
 
-#~ msgid "_Transparent background"
-#~ msgstr " (_T)"
+msgid "Transparent background"
+msgstr " "
 
 #~ msgid ""
 #~ "You already have a profile called %s. Do you want to create another "
diff --git a/po/uk.po b/po/uk.po
index d6a261e2de57..9e0cca12a398 100644
--- a/po/uk.po
+++ b/po/uk.po
@@ -2422,3 +2422,18 @@ msgstr ""
 #: src/terminal-window.c:3224
 msgid "C_lose Window"
 msgstr "_ "
+
+msgid "Title"
+msgstr ""
+
+msgid "_Title:"
+msgstr "_:"
+
+msgid "Set Title"
+msgstr " "
+
+msgid "_Set Title"
+msgstr "_ "
+
+msgid "Transparent background"
+msgstr " "
diff --git a/po/vi.po b/po/vi.po
index d5f27612f4be..8bb576b6d875 100644
--- a/po/vi.po
+++ b/po/vi.po
@@ -2703,8 +2703,8 @@ msgstr "n_g ca s"
 #~ msgid "Default size:"
 #~ msgstr "C mc nh:"
 
-#~ msgid "Title"
-#~ msgstr "Ta "
+msgid "Title"
+msgstr "Ta "
 
 #~ msgid "When terminal commands set their o_wn titles:"
 #~ msgstr "Khi cu lnh thit b cui t t ta  _mnh:"
@@ -2715,8 +2715,8 @@ msgstr "n_g ca s"
 #~ msgid "_Unlimited"
 #~ msgstr "_Khng hn ch"
 
-#~ msgid "Set Title"
-#~ msgstr "t ta "
+msgid "Set Title"
+msgstr "t ta "
 
 #~ msgid "Switch to Tab 3"
 #~ msgstr "Chuyn sang Thanh 3"
@@ -2757,8 +2757,8 @@ msgstr "n_g ca s"
 #~ msgid "_Input Methods"
 #~ msgstr "K_iu g"
 
-#~ msgid "_Title:"
-#~ msgstr "_Ta :"
+msgid "_Title:"
+msgstr "_Ta :"
 
 #~ msgid "Disable connection to session manager"
 #~ msgstr "Tt kt ni n trnh qun l phin lm vic"
@@ -3143,3 +3143,6 @@ msgstr "n_g ca s"
 #~ "Phm tt  t li thit b cui. Dng dng chui c cng mt khun dng "
 #~ "vi tp tin ti nguyn GTK+. Nu bn t ty chn l chui disabled (b "
 #~ "tt), ngha l khng c phm tt cho hnh ng ny."
+
+msgid "Transparent background"
+msgstr "Nn trong sut"
diff --git a/po/wa.po b/po/wa.po
index 2a29945bbc74..4f1c57c71e94 100644
--- a/po/wa.po
+++ b/po/wa.po
@@ -224,8 +224,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Fond</b>"
 
 #: ../src/gnome-terminal.glade2.h:3
-msgid "<b>Command</b>"
-msgstr "<b>Comande</b>"
+msgid "Command"
+msgstr "Comande"
 
 #: ../src/gnome-terminal.glade2.h:4
 msgid "<b>Compatibility</b>"
@@ -564,8 +564,8 @@ msgid "_Text color:"
 msgstr "Coleur pol _tecse:"
 
 #: ../src/gnome-terminal.glade2.h:86
-msgid "_Transparent background"
-msgstr "Fond k'on voet _houte"
+msgid "Transparent background"
+msgstr "Fond k'on voet houte"
 
 #: ../src/gnome-terminal.glade2.h:87
 msgid "_Update login records when command is launched"
@@ -2227,8 +2227,8 @@ msgid "Change _Profile"
 msgstr "Candj _profil"
 
 #: ../src/terminal-window.c:1013
-msgid "_Set Title..."
-msgstr "_Candj l'tite..."
+msgid "_Set Title"
+msgstr "_Candj l'tite"
 
 #: ../src/terminal-window.c:1020
 msgid "Set _Character Encoding"
diff --git a/po/xh.po b/po/xh.po
index cb78ec67db2d..a4f3b4ddcfb6 100644
--- a/po/xh.po
+++ b/po/xh.po
@@ -217,8 +217,8 @@ msgid "<b>Background</b>"
 msgstr "<b>Okungasemva</b>"
 
 #: ../src/gnome-terminal.glade2.h:2
-msgid "<b>Command</b>"
-msgstr "<b>Umyalelo</b>"
+msgid "Command"
+msgstr "Umyalelo"
 
 #: ../src/gnome-terminal.glade2.h:3
 msgid "<b>Compatibility</b>"
@@ -621,8 +621,8 @@ msgid "_Text color:"
 msgstr "_Umbala wombhalo:"
 
 #: ../src/gnome-terminal.glade2.h:102
-msgid "_Transparent background"
-msgstr "_Okungasemva okucace gca"
+msgid "Transparent background"
+msgstr "Okungasemva okucace gca"
 
 #: ../src/gnome-terminal.glade2.h:103
 msgid "_Update login records when command is launched"
@@ -2265,8 +2265,8 @@ msgid "Change _Profile"
 msgstr "Tsintsha i_Nkangeleko"
 
 #: ../src/terminal-window.c:979
-msgid "_Set Title..."
-msgstr "_Misela..."
+msgid "_Set Title"
+msgstr "_Misela"
 
 #: ../src/terminal-window.c:986
 msgid "Set _Character Encoding"
diff --git a/po/zh_CN.po b/po/zh_CN.po
index 4e07e12ea346..dbe611ed5d05 100644
--- a/po/zh_CN.po
+++ b/po/zh_CN.po
@@ -2754,17 +2754,17 @@ msgstr "(_L)"
 #~ msgid "Default size:"
 #~ msgstr ""
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "(_T)"
+msgid "_Title:"
+msgstr "(_T)"
 
 #~ msgid "Title and Command"
 #~ msgstr ""
 
-#~ msgid "Set Title"
-#~ msgstr ""
+msgid "Set Title"
+msgstr ""
 
 #~ msgid "Current Locale"
 #~ msgstr ""
@@ -2877,3 +2877,6 @@ msgstr "(_L)"
 
 #~ msgid "_Find..."
 #~ msgstr "(_F)..."
+
+msgid "Transparent background"
+msgstr ""
diff --git a/po/zh_HK.po b/po/zh_HK.po
index 61153529f0c7..c366abddd1af 100644
--- a/po/zh_HK.po
+++ b/po/zh_HK.po
@@ -2114,17 +2114,17 @@ msgstr "(_L)"
 #~ msgid "Default size:"
 #~ msgstr ""
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "(_T):"
+msgid "_Title:"
+msgstr "(_T):"
 
 #~ msgid "Title and Command"
 #~ msgstr ""
 
-#~ msgid "Set Title"
-#~ msgstr ""
+msgid "Set Title"
+msgstr ""
 
 #~ msgid "Current Locale"
 #~ msgstr ""
@@ -2376,3 +2376,6 @@ msgstr "(_L)"
 
 #~ msgid "Show session management options"
 #~ msgstr ""
+
+msgid "Transparent background"
+msgstr ""
diff --git a/po/zh_TW.po b/po/zh_TW.po
index 80cb23434a60..20e2a93ce3f0 100644
--- a/po/zh_TW.po
+++ b/po/zh_TW.po
@@ -2735,17 +2735,17 @@ msgstr "(_L)"
 #~ msgid "Default size:"
 #~ msgstr ""
 
-#~ msgid "Title"
-#~ msgstr ""
+msgid "Title"
+msgstr ""
 
-#~ msgid "_Title:"
-#~ msgstr "(_T):"
+msgid "_Title:"
+msgstr "(_T):"
 
 #~ msgid "Title and Command"
 #~ msgstr ""
 
-#~ msgid "Set Title"
-#~ msgstr ""
+msgid "Set Title"
+msgstr ""
 
 #~ msgid "Current Locale"
 #~ msgstr ""
@@ -2957,3 +2957,6 @@ msgstr "(_L)"
 
 #~ msgid "Show session management options"
 #~ msgstr ""
+
+msgid "Transparent background"
+msgstr ""
-- 
2.25.4


From fc5845548ab6cbf56888c81fafdf63659ef9c337 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Wed, 25 May 2016 13:47:36 +0200
Subject: [PATCH 12/16] Restore the action and shortcut to set a static title
 from the menus

This reverts 9bbe19e98f62aa3c9020913a3a5a8080a5177505 with various
minor adjustments to keep up with later changes.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/org.gnome.Terminal.gschema.xml |  4 ++
 src/terminal-accels.c              |  2 +
 src/terminal-window.c              | 75 ++++++++++++++++++++++++++++++
 3 files changed, 81 insertions(+)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index 1c458a9fb9ec..c649e988b5cf 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -429,6 +429,10 @@
       <default>'disabled'</default>
       <summary>Keyboard shortcut to toggle the read-only state</summary>
     </key>
+    <key name="set-terminal-title" type="s">
+      <default>'disabled'</default>
+      <summary>Keyboard shortcut to set the terminal title</summary>
+    </key>
     <key name="reset" type="s">
       <default>'disabled'</default>
       <summary>Keyboard shortcut to reset the terminal</summary>
diff --git a/src/terminal-accels.c b/src/terminal-accels.c
index 333c6d17006c..c0371c5cada4 100644
--- a/src/terminal-accels.c
+++ b/src/terminal-accels.c
@@ -76,6 +76,7 @@
 #define KEY_RESET               "reset"
 #define KEY_SAVE_CONTENTS       "save-contents"
 #define KEY_SELECT_ALL          "select-all"
+#define KEY_SET_TERMINAL_TITLE  "set-terminal-title"
 #define KEY_TOGGLE_MENUBAR      "toggle-menubar"
 #define KEY_ZOOM_IN             "zoom-in"
 #define KEY_ZOOM_NORMAL         "zoom-normal"
@@ -165,6 +166,7 @@ static KeyEntry terminal_entries[] = {
   ENTRY (N_("Read-Only"),       KEY_READ_ONLY,          "read-only", NULL, NULL   ),
   ENTRY (N_("Reset"),           KEY_RESET,              "reset",     "b",  "false"),
   ENTRY (N_("Reset and Clear"), KEY_RESET_AND_CLEAR,    "reset",     "b",  "true" ),
+  ENTRY (N_("Set Title"),       KEY_SET_TERMINAL_TITLE, "set-title", NULL, NULL   ),
 };
 
 static KeyEntry tabs_entries[] = {
diff --git a/src/terminal-window.c b/src/terminal-window.c
index c0219d872725..61c5e7de350a 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -749,6 +749,80 @@ action_select_all_cb (GSimpleAction *action,
   vte_terminal_select_all (VTE_TERMINAL (priv->active_screen));
 }
 
+static void
+terminal_set_title_dialog_response_cb (GtkWidget *dialog,
+                                       int response,
+                                       TerminalScreen *screen)
+{
+  if (response == GTK_RESPONSE_OK)
+    {
+      GtkEntry *entry;
+      const char *text;
+
+      entry = GTK_ENTRY (g_object_get_data (G_OBJECT (dialog), "title-entry"));
+      text = gtk_entry_get_text (entry);
+      terminal_screen_set_user_title (screen, text);
+    }
+
+  gtk_widget_destroy (dialog);
+}
+
+static void
+action_set_title_cb (GSimpleAction *action,
+                     GVariant *parameter,
+                     gpointer user_data)
+{
+  TerminalWindow *window = user_data;
+  TerminalWindowPrivate *priv = window->priv;
+  GtkWidget *dialog, *message_area, *hbox, *label, *entry;
+
+  if (priv->active_screen == NULL)
+    return;
+
+  /* FIXME: hook the screen up so this dialogue closes if the terminal screen closes */
+
+  dialog = gtk_message_dialog_new (GTK_WINDOW (window),
+                                   GTK_DIALOG_MODAL | GTK_DIALOG_DESTROY_WITH_PARENT,
+                                   GTK_MESSAGE_OTHER,
+                                   GTK_BUTTONS_OK_CANCEL,
+                                   "%s", "");
+
+  gtk_window_set_title (GTK_WINDOW (dialog), _("Set Title"));
+  gtk_window_set_resizable (GTK_WINDOW (dialog), FALSE);
+  gtk_window_set_role (GTK_WINDOW (dialog), "gnome-terminal-change-title");
+  gtk_dialog_set_default_response (GTK_DIALOG (dialog), GTK_RESPONSE_OK);
+  /* Alternative button order was set automatically by GtkMessageDialog */
+
+  g_signal_connect (dialog, "response",
+                    G_CALLBACK (terminal_set_title_dialog_response_cb), priv->active_screen);
+  g_signal_connect (dialog, "delete-event",
+                    G_CALLBACK (terminal_util_dialog_response_on_delete), NULL);
+
+  message_area = gtk_message_dialog_get_message_area (GTK_MESSAGE_DIALOG (dialog));
+  gtk_container_foreach (GTK_CONTAINER (message_area), (GtkCallback) gtk_widget_hide, NULL);
+
+  hbox = gtk_box_new (GTK_ORIENTATION_HORIZONTAL, 12);
+  gtk_box_pack_start (GTK_BOX (message_area), hbox, FALSE, FALSE, 0);
+
+  label = gtk_label_new_with_mnemonic (_("_Title:"));
+  gtk_misc_set_alignment (GTK_MISC (label), 0.0, 0.5);
+  gtk_box_pack_start (GTK_BOX (hbox), label, FALSE, FALSE, 0);
+
+  entry = gtk_entry_new ();
+  gtk_entry_set_width_chars (GTK_ENTRY (entry), 32);
+  gtk_entry_set_activates_default (GTK_ENTRY (entry), TRUE);
+  gtk_label_set_mnemonic_widget (GTK_LABEL (label), entry);
+  gtk_box_pack_start (GTK_BOX (hbox), entry, TRUE, TRUE, 0);
+  gtk_widget_show_all (hbox);
+
+  gtk_widget_grab_focus (entry);
+  gtk_entry_set_text (GTK_ENTRY (entry), terminal_screen_get_user_title (priv->active_screen));
+  gtk_editable_select_region (GTK_EDITABLE (entry), 0, -1);
+  g_object_set_data (G_OBJECT (dialog), "title-entry", entry);
+
+  gtk_window_present (GTK_WINDOW (dialog));
+}
+
 static void
 action_reset_cb (GSimpleAction *action,
                  GVariant *parameter,
@@ -2086,6 +2160,7 @@ terminal_window_init (TerminalWindow *window)
     { "paste-uris",          action_paste_uris_cb,       NULL,   NULL, NULL },
     { "reset",               action_reset_cb,            "b",    NULL, NULL },
     { "select-all",          action_select_all_cb,       NULL,   NULL, NULL },
+    { "set-title",           action_set_title_cb,        NULL,   NULL, NULL },
     { "size-to",             action_size_to_cb,          "(uu)", NULL, NULL },
     { "tab-detach",          action_tab_detach_cb,       NULL,   NULL, NULL },
     { "tab-move-left",       action_tab_move_left_cb,    NULL,   NULL, NULL },
-- 
2.25.4


From e5d3a23ff1f72a2fb2887abcbcb9a4d33dd4cdc3 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 30 Jun 2016 18:14:36 +0200
Subject: [PATCH 13/16] screen: Style fix

This brings the code in line with how it was before
de0dc7c2649c42e2aa02a66e4be27d262b34452d

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/terminal-screen.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 7724af0dfa04..3e93ab8ff7e5 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -833,7 +833,7 @@ terminal_screen_new (GSettings       *profile,
   /* If given an initial title, strip it of control characters and
    * feed it to the terminal.
    */
-  if (title != NULL) {
+  if (title) {
     GString *seq;
     const char *p;
 
-- 
2.25.4


From 4dbaed23edd26456c0509d4bc5424acbdb9140f9 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 30 Jun 2016 16:58:15 +0200
Subject: [PATCH 14/16] Restore the rest of the title handling options and make
 it all work

This reverts commit f27bf0135a2d18ba22158d28bf1f8c5f6ec066c8 and makes
it use the user_title API instead of sending an escape sequence.

https://bugzilla.redhat.com/show_bug.cgi?id=1296110
---
 src/org.gnome.Terminal.gschema.xml |  12 ++
 src/preferences.ui                 |  33 +++-
 src/profile-editor.c               |   9 +
 src/terminal-enums.h               |   8 +
 src/terminal-schemas.h             |   1 +
 src/terminal-screen.c              | 257 +++++++++++++++++++++--------
 src/terminal-screen.h              |   8 +-
 src/terminal-window.c              |   9 +-
 8 files changed, 263 insertions(+), 74 deletions(-)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index c649e988b5cf..53083a0e15d3 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -24,6 +24,13 @@
 -->
 <schemalist gettext-domain="gnome-terminal">
 
+  <enum id='org.gnome.Terminal.TitleMode'>
+    <value nick='replace' value='0'/>
+    <value nick='before' value='1'/>
+    <value nick='after' value='2'/>
+    <value nick='ignore' value='3'/>
+  </enum>
+
    <enum id='org.gnome.Terminal.NewTerminalMode'>
     <value nick='window' value='0'/>
     <value nick='tab' value='1'/>
@@ -209,6 +216,11 @@
       <summary>Whether to enable SIXEL images</summary>
       <description>If true, SIXEL sequences are parsed and images are rendered.</description>
     </key>
+    <key name="title-mode" enum="org.gnome.Terminal.TitleMode">
+      <default>'replace'</default>
+      <summary>What to do with dynamic title</summary>
+      <description>If the application in the terminal sets the title (most typically people have their shell set up to do this), the dynamically-set title can erase the configured title, go before it, go after it, or replace it. The possible values are "replace", "before", "after", and "ignore".</description>
+    </key>
     <key name="title" type="s">
       <default l10n="messages" context="title">'Terminal'</default>
       <summary>Title for terminal</summary>
diff --git a/src/preferences.ui b/src/preferences.ui
index f86f8c980f89..c45366ae52fc 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -2002,7 +2002,7 @@
                                             <property name="visible">True</property>
                                             <property name="can_focus">False</property>
                                             <property name="xalign">0</property>
-                                            <property name="label" translatable="yes">Title:</property>
+                                            <property name="label" translatable="yes">Initial _title:</property>
                                             <property name="use_underline">True</property>
                                             <property name="mnemonic_widget">title-entry</property>
                                           </object>
@@ -2022,6 +2022,37 @@
                                             <property name="left_attach">1</property>
                                           </packing>
                                         </child>
+                                        <child>
+                                          <object class="GtkLabel" id="title-mode-combobox-label">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="xalign">0</property>
+                                            <property name="label" translatable="yes">When terminal commands set their o_wn titles:</property>
+                                            <property name="use_underline">True</property>
+                                            <property name="mnemonic_widget">title-mode-combobox</property>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">1</property>
+                                            <property name="left_attach">0</property>
+                                          </packing>
+                                        </child>
+                                        <child>
+                                          <object class="GtkComboBox" id="title-mode-combobox">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="model">model2</property>
+                                            <child>
+                                              <object class="GtkCellRendererText"/>
+                                              <attributes>
+                                                <attribute name="text">0</attribute>
+                                              </attributes>
+                                            </child>
+                                          </object>
+                                          <packing>
+                                            <property name="top_attach">1</property>
+                                            <property name="left_attach">1</property>
+                                          </packing>
+                                        </child>
                                       </object>
                                     </child>
                                   </object>
diff --git a/src/profile-editor.c b/src/profile-editor.c
index df1f219608c4..1aa05fb33a92 100644
--- a/src/profile-editor.c
+++ b/src/profile-editor.c
@@ -1373,6 +1373,15 @@ profile_prefs_load (const char *uuid, GSettings *profile)
                                gtk_builder_get_object (builder, "title-entry"),
                                "text",
                                G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+  profile_prefs_settings_bind_with_mapping (profile,
+                                            TERMINAL_PROFILE_TITLE_MODE_KEY,
+                                            gtk_builder_get_object (builder,
+                                                                    "title-mode-combobox"),
+                                            "active",
+                                            G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET,
+                                            (GSettingsBindGetMapping) string_to_enum,
+                                            (GSettingsBindSetMapping) enum_to_string,
+                                            terminal_title_mode_get_type, NULL);
   profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_CUSTOM_COMMAND_KEY,
                                gtk_builder_get_object (builder,
                                                        "use-custom-command-checkbutton"),
diff --git a/src/terminal-enums.h b/src/terminal-enums.h
index 93f1460c2207..5e816f71c10e 100644
--- a/src/terminal-enums.h
+++ b/src/terminal-enums.h
@@ -34,6 +34,14 @@ typedef enum {
   TERMINAL_NEW_TAB_POSITION_NEXT
 } TerminalNewTabPosition;
 
+typedef enum
+{
+  TERMINAL_TITLE_REPLACE,
+  TERMINAL_TITLE_BEFORE,
+  TERMINAL_TITLE_AFTER,
+  TERMINAL_TITLE_IGNORE
+} TerminalTitleMode;
+
 typedef enum
 {
   TERMINAL_EXIT_CLOSE,
diff --git a/src/terminal-schemas.h b/src/terminal-schemas.h
index cbb59a2301e6..78e7a9a54b60 100644
--- a/src/terminal-schemas.h
+++ b/src/terminal-schemas.h
@@ -69,6 +69,7 @@ G_BEGIN_DECLS
 #define TERMINAL_PROFILE_SCROLL_ON_KEYSTROKE_KEY        "scroll-on-keystroke"
 #define TERMINAL_PROFILE_SCROLL_ON_OUTPUT_KEY           "scroll-on-output"
 #define TERMINAL_PROFILE_TEXT_BLINK_MODE_KEY            "text-blink-mode"
+#define TERMINAL_PROFILE_TITLE_MODE_KEY                 "title-mode"
 #define TERMINAL_PROFILE_TITLE_KEY                      "title"
 #define TERMINAL_PROFILE_USE_CUSTOM_COMMAND_KEY         "use-custom-command"
 #define TERMINAL_PROFILE_USE_SKEY_KEY                   "use-skey"
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 3e93ab8ff7e5..95ad21f6e867 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -110,8 +110,11 @@ struct _TerminalScreenPrivate
   ExecData *exec_data;
 
   gboolean between_preexec_and_precmd;
+  gboolean user_title; /* title was manually set */
   char *current_cmdline;
-  char *title;
+  char *raw_title;
+  char *cooked_title;
+  char *override_title;
   guint contents_changed_source_id;
   guint shell_preexec_source_id;
 };
@@ -128,8 +131,7 @@ enum
 enum {
   PROP_0,
   PROP_PROFILE,
-  PROP_TITLE,
-  PROP_DESCRIPTION
+  PROP_TITLE
 };
 
 enum
@@ -179,8 +181,13 @@ static void terminal_screen_window_title_changed      (VteTerminal *vte_terminal
 
 static void update_color_scheme                      (TerminalScreen *screen);
 
+static gboolean terminal_screen_format_title (TerminalScreen *screen, const char *raw_title, char **old_cooked_title);
+
+static void terminal_screen_cook_title      (TerminalScreen *screen);
+
 static char* terminal_screen_check_hyperlink   (TerminalScreen            *screen,
                                                 GdkEvent                  *event);
+
 static void terminal_screen_check_extra (TerminalScreen *screen,
                                          GdkEvent       *event,
                                          char           **number_info);
@@ -561,6 +568,9 @@ terminal_screen_init (TerminalScreen *screen)
   gtk_target_table_free (targets, n_targets);
   gtk_target_list_unref (target_list);
 
+  priv->override_title = NULL;
+  priv->user_title = FALSE;
+
   g_signal_connect (screen, "window-title-changed",
                     G_CALLBACK (terminal_screen_window_title_changed),
                     screen);
@@ -594,9 +604,6 @@ terminal_screen_get_property (GObject *object,
       case PROP_TITLE:
         g_value_set_string (value, terminal_screen_get_title (screen));
         break;
-      case PROP_DESCRIPTION:
-        g_value_take_string (value, terminal_screen_get_description (screen));
-        break;
       default:
         G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
         break;
@@ -617,7 +624,6 @@ terminal_screen_set_property (GObject *object,
         terminal_screen_set_profile (screen, g_value_get_object (value));
         break;
       case PROP_TITLE:
-      case PROP_DESCRIPTION:
         /* not writable */
       default:
         G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
@@ -707,13 +713,6 @@ terminal_screen_class_init (TerminalScreenClass *klass)
                           NULL,
                           G_PARAM_READABLE | G_PARAM_STATIC_NAME | G_PARAM_STATIC_NICK | G_PARAM_STATIC_BLURB));
 
-  g_object_class_install_property (object_class,
-                                   PROP_DESCRIPTION,
-                                   g_param_spec_string ("description", NULL, NULL,
-                                                        NULL,
-                                                        G_PARAM_READABLE |
-                                                        G_PARAM_STATIC_STRINGS));
-
   g_type_class_add_private (object_class, sizeof (TerminalScreenPrivate));
 
   n_url_regexes = G_N_ELEMENTS (url_regex_patterns);
@@ -810,7 +809,9 @@ terminal_screen_finalize (GObject *object)
 
   g_free (priv->uuid);
   g_free (priv->current_cmdline);
-  g_free (priv->title);
+  g_free (priv->raw_title);
+  g_free (priv->cooked_title);
+  g_free (priv->override_title);
 
   G_OBJECT_CLASS (terminal_screen_parent_class)->finalize (object);
 }
@@ -830,28 +831,8 @@ terminal_screen_new (GSettings       *profile,
                          g_settings_get_int (profile, TERMINAL_PROFILE_DEFAULT_SIZE_COLUMNS_KEY),
                          g_settings_get_int (profile, TERMINAL_PROFILE_DEFAULT_SIZE_ROWS_KEY));
 
-  /* If given an initial title, strip it of control characters and
-   * feed it to the terminal.
-   */
-  if (title) {
-    GString *seq;
-    const char *p;
-
-    seq = g_string_new ("\033]0;");
-    for (p = title; *p; p = g_utf8_next_char (p)) {
-      gunichar c = g_utf8_get_char (p);
-      if (c < 0x20 || (c >= 0x7f && c <= 0x9f))
-        continue;
-      else if (c == ';')
-        break;
-
-      g_string_append_unichar (seq, c);
-    }
-    g_string_append (seq, "\033\\");
-
-    vte_terminal_feed (VTE_TERMINAL (screen), seq->str, seq->len);
-    g_string_free (seq, TRUE);
-  }
+  if (title)
+    terminal_screen_set_override_title (screen, title);
 
   vte_terminal_set_font_scale (VTE_TERMINAL (screen), zoom);
   terminal_screen_set_font (screen);
@@ -1064,28 +1045,139 @@ terminal_screen_exec (TerminalScreen *screen,
   return TRUE;
 }
 
+const char*
+terminal_screen_get_raw_title (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+
+  if (priv->raw_title)
+    return priv->raw_title;
+
+  return "";
+}
+
 const char*
 terminal_screen_get_title (TerminalScreen *screen)
 {
-  return vte_terminal_get_window_title (VTE_TERMINAL (screen));
+  TerminalScreenPrivate *priv = screen->priv;
+
+  if (priv->cooked_title == NULL)
+    terminal_screen_cook_title (screen);
+
+  /* cooked_title may still be NULL */
+  if (priv->cooked_title != NULL)
+    return priv->cooked_title;
+  else
+    return "";
 }
 
-char *
-terminal_screen_get_description (TerminalScreen *screen)
+/* Supported format specifiers:
+ * %S = static title
+ * %D = dynamic title
+ * %A = dynamic title, falling back to static title if empty
+ * %- = separator, if not at start or end of string (excluding whitespace)
+ */
+static const char *
+terminal_screen_get_title_format (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  static const char *formats[] = {
+    "%A"      /* TERMINAL_TITLE_REPLACE */,
+    "%D%-%S"  /* TERMINAL_TITLE_BEFORE  */,
+    "%S%-%D"  /* TERMINAL_TITLE_AFTER   */,
+    "%S"      /* TERMINAL_TITLE_IGNORE  */
+  };
+
+  return formats[g_settings_get_enum (priv->profile, TERMINAL_PROFILE_TITLE_MODE_KEY)];
+}
+
+/**
+ * terminal_screen_format_title::
+ * @screen:
+ * @raw_title: main ingredient
+ * @titleptr <inout>: pointer of the current title string
+ *
+ * Format title according @format, and stores it in <literal>*titleptr</literal>.
+ * Always ensures that *titleptr will be non-NULL.
+ *
+ * Returns: %TRUE iff the title changed
+ */
+static gboolean
+terminal_screen_format_title (TerminalScreen *screen,
+                              const char *raw_title,
+                              char **titleptr)
 {
   TerminalScreenPrivate *priv = screen->priv;
-  gs_free char *title_string = NULL;
-  const char *title;
+  gs_free char *static_title_string = NULL;
+  const char *format, *arg;
+  const char *static_title = NULL;
+  GString *title;
+  gboolean add_sep = FALSE;
+
+  g_assert (titleptr);
 
   /* use --title argument if one was supplied, otherwise ask the profile */
-  if (priv->title)
-    title = priv->title;
+  if (priv->override_title)
+    static_title = priv->override_title;
   else
-    title = title_string = g_settings_get_string (priv->profile, TERMINAL_PROFILE_TITLE_KEY);
+    static_title = static_title_string = g_settings_get_string (priv->profile, TERMINAL_PROFILE_TITLE_KEY);
+
+  title = g_string_sized_new (128);
+
+  format = terminal_screen_get_title_format (screen);
+  for (arg = format; *arg; arg += 2)
+    {
+      const char *text_to_append = NULL;
+
+      g_assert (arg[0] == '%');
+
+      switch (arg[1])
+        {
+          case 'A':
+            text_to_append = raw_title ? raw_title : static_title;
+            break;
+          case 'D':
+            text_to_append = raw_title;
+            break;
+          case 'S':
+            text_to_append = static_title;
+            break;
+          case '-':
+            text_to_append = NULL;
+            add_sep = TRUE;
+            break;
+          default:
+            g_assert_not_reached ();
+        }
+
+      if (!text_to_append || !text_to_append[0])
+        continue;
+
+      if (add_sep && title->len > 0)
+        g_string_append (title, "  ");
+
+      g_string_append (title, text_to_append);
+      add_sep = FALSE;
+    }
 
-  return g_strdup_printf ("%s  %d",
-                          title && title[0] ? title : _("Terminal"),
-                          screen->priv->child_pid);
+  if (*titleptr == NULL || strcmp (title->str, *titleptr) != 0)
+    {
+      g_free (*titleptr);
+      *titleptr = g_string_free (title, FALSE);
+      return TRUE;
+    }
+
+  g_string_free (title, TRUE);
+  return FALSE;
+}
+
+static void
+terminal_screen_cook_title (TerminalScreen *screen)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+
+  if (terminal_screen_format_title (screen, priv->raw_title, &priv->cooked_title))
+    g_object_notify (G_OBJECT (screen), "title");
 }
 
 static void
@@ -1128,9 +1220,10 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
     }
 
   if (!prop_name ||
+      prop_name == I_(TERMINAL_PROFILE_TITLE_MODE_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_TITLE_KEY))
     {
-      g_object_notify (object, "description");
+      terminal_screen_cook_title (screen);
     }
 
   if (gtk_widget_get_realized (GTK_WIDGET (screen)) &&
@@ -1422,7 +1515,6 @@ terminal_screen_set_profile (TerminalScreen *screen,
     g_object_unref (old_profile);
 
   g_object_notify (G_OBJECT (screen), "profile");
-  g_object_notify (G_OBJECT (screen), "description");
 }
 
 GSettings*
@@ -1694,8 +1786,6 @@ spawn_result_cb (VteTerminal *terminal,
 
   priv->child_pid = pid;
 
-  g_object_notify (G_OBJECT (screen), "description");
-
   if (error) {
      // FIXMEchpe should be unnecessary, vte already does this internally
     vte_terminal_set_pty (terminal, NULL);
@@ -1980,33 +2070,45 @@ terminal_screen_focus_in (GtkWidget     *widget,
   return GTK_WIDGET_CLASS (terminal_screen_parent_class)->focus_in_event (widget, event);
 }
 
-void
-terminal_screen_set_user_title (TerminalScreen *screen,
-                                const char     *title)
+static void
+terminal_screen_set_dynamic_title (TerminalScreen *screen,
+                                   const char     *title,
+				   gboolean	  userset)
 {
   TerminalScreenPrivate *priv = screen->priv;
 
-  g_return_if_fail (TERMINAL_IS_SCREEN (screen));
+  g_assert (TERMINAL_IS_SCREEN (screen));
 
-  if (g_strcmp0 (priv->title, title) == 0)
+  if ((priv->user_title && !userset) ||
+      (priv->raw_title && title &&
+       strcmp (priv->raw_title, title) == 0))
     return;
 
-  g_free (priv->title);
-  priv->title = title && title[0] ? g_strdup (title) : NULL;
+  g_free (priv->raw_title);
+  priv->raw_title = g_strdup (title);
+  terminal_screen_cook_title (screen);
+}
 
-  g_object_notify (G_OBJECT (screen), "description");
+void
+terminal_screen_set_override_title (TerminalScreen *screen,
+                                    const char     *title)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+  char *old_title;
+
+  old_title = priv->override_title;
+  priv->override_title = g_strdup (title);
+  g_free (old_title);
+
+  terminal_screen_set_dynamic_title (screen, title, FALSE);
 }
 
 const char*
-terminal_screen_get_user_title (TerminalScreen *screen)
+terminal_screen_get_dynamic_title (TerminalScreen *screen)
 {
-  TerminalScreenPrivate *priv;
-
   g_return_val_if_fail (TERMINAL_IS_SCREEN (screen), NULL);
 
-  priv = screen->priv;
-
-  return priv->title ? priv->title : _("Terminal");
+  return screen->priv->raw_title;
 }
 
 /**
@@ -2039,7 +2141,9 @@ static void
 terminal_screen_window_title_changed (VteTerminal *vte_terminal,
                                       TerminalScreen *screen)
 {
-  g_object_notify (G_OBJECT (screen), "title");
+  terminal_screen_set_dynamic_title (screen,
+                                     vte_terminal_get_window_title (vte_terminal),
+				     FALSE);
 }
 
 static void
@@ -2062,8 +2166,6 @@ terminal_screen_child_exited (VteTerminal *terminal,
 
   priv->child_pid = -1;
 
-  g_object_notify (G_OBJECT (screen), "description");
-
   action = g_settings_get_enum (priv->profile, TERMINAL_PROFILE_EXIT_ACTION_KEY);
 
   switch (action)
@@ -2107,6 +2209,23 @@ terminal_screen_child_exited (VteTerminal *terminal,
     }
 }
 
+void
+terminal_screen_set_user_title (TerminalScreen *screen,
+                                const char *text)
+{
+  TerminalScreenPrivate *priv = screen->priv;
+
+  /* The user set the title to nothing, let's understand that as a
+     request to revert to dynamically setting the title again. */
+  if (!text || !text[0])
+    priv->user_title = FALSE;
+  else
+    {
+      priv->user_title = TRUE;
+      terminal_screen_set_dynamic_title (screen, text, TRUE);
+    }
+}
+
 static gboolean
 terminal_screen_contents_changed_cb (TerminalScreen *screen)
 {
diff --git a/src/terminal-screen.h b/src/terminal-screen.h
index 049bbe5a2b8b..5b7fcc59ddd0 100644
--- a/src/terminal-screen.h
+++ b/src/terminal-screen.h
@@ -113,13 +113,17 @@ void terminal_screen_set_profile (TerminalScreen *screen,
 GSettings* terminal_screen_get_profile (TerminalScreen *screen);
 GSettings* terminal_screen_ref_profile (TerminalScreen *screen);
 
-const char *terminal_screen_get_user_title     (TerminalScreen *screen);
+const char* terminal_screen_get_raw_title      (TerminalScreen *screen);
 const char* terminal_screen_get_title          (TerminalScreen *screen);
-char *      terminal_screen_get_description    (TerminalScreen *screen);
 
 void terminal_screen_set_user_title (TerminalScreen *screen,
                                      const char *text);
 
+void        terminal_screen_set_override_title     (TerminalScreen *screen,
+                                                    const char     *title);
+
+const char *terminal_screen_get_dynamic_title      (TerminalScreen *screen);
+
 char *terminal_screen_get_current_dir (TerminalScreen *screen);
 
 void       terminal_screen_get_size (TerminalScreen *screen,
diff --git a/src/terminal-window.c b/src/terminal-window.c
index 61c5e7de350a..0d61db3c125d 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -767,6 +767,12 @@ terminal_set_title_dialog_response_cb (GtkWidget *dialog,
   gtk_widget_destroy (dialog);
 }
 
+static const char *
+terminal_screen_get_user_title (TerminalScreen *screen)
+{
+  return terminal_screen_get_raw_title (screen);
+}
+
 static void
 action_set_title_cb (GSimpleAction *action,
                      GVariant *parameter,
@@ -2521,8 +2527,7 @@ sync_screen_title (TerminalScreen *screen,
     return;
 
   title = terminal_screen_get_title (screen);
-  gtk_window_set_title (GTK_WINDOW (window),
-                        title && title[0] ? title : _("Terminal"));
+  gtk_window_set_title (GTK_WINDOW (window), title);
 }
 
 static void
-- 
2.25.4


From a8afd6f8f6214a26f777c0412ce0d7cc3ebdea81 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Wed, 3 Apr 2019 15:38:09 +0200
Subject: [PATCH 15/16] Update the title with the current foreground process

Some changes by Bill Nottingham <notting@splat.cc>

https://bugzilla.gnome.org/show_bug.cgi?id=711060
---
 src/org.gnome.Terminal.gschema.xml |  5 ++++
 src/terminal-schemas.h             |  1 +
 src/terminal-screen.c              | 39 +++++++++++++++++++++++++++++-
 3 files changed, 44 insertions(+), 1 deletion(-)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index 53083a0e15d3..d7e12d831796 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -275,6 +275,11 @@
       <summary>Whether to scroll to the bottom when theres new output</summary>
       <description>If true, whenever theres new output the terminal will scroll to the bottom.</description>
     </key>
+    <key name="show-foreground-process-in-title" type="b">
+      <default>true</default>
+      <summary>Whether to show the current foreground process in the title</summary>
+      <description>If true, the current foreground process will be shown in the window and tab titles.</description>
+    </key>
     <key name="exit-action" enum="org.gnome.Terminal.ExitAction">
       <default>'close'</default>
       <summary>What to do with the terminal when the child command exits</summary>
diff --git a/src/terminal-schemas.h b/src/terminal-schemas.h
index 78e7a9a54b60..88dd11254c0d 100644
--- a/src/terminal-schemas.h
+++ b/src/terminal-schemas.h
@@ -68,6 +68,7 @@ G_BEGIN_DECLS
 #define TERMINAL_PROFILE_SCROLLBAR_POLICY_KEY           "scrollbar-policy"
 #define TERMINAL_PROFILE_SCROLL_ON_KEYSTROKE_KEY        "scroll-on-keystroke"
 #define TERMINAL_PROFILE_SCROLL_ON_OUTPUT_KEY           "scroll-on-output"
+#define TERMINAL_PROFILE_SHOW_FOREGROUND_PROCESS_IN_TITLE "show-foreground-process-in-title"
 #define TERMINAL_PROFILE_TEXT_BLINK_MODE_KEY            "text-blink-mode"
 #define TERMINAL_PROFILE_TITLE_MODE_KEY                 "title-mode"
 #define TERMINAL_PROFILE_TITLE_KEY                      "title"
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 95ad21f6e867..399dc889b96a 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -109,7 +109,9 @@ struct _TerminalScreenPrivate
   guint idle_exec_source;
   ExecData *exec_data;
 
+  gboolean application_title; /* title was set by an application */
   gboolean between_preexec_and_precmd;
+  gboolean show_foreground_process;
   gboolean user_title; /* title was manually set */
   char *current_cmdline;
   char *raw_title;
@@ -1160,6 +1162,20 @@ terminal_screen_format_title (TerminalScreen *screen,
       add_sep = FALSE;
     }
 
+  if (priv->show_foreground_process &&
+      !priv->application_title &&
+      !priv->user_title &&
+      priv->current_cmdline != NULL &&
+      priv->current_cmdline[0] != '\0')
+    {
+      gs_free char *current_cmdline_truncated = NULL;
+      gs_free char *current_cmdline_valid = NULL;
+
+      current_cmdline_valid = g_utf8_make_valid (priv->current_cmdline, -1);
+      current_cmdline_truncated = g_utf8_substring (current_cmdline_valid, 0, 1024);
+      g_string_append_printf (title, "  %s", current_cmdline_truncated);
+    }
+
   if (*titleptr == NULL || strcmp (title->str, *titleptr) != 0)
     {
       g_free (*titleptr);
@@ -1189,6 +1205,7 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
   GObject *object = G_OBJECT (screen);
   VteTerminal *vte_terminal = VTE_TERMINAL (screen);
   TerminalWindow *window;
+  gboolean cook_title = FALSE;
 
   g_object_freeze_notify (object);
 
@@ -1223,7 +1240,7 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       prop_name == I_(TERMINAL_PROFILE_TITLE_MODE_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_TITLE_KEY))
     {
-      terminal_screen_cook_title (screen);
+      cook_title = TRUE;
     }
 
   if (gtk_widget_get_realized (GTK_WIDGET (screen)) &&
@@ -1251,6 +1268,13 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       prop_name == I_(TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT))
     update_color_scheme (screen);
 
+  if (!prop_name || prop_name == I_(TERMINAL_PROFILE_SHOW_FOREGROUND_PROCESS_IN_TITLE))
+    {
+      priv->show_foreground_process = g_settings_get_boolean (profile,
+                                                              TERMINAL_PROFILE_SHOW_FOREGROUND_PROCESS_IN_TITLE);
+      cook_title = TRUE;
+    }
+
   if (!prop_name || prop_name == I_(TERMINAL_PROFILE_AUDIBLE_BELL_KEY))
       vte_terminal_set_audible_bell (vte_terminal, g_settings_get_boolean (profile, TERMINAL_PROFILE_AUDIBLE_BELL_KEY));
 
@@ -1315,6 +1339,9 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       vte_terminal_set_word_char_exceptions (vte_terminal, word_char_exceptions);
     }
 
+  if (cook_title)
+    terminal_screen_cook_title (screen);
+
   g_object_thaw_notify (object);
 }
 
@@ -2141,6 +2168,9 @@ static void
 terminal_screen_window_title_changed (VteTerminal *vte_terminal,
                                       TerminalScreen *screen)
 {
+  TerminalScreenPrivate *priv = screen->priv;
+
+  priv->application_title = priv->between_preexec_and_precmd;
   terminal_screen_set_dynamic_title (screen,
                                      vte_terminal_get_window_title (vte_terminal),
 				     FALSE);
@@ -2247,6 +2277,8 @@ terminal_screen_contents_changed_cb (TerminalScreen *screen)
   priv->current_cmdline = g_steal_pointer (&cmdline);
   _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: %s\n", priv->current_cmdline);
 
+  terminal_screen_cook_title (screen);
+
  out:
   priv->contents_changed_source_id = 0;
   return G_SOURCE_REMOVE;
@@ -2339,6 +2371,7 @@ terminal_screen_shell_precmd (VteTerminal *terminal)
 
   _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Shell precmd\n");
 
+  priv->application_title = FALSE;
   priv->between_preexec_and_precmd = FALSE;
 
   if (priv->contents_changed_source_id != 0)
@@ -2358,6 +2391,8 @@ terminal_screen_shell_precmd (VteTerminal *terminal)
 
   g_clear_pointer (&priv->current_cmdline, g_free);
   _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: (none)\n");
+
+  terminal_screen_cook_title (screen);
 }
 
 static gboolean
@@ -2378,6 +2413,8 @@ terminal_screen_shell_preexec_cb (TerminalScreen *screen)
   priv->current_cmdline = g_steal_pointer (&cmdline);
   _terminal_debug_print (TERMINAL_DEBUG_SHELL_COMMAND, "Current foreground command-line: %s\n", priv->current_cmdline);
 
+  terminal_screen_cook_title (screen);
+
   priv->shell_preexec_source_id = 0;
   retval = G_SOURCE_REMOVE;
 
-- 
2.25.4


From 6fcc54a2475fa4d248f6b78ead8625e2d3e1ae9d Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Thu, 27 Feb 2020 19:32:08 +0100
Subject: [PATCH 16/16] screen, window: Preserve current toolbox, if any

This relies on toolbox(1) emitting a terminal escape sequence that
advertises the name of the current toolbox container.

https://gitlab.freedesktop.org/terminal-wg/specifications/issues/17
---
 src/terminal-screen.c | 30 +++++++++++++++++++++++++++++-
 src/terminal-screen.h |  6 ++++++
 src/terminal-window.c | 26 ++++++++++++++++++++++++--
 3 files changed, 59 insertions(+), 3 deletions(-)

diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 399dc889b96a..db088f6f2695 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -877,6 +877,25 @@ terminal_screen_reexec_from_screen (TerminalScreen *screen,
                                     TerminalScreen *parent_screen,
                                     GCancellable *cancellable,
                                     GError **error)
+{
+  _terminal_debug_print (TERMINAL_DEBUG_PROCESSES,
+                         "[screen %p] reexec_from_screen: parent:%p\n",
+                         screen,
+                         parent_screen);
+
+  return terminal_screen_reexec_from_screen_with_override_command (screen,
+                                                                   parent_screen,
+                                                                   NULL,
+                                                                   cancellable,
+                                                                   error);
+}
+
+gboolean
+terminal_screen_reexec_from_screen_with_override_command (TerminalScreen *screen,
+                                                          TerminalScreen *parent_screen,
+                                                          char **override_command,
+                                                          GCancellable *cancellable,
+                                                          GError **error)
 {
   g_return_val_if_fail (TERMINAL_IS_SCREEN (screen), FALSE);
 
@@ -888,8 +907,17 @@ terminal_screen_reexec_from_screen (TerminalScreen *screen,
   terminal_unref_exec_data ExecData* data = exec_data_clone (parent_screen->priv->exec_data, FALSE);
   gs_free char* cwd = terminal_screen_get_current_dir (parent_screen);
 
+  if (override_command != NULL)
+    {
+      g_strfreev (data->argv);
+      data->argv = g_strdupv (override_command);
+
+      g_free (data->cwd);
+      data->cwd = g_strdup (cwd);
+    }
+
   _terminal_debug_print (TERMINAL_DEBUG_PROCESSES,
-                         "[screen %p] reexec_from_screen: parent:%p cwd:%s\n",
+                         "[screen %p] reexec_from_screen_with_override_command: parent:%p cwd:%s\n",
                          screen,
                          parent_screen,
                          cwd);
diff --git a/src/terminal-screen.h b/src/terminal-screen.h
index 5b7fcc59ddd0..5b1f983a7049 100644
--- a/src/terminal-screen.h
+++ b/src/terminal-screen.h
@@ -108,6 +108,12 @@ gboolean terminal_screen_reexec_from_screen (TerminalScreen *screen,
                                              GCancellable *cancellable,
                                              GError **error);
 
+gboolean terminal_screen_reexec_from_screen_with_override_command (TerminalScreen *screen,
+                                                                   TerminalScreen *parent_screen,
+                                                                   char **override_command,
+                                                                   GCancellable *cancellable,
+                                                                   GError **error);
+
 void terminal_screen_set_profile (TerminalScreen *screen,
                                   GSettings      *profile);
 GSettings* terminal_screen_get_profile (TerminalScreen *screen);
diff --git a/src/terminal-window.c b/src/terminal-window.c
index 0d61db3c125d..ad3a95af7008 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -405,8 +405,30 @@ action_new_terminal_cb (GSimpleAction *action,
   terminal_window_switch_screen (window, screen);
   gtk_widget_grab_focus (GTK_WIDGET (screen));
 
-  /* Start child process, if possible by using the same args as the parent screen */
-  terminal_screen_reexec_from_screen (screen, parent_screen, NULL, NULL);
+  const char *container_name = vte_terminal_get_current_container_name (VTE_TERMINAL (parent_screen));
+  const char *container_runtime = vte_terminal_get_current_container_runtime (VTE_TERMINAL (parent_screen));
+  if (g_strcmp0 (container_runtime, "toolbox") == 0 && container_name != NULL && container_name[0] != '\0')
+    {
+      gs_free_error GError *error = NULL;
+      gs_free char *override_command_str = NULL;
+      gs_strfreev char **override_command = NULL;
+
+      override_command_str = g_strdup_printf ("toolbox enter --container %s", container_name);
+      if (!g_shell_parse_argv (override_command_str, NULL, &override_command, &error))
+        g_printerr ("Failed to parse '%s': %s\n", override_command_str, error->message);
+
+      /* Start child process, if possible by using the same args as the parent screen */
+      terminal_screen_reexec_from_screen_with_override_command (screen,
+                                                                parent_screen,
+                                                                override_command,
+                                                                NULL,
+                                                                NULL);
+    }
+  else
+    {
+      /* Start child process, if possible by using the same args as the parent screen */
+      terminal_screen_reexec_from_screen (screen, parent_screen, NULL, NULL);
+    }
 
   if (mode == TERMINAL_NEW_TERMINAL_MODE_WINDOW)
     gtk_window_present (GTK_WINDOW (window));
-- 
2.25.4

