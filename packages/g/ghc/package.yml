# yaml-language-server: $schema=/usr/share/ypkg/schema/schema.json
name: ghc
version: 9.8.4
release: 16
source:
    - https://downloads.haskell.org/~ghc/9.8.4/ghc-9.8.4-src.tar.xz: 17e8188f3c8a5c2f73fb4e35d01032e8dc258835ec876d52c8ad8ee3d24b2fc5
    - https://downloads.haskell.org/~ghc/9.8.4/ghc-9.8.4-testsuite.tar.xz: 4be7906515fc3db6b7c4f85d6e29601accb9153801595fdef1e4ac500a3fd066
homepage: https://www.haskell.org/ghc/
license: BSD-3-Clause
component: programming.haskell
summary: The Glasgow Haskell Compiler
description: |
    The Glasgow Haskell Compiler
builddeps:
    - ghc
    - haskell-cabal-install
patterns: /*
networking: true
rundeps:
    - libffi-devel
    - ncurses-devel
environment: |
    unset LD_PRELOAD
    hadrian () {
        ./hadrian/build --docs=none --skip-perf %JOBS% $@
    }
setup: |
    tar xvf $sources/ghc-$version-testsuite.tar.xz  --strip 1

    %patch -p1 -i $pkgfiles/0001-fix-gcc15-c23-error.patch
    %patch -p1 -i $pkgfiles/0002-fix-unused-containers-include.patch

    cabal v2-update

    ./boot.source
    %configure --host=x86_64-unknown-linux \
               --target=x86_64-unknown-linux \
               --build=x86_64-unknown-linux \
               --with-system-libffi \
               --with-ffi-includes="$(pkg-config --variable=includedir libffi)"
build: |
    hadrian binary-dist-dir --docs=no-sphinx --docs=no-haddocks --flavour=perf --prefix=/usr
install: |
    pushd $workdir/_build/bindist/ghc-%version%-x86_64-unknown-linux/
        %configure --host=x86_64-unknown-linux \
                   --target=x86_64-unknown-linux \
                   --build=x86_64-unknown-linux \
                   --with-system-libffi \
                   --with-ffi-includes="$(pkg-config --variable=includedir libffi)"
        %make_install
    popd

    # This will be generated by usysconf
    rm $installdir/%libdir%/ghc-*/lib/package.conf.d/package.cache*

# Our LLVM is too new, needs LLVM 14
# check      : |
#     hadrian test --skip-perf --test-verbose=2
