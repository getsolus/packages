name       : ghc
version    : 9.4.8
release    : 15
source     :
    - https://downloads.haskell.org/~ghc/9.4.8/ghc-9.4.8-src.tar.xz : 0bf407eb67fe3e3c24b0f4c8dea8cb63e07f63ca0f76cf2058565143507ab85e
    - https://downloads.haskell.org/~ghc/9.4.8/ghc-9.4.8-testsuite.tar.xz : ac45dd44b097707a2717058ab2cfff22777ec0f31bfa3f54bf60e18b2dd63c95
homepage   : https://www.haskell.org/ghc/
license    : BSD-3-Clause
component  : programming.haskell
summary    : The Glasgow Haskell Compiler
description: |
    The Glasgow Haskell Compiler
builddeps  :
    - ghc
    - haskell-cabal-install
patterns   : /*
networking : true
rundeps    :
    - libffi-devel
    - ncurses-devel
environment: |
    unset LD_PRELOAD
    export BUILD_ROOT=~/.cache/hadrian
    hadrian () {
        ./hadrian/build --docs=none --skip-perf --build-root=$BUILD_ROOT %JOBS% $@
    }
setup      : |
    tar xvf $sources/ghc-$version-testsuite.tar.xz  --strip 1

    %patch -p1 -i $pkgfiles/0001-fix-gcc15-c23-error.patch

    cabal v2-update

    mkdir -p $BUILD_ROOT
    rm -f $BUILD_ROOT/hadrian.settings

    ./boot.source
    %configure --host=x86_64-unknown-linux \
               --target=x86_64-unknown-linux \
               --build=x86_64-unknown-linux \
               --with-system-libffi \
               --with-ffi-includes="$(pkg-config --variable=includedir libffi)"
build      : |
    hadrian binary-dist-dir --docs=no-sphinx --docs=no-haddocks --flavour=perf --prefix=/usr
install    : |
    pushd $BUILD_ROOT/bindist/ghc-%version%-x86_64-unknown-linux/
        %configure --host=x86_64-unknown-linux \
                   --target=x86_64-unknown-linux \
                   --build=x86_64-unknown-linux \
                   --with-system-libffi \
                   --with-ffi-includes="$(pkg-config --variable=includedir libffi)"
        %make_install
    popd

    # This will be generated by usysconf
    rm $installdir/%libdir%/ghc-*/lib/package.conf.d/package.cache*
# Our LLVM is too new, needs LLVM 14
# check      : |
#     hadrian test --skip-perf --test-verbose=2
